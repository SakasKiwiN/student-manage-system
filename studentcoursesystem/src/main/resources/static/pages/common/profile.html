<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¿¡æ¯ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ä¸ªäººä¸­å¿ƒ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">ä¸ªäººä¿¡æ¯</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">ä¸ªäººä¿¡æ¯</h1>
                <p class="page-description">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„ä¸ªäººèµ„æ–™</p>
            </div>

            <div class="row">
                <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header text-center">
                            <h5>åŸºæœ¬ä¿¡æ¯</h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="user-avatar-large mb-3" id="userAvatarLarge">
                                ğŸ‘¤
                            </div>
                            <h5 id="displayName">åŠ è½½ä¸­...</h5>
                            <p class="text-muted" id="displayRole">-</p>
                            <p class="text-muted" id="displayCollege">-</p>
                            <div class="mt-3">
                                <span class="badge bg-primary" id="accountStatus">æ­£å¸¸</span>
                            </div>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿç»Ÿè®¡ -->
                    <div class="card mt-3" id="quickStats">
                        <div class="card-header">
                            <h6>å¿«é€Ÿç»Ÿè®¡</h6>
                        </div>
                        <div class="card-body">
                            <div id="statsContent">
                                <!-- æ ¹æ®è§’è‰²åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯¦ç»†ä¿¡æ¯ -->
                <div class="col-md-8">
                    <!-- è´¦æˆ·ä¿¡æ¯ -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>è´¦æˆ·ä¿¡æ¯</h5>
                            <button class="btn btn-sm btn-primary" id="editAccountBtn">ç¼–è¾‘</button>
                        </div>
                        <div class="card-body">
                            <form id="accountForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">ç”¨æˆ·å</label>
                                            <input type="text" class="form-control" id="username" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">åˆ›å»ºæ—¶é—´</label>
                                            <input type="text" class="form-control" id="gmtCreate" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">è§’è‰²</label>
                                            <input type="text" class="form-control" id="userRole" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">æœ€åä¿®æ”¹</label>
                                            <input type="text" class="form-control" id="gmtModified" readonly>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ä¸ªäººè¯¦ç»†ä¿¡æ¯ -->
                    <div class="card mt-3" id="detailInfoCard">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 id="detailInfoTitle">è¯¦ç»†ä¿¡æ¯</h5>
                            <button class="btn btn-sm btn-primary" id="editDetailBtn">ç¼–è¾‘</button>
                        </div>
                        <div class="card-body">
                            <div id="detailInfoContent">
                                <!-- æ ¹æ®è§’è‰²åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <!-- å®‰å…¨è®¾ç½® -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>å®‰å…¨è®¾ç½®</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6>ç™»å½•å¯†ç </h6>
                                    <p class="text-muted mb-0">å®šæœŸæ›´æ¢å¯†ç æœ‰åŠ©äºä¿æŠ¤è´¦æˆ·å®‰å…¨</p>
                                </div>
                                <a href="/pages/common/change-password.html" class="btn btn-outline-primary">
                                    ä¿®æ”¹å¯†ç 
                                </a>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>æœ€åç™»å½•</h6>
                                    <p class="text-muted mb-0" id="lastLoginTime">-</p>
                                </div>
                                <span class="badge bg-success">å®‰å…¨</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- ç¼–è¾‘è¯¦ç»†ä¿¡æ¯æ¨¡æ€æ¡† -->
<div class="modal" id="editDetailModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h5 class="modal-title" id="editModalTitle">ç¼–è¾‘ä¿¡æ¯</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editDetailForm">
                <div id="editFormContent">
                    <!-- åŠ¨æ€ç”Ÿæˆç¼–è¾‘è¡¨å• -->
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="saveDetailBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentUser = null;
    let roleData = null;
    let isEditing = false;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        currentUser = event.detail.user;
        loadUserProfile();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        // è®¤è¯å·²åœ¨auth.jsä¸­å¤„ç†
    }

    // åŠ è½½ç”¨æˆ·èµ„æ–™
    async function loadUserProfile() {
        try {
            // æ˜¾ç¤ºåŸºæœ¬ç”¨æˆ·ä¿¡æ¯
            displayBasicInfo();

            // æ ¹æ®è§’è‰²åŠ è½½è¯¦ç»†ä¿¡æ¯
            await loadRoleSpecificData();

            // ç”Ÿæˆè¯¦ç»†ä¿¡æ¯è¡¨å•
            generateDetailInfo();

            // ç”Ÿæˆå¿«é€Ÿç»Ÿè®¡
            generateQuickStats();

        } catch (error) {
            console.error('Load user profile error:', error);
            Utils.showMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'danger');
        }
    }

    // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
    function displayBasicInfo() {
        if (!currentUser) return;

        const displayName = getRoleDisplayName();
        const roleName = AuthManager.getRoleDisplayName();
        const collegeName = getRoleCollegeName();
        const avatarText = displayName.charAt(0).toUpperCase();

        document.getElementById('userAvatarLarge').textContent = avatarText;
        document.getElementById('displayName').textContent = displayName;
        document.getElementById('displayRole').textContent = roleName;
        document.getElementById('displayCollege').textContent = collegeName || '-';

        // å¡«å……è´¦æˆ·ä¿¡æ¯
        document.getElementById('username').value = currentUser.username;
        document.getElementById('userRole').value = roleName;
        document.getElementById('gmtCreate').value = Utils.formatDate(currentUser.gmtCreate, 'YYYY-MM-DD HH:mm');
        document.getElementById('gmtModified').value = Utils.formatDate(currentUser.gmtModified, 'YYYY-MM-DD HH:mm');
    }

    // è·å–è§’è‰²æ˜¾ç¤ºåç§°
    function getRoleDisplayName() {
        if (currentUser.student) return currentUser.student.name;
        if (currentUser.teacher) return currentUser.teacher.name;
        return currentUser.username;
    }

    // è·å–è§’è‰²å­¦é™¢åç§°
    function getRoleCollegeName() {
        if (currentUser.student) return currentUser.student.college?.name;
        if (currentUser.teacher) return currentUser.teacher.college?.name;
        return null;
    }

    // åŠ è½½è§’è‰²ç‰¹å®šæ•°æ®
    async function loadRoleSpecificData() {
        try {
            if (AuthManager.isStudent()) {
                const response = await API.Student.getCurrent();
                if (response.code === 200) {
                    roleData = response.data;
                }
            } else if (AuthManager.isTeacher()) {
                const response = await API.Teacher.getCurrent();
                if (response.code === 200) {
                    roleData = response.data;
                }
            }
        } catch (error) {
            console.warn('Load role specific data error:', error);
        }
    }

    // ç”Ÿæˆè¯¦ç»†ä¿¡æ¯
    function generateDetailInfo() {
        const content = document.getElementById('detailInfoContent');
        const title = document.getElementById('detailInfoTitle');

        if (AuthManager.isStudent() && roleData) {
            title.textContent = 'å­¦ç”Ÿä¿¡æ¯';
            content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">å­¦å·</label>
                                <input type="text" class="form-control" value="${roleData.studentNo}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">å§“å</label>
                                <input type="text" class="form-control" value="${roleData.name}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">å¹´çº§</label>
                                <input type="text" class="form-control" value="${roleData.grade}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">ç­çº§</label>
                                <input type="text" class="form-control" value="${roleData.class}" readonly>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label">æ‰€å±å­¦é™¢</label>
                                <input type="text" class="form-control" value="${roleData.college?.name || ''}" readonly>
                            </div>
                        </div>
                    </div>
                `;
        } else if (AuthManager.isTeacher() && roleData) {
            title.textContent = 'æ•™å¸ˆä¿¡æ¯';
            content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">æ•™å¸ˆç¼–å·</label>
                                <input type="text" class="form-control" value="${roleData.teacherNo}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">å§“å</label>
                                <input type="text" class="form-control" value="${roleData.name}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">èŒç§°</label>
                                <input type="text" class="form-control" value="${roleData.title}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">æ‰€å±å­¦é™¢</label>
                                <input type="text" class="form-control" value="${roleData.college?.name || ''}" readonly>
                            </div>
                        </div>
                    </div>
                `;
        } else {
            title.textContent = 'ç”¨æˆ·ä¿¡æ¯';
            content.innerHTML = `
                    <div class="alert alert-info">
                        <p>æ‚¨æ˜¯${AuthManager.getRoleDisplayName()}ï¼Œæš‚æ— é¢å¤–çš„è¯¦ç»†ä¿¡æ¯éœ€è¦æ˜¾ç¤ºã€‚</p>
                    </div>
                `;
            document.getElementById('editDetailBtn').style.display = 'none';
        }
    }

    // ç”Ÿæˆå¿«é€Ÿç»Ÿè®¡
    async function generateQuickStats() {
        const content = document.getElementById('statsContent');

        try {
            if (AuthManager.isStudent()) {
                const response = await API.CourseSelection.getMySelections();
                if (response.code === 200) {
                    const selections = response.data || [];
                    const selected = selections.filter(s => s.status === 2 && s.lotteryResult === 1).length;
                    const pending = selections.filter(s => s.status === 1).length;

                    content.innerHTML = `
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="stat-value text-primary">${selected}</div>
                                    <div class="stat-label">å·²é€‰è¯¾ç¨‹</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-value text-warning">${pending}</div>
                                    <div class="stat-label">ç”³è¯·ä¸­</div>
                                </div>
                            </div>
                        `;
                }
            } else if (AuthManager.isTeacher() && roleData) {
                const response = await API.Course.getByTeacher(roleData.id);
                if (response.code === 200) {
                    const courses = response.data || [];
                    const activeCourses = courses.filter(c => c.status === 1).length;

                    content.innerHTML = `
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="stat-value text-primary">${courses.length}</div>
                                    <div class="stat-label">æ€»è¯¾ç¨‹</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-value text-success">${activeCourses}</div>
                                    <div class="stat-label">å¯ç”¨ä¸­</div>
                                </div>
                            </div>
                        `;
                }
            } else {
                content.innerHTML = `
                        <div class="text-center text-muted">
                            <p>æš‚æ— ç»Ÿè®¡ä¿¡æ¯</p>
                        </div>
                    `;
            }
        } catch (error) {
            console.warn('Generate quick stats error:', error);
            content.innerHTML = `
                    <div class="text-center text-muted">
                        <p>åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥</p>
                    </div>
                `;
        }
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // ç¼–è¾‘è¯¦ç»†ä¿¡æ¯
        document.getElementById('editDetailBtn').addEventListener('click', openEditModal);

        // ä¿å­˜è¯¦ç»†ä¿¡æ¯
        document.getElementById('saveDetailBtn').addEventListener('click', saveDetailInfo);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // è´¦æˆ·ç¼–è¾‘ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
        document.getElementById('editAccountBtn').addEventListener('click', function() {
            Utils.showMessage('è´¦æˆ·ä¿¡æ¯ç”±ç³»ç»Ÿç®¡ç†å‘˜ç®¡ç†ï¼Œå¦‚éœ€ä¿®æ”¹è¯·è”ç³»ç®¡ç†å‘˜', 'info');
        });
    }

    // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
    function openEditModal() {
        if (!roleData) return;

        let formContent = '';

        if (AuthManager.isStudent()) {
            formContent = `
                    <input type="hidden" id="editId" value="${roleData.id}">
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" class="form-control" id="editName" value="${roleData.name}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¹´çº§</label>
                        <input type="text" class="form-control" id="editGrade" value="${roleData.grade}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç­çº§</label>
                        <input type="text" class="form-control" id="editClass" value="${roleData.class}">
                    </div>
                `;
            document.getElementById('editModalTitle').textContent = 'ç¼–è¾‘å­¦ç”Ÿä¿¡æ¯';
        } else if (AuthManager.isTeacher()) {
            formContent = `
                    <input type="hidden" id="editId" value="${roleData.id}">
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" class="form-control" id="editName" value="${roleData.name}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">èŒç§°</label>
                        <input type="text" class="form-control" id="editTitle" value="${roleData.title}">
                    </div>
                `;
            document.getElementById('editModalTitle').textContent = 'ç¼–è¾‘æ•™å¸ˆä¿¡æ¯';
        }

        document.getElementById('editFormContent').innerHTML = formContent;
        Utils.showModal(document.getElementById('editDetailModal'));
    }

    // ä¿å­˜è¯¦ç»†ä¿¡æ¯
    async function saveDetailInfo() {
        const form = document.getElementById('editDetailForm');

        if (!Utils.validateForm(form)) {
            return;
        }

        try {
            const saveBtn = document.getElementById('saveDetailBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value.trim();

            let response;
            if (AuthManager.isStudent()) {
                const grade = document.getElementById('editGrade').value.trim();
                const studentClass = document.getElementById('editClass').value.trim();

                const updatedData = {
                    ...roleData,
                    name,
                    grade,
                    class: studentClass
                };

                response = await API.Student.update(id, updatedData);
            } else if (AuthManager.isTeacher()) {
                const title = document.getElementById('editTitle').value.trim();

                const updatedData = {
                    ...roleData,
                    name,
                    title
                };

                response = await API.Teacher.update(id, updatedData);
            }

            if (response && response.code === 200) {
                Utils.showMessage('ä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                closeModal();
                // é‡æ–°åŠ è½½æ•°æ®
                await loadRoleSpecificData();
                displayBasicInfo();
                generateDetailInfo();
            } else {
                Utils.showMessage('æ›´æ–°å¤±è´¥: ' + (response?.message || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        } catch (error) {
            console.error('Save detail info error:', error);
            Utils.showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
        } finally {
            const saveBtn = document.getElementById('saveDetailBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
        }
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        document.getElementById('editDetailForm').reset();
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.closeModal = closeModal;

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
            .user-avatar-large {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 32px;
                color: white;
                font-weight: 600;
                margin: 0 auto;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>