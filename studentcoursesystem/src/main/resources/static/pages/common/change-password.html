<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改密码 - 学生选课系统</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">☰</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">个人中心</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">修改密码</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">修改密码</h1>
                <p class="page-description">为了保护您的账户安全，请定期更换密码</p>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-6">
                    <!-- 安全提示 -->
                    <div class="alert alert-info">
                        <h6><strong>🔒 密码安全建议：</strong></h6>
                        <ul class="mb-0" style="margin-left: 20px;">
                            <li>密码长度至少6位字符</li>
                            <li>建议使用字母、数字的组合</li>
                            <li>避免使用生日、姓名等容易猜测的信息</li>
                            <li>定期更换密码，建议每3-6个月更换一次</li>
                            <li>不要在多个平台使用相同密码</li>
                        </ul>
                    </div>

                    <!-- 修改密码表单 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="me-2">🔑</span>
                                修改登录密码
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="changePasswordForm">
                                <div class="form-group">
                                    <label for="oldPassword" class="form-label">当前密码 *</label>
                                    <div class="input-group">
                                        <input type="password"
                                               class="form-control"
                                               id="oldPassword"
                                               name="oldPassword"
                                               required
                                               placeholder="请输入当前密码"
                                               autocomplete="current-password">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleOldPassword"
                                                onclick="togglePasswordVisibility('oldPassword', this)">
                                            👁️
                                        </button>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="form-group">
                                    <label for="newPassword" class="form-label">新密码 *</label>
                                    <div class="input-group">
                                        <input type="password"
                                               class="form-control"
                                               id="newPassword"
                                               name="newPassword"
                                               required
                                               placeholder="请输入新密码（至少6位）"
                                               autocomplete="new-password"
                                               minlength="6">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleNewPassword"
                                                onclick="togglePasswordVisibility('newPassword', this)">
                                            👁️
                                        </button>
                                    </div>
                                    <div class="password-strength" id="passwordStrength"></div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="form-group">
                                    <label for="confirmPassword" class="form-label">确认新密码 *</label>
                                    <div class="input-group">
                                        <input type="password"
                                               class="form-control"
                                               id="confirmPassword"
                                               name="confirmPassword"
                                               required
                                               placeholder="请再次输入新密码"
                                               autocomplete="new-password"
                                               minlength="6">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleConfirmPassword"
                                                onclick="togglePasswordVisibility('confirmPassword', this)">
                                            👁️
                                        </button>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="form-group text-center">
                                    <button type="submit"
                                            class="btn btn-primary btn-lg"
                                            id="submitBtn"
                                            style="width: 200px;">
                                        <span class="spinner" style="display: none;"></span>
                                        <span class="btn-text">修改密码</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 安全记录 -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <span class="me-2">📋</span>
                                安全记录
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="fw-bold">账户状态</div>
                                    <small class="text-muted">当前账户安全状态</small>
                                </div>
                                <span class="badge bg-success">安全</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="fw-bold">最后登录</div>
                                    <small class="text-muted" id="lastLoginInfo">获取中...</small>
                                </div>
                                <span class="text-success">✓</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">密码强度</div>
                                    <small class="text-muted">建议使用强密码</small>
                                </div>
                                <div class="password-strength-indicator" id="currentPasswordStrength">
                                    <span class="badge bg-warning">中等</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 返回链接 -->
                    <div class="text-center mt-4">
                        <a href="/pages/common/profile.html" class="btn btn-link">
                            ← 返回个人信息
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // 页面状态
    let currentUser = null;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // 监听用户认证事件
    window.addEventListener('userAuthenticated', function(event) {
        currentUser = event.detail.user;
        loadSecurityInfo();
        bindEvents();
    });

    // 初始化页面
    function initializePage() {
        // 认证已在auth.js中处理
    }

    // 加载安全信息
    function loadSecurityInfo() {
        if (!currentUser) return;

        // 显示最后登录信息（模拟）
        const lastLoginTime = new Date();
        lastLoginTime.setHours(lastLoginTime.getHours() - Math.floor(Math.random() * 24));

        document.getElementById('lastLoginInfo').textContent =
            Utils.formatDate(lastLoginTime, 'YYYY-MM-DD HH:mm') + ' (本次登录)';
    }

    // 绑定事件
    function bindEvents() {
        const form = document.getElementById('changePasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');

        // 表单提交
        form.addEventListener('submit', handleSubmit);

        // 新密码强度检测
        newPasswordInput.addEventListener('input', checkPasswordStrength);

        // 确认密码验证
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        // 侧边栏切换
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // 实时表单验证
        form.addEventListener('input', clearFormErrors);
    }

    // 处理表单提交
    async function handleSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const oldPassword = formData.get('oldPassword').trim();
        const newPassword = formData.get('newPassword').trim();
        const confirmPassword = formData.get('confirmPassword').trim();

        // 清除之前的错误
        clearFormErrors();

        // 表单验证
        if (!validateForm(oldPassword, newPassword, confirmPassword)) {
            return;
        }

        // 提交修改
        await submitPasswordChange(oldPassword, newPassword, confirmPassword);
    }

    // 表单验证
    function validateForm(oldPassword, newPassword, confirmPassword) {
        let isValid = true;

        // 检查原密码
        if (!oldPassword) {
            showFieldError('oldPassword', '请输入当前密码');
            isValid = false;
        }

        // 检查新密码
        if (!newPassword) {
            showFieldError('newPassword', '请输入新密码');
            isValid = false;
        } else if (newPassword.length < 6) {
            showFieldError('newPassword', '新密码至少需要6位字符');
            isValid = false;
        } else if (newPassword === oldPassword) {
            showFieldError('newPassword', '新密码不能与当前密码相同');
            isValid = false;
        }

        // 检查确认密码
        if (!confirmPassword) {
            showFieldError('confirmPassword', '请确认新密码');
            isValid = false;
        } else if (newPassword !== confirmPassword) {
            showFieldError('confirmPassword', '两次输入的密码不一致');
            isValid = false;
        }

        return isValid;
    }

    // 提交密码修改
    async function submitPasswordChange(oldPassword, newPassword, confirmPassword) {
        const submitBtn = document.getElementById('submitBtn');
        const spinner = submitBtn.querySelector('.spinner');
        const btnText = submitBtn.querySelector('.btn-text');

        try {
            // 显示加载状态
            submitBtn.disabled = true;
            spinner.style.display = 'inline-block';
            btnText.textContent = '修改中...';

            // 调用API
            const response = await API.Auth.changePassword(oldPassword, newPassword, confirmPassword);

            if (response.code === 200) {
                // 修改成功
                Utils.showMessage('密码修改成功！', 'success');

                // 清空表单
                document.getElementById('changePasswordForm').reset();

                // 显示成功提示
                showSuccessMessage();

            } else {
                // 修改失败
                Utils.showMessage(response.message || '密码修改失败', 'danger');

                if (response.message && response.message.includes('原密码')) {
                    showFieldError('oldPassword', response.message);
                }
            }

        } catch (error) {
            console.error('Change password error:', error);
            Utils.showMessage('密码修改失败：' + error.message, 'danger');
        } finally {
            // 恢复按钮状态
            submitBtn.disabled = false;
            spinner.style.display = 'none';
            btnText.textContent = '修改密码';
        }
    }

    // 检查密码强度
    function checkPasswordStrength() {
        const password = document.getElementById('newPassword').value;
        const strengthIndicator = document.getElementById('passwordStrength');

        if (!password) {
            strengthIndicator.innerHTML = '';
            return;
        }

        let strength = 0;
        let strengthText = '';
        let strengthClass = '';

        // 长度检查
        if (password.length >= 6) strength += 1;
        if (password.length >= 8) strength += 1;

        // 包含数字
        if (/\d/.test(password)) strength += 1;

        // 包含字母
        if (/[a-zA-Z]/.test(password)) strength += 1;

        // 包含特殊字符
        if (/[^a-zA-Z0-9]/.test(password)) strength += 1;

        // 大小写混合
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;

        // 确定强度等级
        if (strength <= 2) {
            strengthText = '弱';
            strengthClass = 'text-danger';
        } else if (strength <= 4) {
            strengthText = '中等';
            strengthClass = 'text-warning';
        } else {
            strengthText = '强';
            strengthClass = 'text-success';
        }

        strengthIndicator.innerHTML = `
                <small class="${strengthClass}">
                    密码强度：${strengthText}
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar bg-${strengthClass.split('-')[1]}"
                             style="width: ${(strength / 6) * 100}%"></div>
                    </div>
                </small>
            `;
    }

    // 验证密码匹配
    function validatePasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (confirmPassword && newPassword !== confirmPassword) {
            showFieldError('confirmPassword', '两次输入的密码不一致');
        } else {
            clearFieldError('confirmPassword');
        }
    }

    // 切换密码可见性
    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const isPassword = input.type === 'password';

        input.type = isPassword ? 'text' : 'password';
        button.textContent = isPassword ? '🙈' : '👁️';
    }

    // 显示字段错误
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const feedback = field.parentNode.parentNode.querySelector('.invalid-feedback');

        field.classList.add('is-invalid');
        if (feedback) {
            feedback.textContent = message;
        }
    }

    // 清除字段错误
    function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        const feedback = field.parentNode.parentNode.querySelector('.invalid-feedback');

        field.classList.remove('is-invalid');
        if (feedback) {
            feedback.textContent = '';
        }
    }

    // 清除所有表单错误
    function clearFormErrors() {
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => {
            field.classList.remove('is-invalid');
        });

        const feedbacks = document.querySelectorAll('.invalid-feedback');
        feedbacks.forEach(feedback => {
            feedback.textContent = '';
        });
    }

    // 显示成功消息
    function showSuccessMessage() {
        const form = document.getElementById('changePasswordForm');
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success mt-3';
        successDiv.innerHTML = `
                <h6><strong>✅ 密码修改成功！</strong></h6>
                <ul class="mb-0" style="margin-left: 20px;">
                    <li>您的密码已成功更新</li>
                    <li>请妥善保管新密码</li>
                    <li>下次登录时请使用新密码</li>
                </ul>
            `;

        form.parentNode.insertBefore(successDiv, form);

        // 5秒后自动移除成功消息
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 5000);
    }

    // 导出函数到全局作用域
    window.togglePasswordVisibility = togglePasswordVisibility;

    // 添加样式
    const style = document.createElement('style');
    style.textContent = `
            .input-group .btn {
                border-left: 0;
            }

            .password-strength {
                margin-top: 5px;
            }

            .progress {
                height: 4px;
            }

            .spinner {
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-top: 2px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 8px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .fw-bold {
                font-weight: 600;
            }

            .me-2 {
                margin-right: 0.5rem;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>