<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ”¹å¯†ç  - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ä¸ªäººä¸­å¿ƒ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">ä¿®æ”¹å¯†ç </span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">ä¿®æ”¹å¯†ç </h1>
                <p class="page-description">ä¸ºäº†ä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œè¯·å®šæœŸæ›´æ¢å¯†ç </p>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-6">
                    <!-- å®‰å…¨æç¤º -->
                    <div class="alert alert-info">
                        <h6><strong>ğŸ”’ å¯†ç å®‰å…¨å»ºè®®ï¼š</strong></h6>
                        <ul class="mb-0" style="margin-left: 20px;">
                            <li>å¯†ç é•¿åº¦è‡³å°‘6ä½å­—ç¬¦</li>
                            <li>å»ºè®®ä½¿ç”¨å­—æ¯ã€æ•°å­—çš„ç»„åˆ</li>
                            <li>é¿å…ä½¿ç”¨ç”Ÿæ—¥ã€å§“åç­‰å®¹æ˜“çŒœæµ‹çš„ä¿¡æ¯</li>
                            <li>å®šæœŸæ›´æ¢å¯†ç ï¼Œå»ºè®®æ¯3-6ä¸ªæœˆæ›´æ¢ä¸€æ¬¡</li>
                            <li>ä¸è¦åœ¨å¤šä¸ªå¹³å°ä½¿ç”¨ç›¸åŒå¯†ç </li>
                        </ul>
                    </div>

                    <!-- ä¿®æ”¹å¯†ç è¡¨å• -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="me-2">ğŸ”‘</span>
                                ä¿®æ”¹ç™»å½•å¯†ç 
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="changePasswordForm">
                                <div class="form-group">
                                    <label for="oldPassword" class="form-label">å½“å‰å¯†ç  *</label>
                                    <div class="input-group">
                                        <input type="password"
                                               class="form-control"
                                               id="oldPassword"
                                               name="oldPassword"
                                               required
                                               placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
                                               autocomplete="current-password">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleOldPassword"
                                                onclick="togglePasswordVisibility('oldPassword', this)">
                                            ğŸ‘ï¸
                                        </button>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="form-group">
                                    <label for="newPassword" class="form-label">æ–°å¯†ç  *</label>
                                    <div class="input-group">
                                        <input type="password"
                                               class="form-control"
                                               id="newPassword"
                                               name="newPassword"
                                               required
                                               placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
                                               autocomplete="new-password"
                                               minlength="6">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleNewPassword"
                                                onclick="togglePasswordVisibility('newPassword', this)">
                                            ğŸ‘ï¸
                                        </button>
                                    </div>
                                    <div class="password-strength" id="passwordStrength"></div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="form-group">
                                    <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç  *</label>
                                    <div class="input-group">
                                        <input type="password"
                                               class="form-control"
                                               id="confirmPassword"
                                               name="confirmPassword"
                                               required
                                               placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
                                               autocomplete="new-password"
                                               minlength="6">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleConfirmPassword"
                                                onclick="togglePasswordVisibility('confirmPassword', this)">
                                            ğŸ‘ï¸
                                        </button>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="form-group text-center">
                                    <button type="submit"
                                            class="btn btn-primary btn-lg"
                                            id="submitBtn"
                                            style="width: 200px;">
                                        <span class="spinner" style="display: none;"></span>
                                        <span class="btn-text">ä¿®æ”¹å¯†ç </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- å®‰å…¨è®°å½• -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <span class="me-2">ğŸ“‹</span>
                                å®‰å…¨è®°å½•
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="fw-bold">è´¦æˆ·çŠ¶æ€</div>
                                    <small class="text-muted">å½“å‰è´¦æˆ·å®‰å…¨çŠ¶æ€</small>
                                </div>
                                <span class="badge bg-success">å®‰å…¨</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="fw-bold">æœ€åç™»å½•</div>
                                    <small class="text-muted" id="lastLoginInfo">è·å–ä¸­...</small>
                                </div>
                                <span class="text-success">âœ“</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">å¯†ç å¼ºåº¦</div>
                                    <small class="text-muted">å»ºè®®ä½¿ç”¨å¼ºå¯†ç </small>
                                </div>
                                <div class="password-strength-indicator" id="currentPasswordStrength">
                                    <span class="badge bg-warning">ä¸­ç­‰</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¿”å›é“¾æ¥ -->
                    <div class="text-center mt-4">
                        <a href="/pages/common/profile.html" class="btn btn-link">
                            â† è¿”å›ä¸ªäººä¿¡æ¯
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentUser = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        currentUser = event.detail.user;
        loadSecurityInfo();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    function initializePage() {
        // è®¤è¯å·²åœ¨auth.jsä¸­å¤„ç†
    }

    // åŠ è½½å®‰å…¨ä¿¡æ¯
    function loadSecurityInfo() {
        if (!currentUser) return;

        // æ˜¾ç¤ºæœ€åç™»å½•ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
        const lastLoginTime = new Date();
        lastLoginTime.setHours(lastLoginTime.getHours() - Math.floor(Math.random() * 24));

        document.getElementById('lastLoginInfo').textContent =
            Utils.formatDate(lastLoginTime, 'YYYY-MM-DD HH:mm') + ' (æœ¬æ¬¡ç™»å½•)';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        const form = document.getElementById('changePasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');

        // è¡¨å•æäº¤
        form.addEventListener('submit', handleSubmit);

        // æ–°å¯†ç å¼ºåº¦æ£€æµ‹
        newPasswordInput.addEventListener('input', checkPasswordStrength);

        // ç¡®è®¤å¯†ç éªŒè¯
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // å®æ—¶è¡¨å•éªŒè¯
        form.addEventListener('input', clearFormErrors);
    }

    // å¤„ç†è¡¨å•æäº¤
    async function handleSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const oldPassword = formData.get('oldPassword').trim();
        const newPassword = formData.get('newPassword').trim();
        const confirmPassword = formData.get('confirmPassword').trim();

        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
        clearFormErrors();

        // è¡¨å•éªŒè¯
        if (!validateForm(oldPassword, newPassword, confirmPassword)) {
            return;
        }

        // æäº¤ä¿®æ”¹
        await submitPasswordChange(oldPassword, newPassword, confirmPassword);
    }

    // è¡¨å•éªŒè¯
    function validateForm(oldPassword, newPassword, confirmPassword) {
        let isValid = true;

        // æ£€æŸ¥åŸå¯†ç 
        if (!oldPassword) {
            showFieldError('oldPassword', 'è¯·è¾“å…¥å½“å‰å¯†ç ');
            isValid = false;
        }

        // æ£€æŸ¥æ–°å¯†ç 
        if (!newPassword) {
            showFieldError('newPassword', 'è¯·è¾“å…¥æ–°å¯†ç ');
            isValid = false;
        } else if (newPassword.length < 6) {
            showFieldError('newPassword', 'æ–°å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
            isValid = false;
        } else if (newPassword === oldPassword) {
            showFieldError('newPassword', 'æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ');
            isValid = false;
        }

        // æ£€æŸ¥ç¡®è®¤å¯†ç 
        if (!confirmPassword) {
            showFieldError('confirmPassword', 'è¯·ç¡®è®¤æ–°å¯†ç ');
            isValid = false;
        } else if (newPassword !== confirmPassword) {
            showFieldError('confirmPassword', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            isValid = false;
        }

        return isValid;
    }

    // æäº¤å¯†ç ä¿®æ”¹
    async function submitPasswordChange(oldPassword, newPassword, confirmPassword) {
        const submitBtn = document.getElementById('submitBtn');
        const spinner = submitBtn.querySelector('.spinner');
        const btnText = submitBtn.querySelector('.btn-text');

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.disabled = true;
            spinner.style.display = 'inline-block';
            btnText.textContent = 'ä¿®æ”¹ä¸­...';

            // è°ƒç”¨API
            const response = await API.Auth.changePassword(oldPassword, newPassword, confirmPassword);

            if (response.code === 200) {
                // ä¿®æ”¹æˆåŠŸ
                Utils.showMessage('å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('changePasswordForm').reset();

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showSuccessMessage();

            } else {
                // ä¿®æ”¹å¤±è´¥
                Utils.showMessage(response.message || 'å¯†ç ä¿®æ”¹å¤±è´¥', 'danger');

                if (response.message && response.message.includes('åŸå¯†ç ')) {
                    showFieldError('oldPassword', response.message);
                }
            }

        } catch (error) {
            console.error('Change password error:', error);
            Utils.showMessage('å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'danger');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            submitBtn.disabled = false;
            spinner.style.display = 'none';
            btnText.textContent = 'ä¿®æ”¹å¯†ç ';
        }
    }

    // æ£€æŸ¥å¯†ç å¼ºåº¦
    function checkPasswordStrength() {
        const password = document.getElementById('newPassword').value;
        const strengthIndicator = document.getElementById('passwordStrength');

        if (!password) {
            strengthIndicator.innerHTML = '';
            return;
        }

        let strength = 0;
        let strengthText = '';
        let strengthClass = '';

        // é•¿åº¦æ£€æŸ¥
        if (password.length >= 6) strength += 1;
        if (password.length >= 8) strength += 1;

        // åŒ…å«æ•°å­—
        if (/\d/.test(password)) strength += 1;

        // åŒ…å«å­—æ¯
        if (/[a-zA-Z]/.test(password)) strength += 1;

        // åŒ…å«ç‰¹æ®Šå­—ç¬¦
        if (/[^a-zA-Z0-9]/.test(password)) strength += 1;

        // å¤§å°å†™æ··åˆ
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;

        // ç¡®å®šå¼ºåº¦ç­‰çº§
        if (strength <= 2) {
            strengthText = 'å¼±';
            strengthClass = 'text-danger';
        } else if (strength <= 4) {
            strengthText = 'ä¸­ç­‰';
            strengthClass = 'text-warning';
        } else {
            strengthText = 'å¼º';
            strengthClass = 'text-success';
        }

        strengthIndicator.innerHTML = `
                <small class="${strengthClass}">
                    å¯†ç å¼ºåº¦ï¼š${strengthText}
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar bg-${strengthClass.split('-')[1]}"
                             style="width: ${(strength / 6) * 100}%"></div>
                    </div>
                </small>
            `;
    }

    // éªŒè¯å¯†ç åŒ¹é…
    function validatePasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (confirmPassword && newPassword !== confirmPassword) {
            showFieldError('confirmPassword', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        } else {
            clearFieldError('confirmPassword');
        }
    }

    // åˆ‡æ¢å¯†ç å¯è§æ€§
    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const isPassword = input.type === 'password';

        input.type = isPassword ? 'text' : 'password';
        button.textContent = isPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
    }

    // æ˜¾ç¤ºå­—æ®µé”™è¯¯
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const feedback = field.parentNode.parentNode.querySelector('.invalid-feedback');

        field.classList.add('is-invalid');
        if (feedback) {
            feedback.textContent = message;
        }
    }

    // æ¸…é™¤å­—æ®µé”™è¯¯
    function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        const feedback = field.parentNode.parentNode.querySelector('.invalid-feedback');

        field.classList.remove('is-invalid');
        if (feedback) {
            feedback.textContent = '';
        }
    }

    // æ¸…é™¤æ‰€æœ‰è¡¨å•é”™è¯¯
    function clearFormErrors() {
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => {
            field.classList.remove('is-invalid');
        });

        const feedbacks = document.querySelectorAll('.invalid-feedback');
        feedbacks.forEach(feedback => {
            feedback.textContent = '';
        });
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccessMessage() {
        const form = document.getElementById('changePasswordForm');
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success mt-3';
        successDiv.innerHTML = `
                <h6><strong>âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼</strong></h6>
                <ul class="mb-0" style="margin-left: 20px;">
                    <li>æ‚¨çš„å¯†ç å·²æˆåŠŸæ›´æ–°</li>
                    <li>è¯·å¦¥å–„ä¿ç®¡æ–°å¯†ç </li>
                    <li>ä¸‹æ¬¡ç™»å½•æ—¶è¯·ä½¿ç”¨æ–°å¯†ç </li>
                </ul>
            `;

        form.parentNode.insertBefore(successDiv, form);

        // 5ç§’åè‡ªåŠ¨ç§»é™¤æˆåŠŸæ¶ˆæ¯
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 5000);
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.togglePasswordVisibility = togglePasswordVisibility;

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
            .input-group .btn {
                border-left: 0;
            }

            .password-strength {
                margin-top: 5px;
            }

            .progress {
                height: 4px;
            }

            .spinner {
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-top: 2px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 8px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .fw-bold {
                font-weight: 600;
            }

            .me-2 {
                margin-right: 0.5rem;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>