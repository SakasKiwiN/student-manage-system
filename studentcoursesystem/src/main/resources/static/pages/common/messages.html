<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯ä¸­å¿ƒ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ä¸ªäººä¸­å¿ƒ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">æ¶ˆæ¯ä¸­å¿ƒ</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">æ¶ˆæ¯ä¸­å¿ƒ</h1>
                <p class="page-description">ç®¡ç†æ‚¨çš„æ¶ˆæ¯é€šçŸ¥å’Œæ²Ÿé€šè®°å½•</p>
            </div>

            <!-- æ¶ˆæ¯ç»Ÿè®¡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“§</div>
                    <div class="stat-value" id="totalMessages">0</div>
                    <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">ğŸ”´</div>
                    <div class="stat-value" id="unreadMessages">0</div>
                    <div class="stat-label">æœªè¯»æ¶ˆæ¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">ğŸ“¤</div>
                    <div class="stat-value" id="sentMessages">0</div>
                    <div class="stat-label">å·²å‘é€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">ğŸ“¥</div>
                    <div class="stat-value" id="receivedMessages">0</div>
                    <div class="stat-label">å·²æ¥æ”¶</div>
                </div>
            </div>

            <!-- æ“ä½œå·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary active" id="receivedBtn">
                                    æ”¶ä»¶ç®± (<span id="receivedCount">0</span>)
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="sentBtn">
                                    å‘ä»¶ç®± (<span id="sentCount">0</span>)
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="unreadBtn">
                                    æœªè¯» (<span id="unreadCount">0</span>)
                                </button>
                            </div>
                            <button class="btn btn-outline-success ml-3" id="markAllReadBtn" disabled>
                                å…¨éƒ¨æ ‡ä¸ºå·²è¯»
                            </button>
                        </div>
                        <button class="btn btn-success" id="composeBtn">
                            âœ‰ï¸ å‘é€æ¶ˆæ¯
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="listTitle">æ”¶ä»¶ç®±</h5>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-sm btn-outline-primary" id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="messagesContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“­</div>
                        <h5>æš‚æ— æ¶ˆæ¯</h5>
                        <p class="text-muted">æ‚¨çš„æ”¶ä»¶ç®±æ˜¯ç©ºçš„</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- å‘é€æ¶ˆæ¯æ¨¡æ€æ¡† -->
<div class="modal" id="composeModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h5 class="modal-title">å‘é€æ¶ˆæ¯</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="composeForm">
                <div class="form-group">
                    <label for="receiverSelect" class="form-label">æ¥æ”¶è€… *</label>
                    <select class="form-select" id="receiverSelect" name="receiverId" required>
                        <option value="">è¯·é€‰æ‹©æ¥æ”¶è€…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="courseSelect" class="form-label">ç›¸å…³è¯¾ç¨‹</label>
                    <select class="form-select" id="courseSelect" name="courseId">
                        <option value="">æ— å…³è”è¯¾ç¨‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="messageContent" class="form-label">æ¶ˆæ¯å†…å®¹ *</label>
                    <textarea class="form-control"
                              id="messageContent"
                              name="content"
                              rows="5"
                              required
                              placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..."
                              maxlength="1000"></textarea>
                    <small class="text-muted">æœ€å¤š1000ä¸ªå­—ç¬¦</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="sendMessageBtn">å‘é€</button>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="messageDetailModal">
    <div class="modal-dialog" style="max-width: 600px;">
        <div class="modal-header">
            <h5 class="modal-title">æ¶ˆæ¯è¯¦æƒ…</h5>
            <button type="button" class="modal-close" onclick="closeDetailModal()">&times;</button>
        </div>
        <div class="modal-body" id="messageDetailContent">
            <!-- åŠ¨æ€ç”Ÿæˆæ¶ˆæ¯è¯¦æƒ… -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button>
            <button type="button" class="btn btn-primary" id="replyBtn" style="display: none;">å›å¤</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentUser = null;
    let receivedMessages = [];
    let sentMessages = [];
    let unreadMessages = [];
    let currentView = 'received';
    let availableUsers = [];
    let availableCourses = [];
    let selectedMessage = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        currentUser = event.detail.user;
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    function initializePage() {
        // è®¤è¯å·²åœ¨auth.jsä¸­å¤„ç†
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            await Promise.all([
                loadMessages(),
                loadAvailableUsers(),
                loadAvailableCourses()
            ]);

            updateStatistics();
            renderMessageList();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æ¶ˆæ¯æ•°æ®
    async function loadMessages() {
        try {
            const [receivedResponse, sentResponse, unreadResponse] = await Promise.all([
                API.Message.getReceived(),
                API.Message.getSent(),
                API.Message.getUnread()
            ]);

            if (receivedResponse.code === 200) {
                receivedMessages = receivedResponse.data || [];
            }
            if (sentResponse.code === 200) {
                sentMessages = sentResponse.data || [];
            }
            if (unreadResponse.code === 200) {
                unreadMessages = unreadResponse.data || [];
            }
        } catch (error) {
            console.error('Load messages error:', error);
            throw error;
        }
    }

    // åŠ è½½å¯ç”¨ç”¨æˆ·åˆ—è¡¨
    async function loadAvailableUsers() {
        try {
            const role = AuthManager.getPrimaryRole();
            availableUsers = [];

            if (role === AuthManager.ROLES.STUDENT) {
                // å­¦ç”Ÿå¯ä»¥ç»™æ•™å¸ˆå‘æ¶ˆæ¯
                const response = await API.Teacher.getAll();
                if (response.code === 200) {
                    availableUsers = response.data.map(teacher => ({
                        id: teacher.user.id,
                        name: teacher.name,
                        type: 'æ•™å¸ˆ'
                    }));
                }
            } else if (role === AuthManager.ROLES.TEACHER) {
                // æ•™å¸ˆå¯ä»¥ç»™å­¦ç”Ÿå‘æ¶ˆæ¯
                const response = await API.Student.getAll();
                if (response.code === 200) {
                    availableUsers = response.data.map(student => ({
                        id: student.user.id,
                        name: student.name,
                        type: 'å­¦ç”Ÿ'
                    }));
                }
            } else if (role === AuthManager.ROLES.COLLEGE_ADMIN) {
                // å­¦é™¢ç®¡ç†å‘˜å¯ä»¥ç»™æœ¬å­¦é™¢æ•™å¸ˆå’Œå­¦ç”Ÿå‘æ¶ˆæ¯
                const [teacherResponse, studentResponse] = await Promise.all([
                    API.Teacher.getByCollege(AuthManager.getUserCollegeId()),
                    API.Student.getByCollege(AuthManager.getUserCollegeId())
                ]);

                if (teacherResponse.code === 200) {
                    availableUsers.push(...teacherResponse.data.map(teacher => ({
                        id: teacher.user.id,
                        name: teacher.name,
                        type: 'æ•™å¸ˆ'
                    })));
                }
                if (studentResponse.code === 200) {
                    availableUsers.push(...studentResponse.data.map(student => ({
                        id: student.user.id,
                        name: student.name,
                        type: 'å­¦ç”Ÿ'
                    })));
                }
            }
        } catch (error) {
            console.warn('Load available users error:', error);
        }
    }

    // åŠ è½½å¯ç”¨è¯¾ç¨‹åˆ—è¡¨
    async function loadAvailableCourses() {
        try {
            const role = AuthManager.getPrimaryRole();

            if (role === AuthManager.ROLES.STUDENT) {
                const response = await API.CourseSelection.getMySelections();
                if (response.code === 200) {
                    availableCourses = response.data
                        .filter(s => s.status === 2 && s.lotteryResult === 1)
                        .map(s => s.course);
                }
            } else if (role === AuthManager.ROLES.TEACHER) {
                const teacherResponse = await API.Teacher.getCurrent();
                if (teacherResponse.code === 200) {
                    const courseResponse = await API.Course.getByTeacher(teacherResponse.data.id);
                    if (courseResponse.code === 200) {
                        availableCourses = courseResponse.data;
                    }
                }
            }
        } catch (error) {
            console.warn('Load available courses error:', error);
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = receivedMessages.length + sentMessages.length;
        const unread = unreadMessages.length;

        document.getElementById('totalMessages').textContent = total;
        document.getElementById('unreadMessages').textContent = unread;
        document.getElementById('sentMessages').textContent = sentMessages.length;
        document.getElementById('receivedMessages').textContent = receivedMessages.length;

        document.getElementById('receivedCount').textContent = receivedMessages.length;
        document.getElementById('sentCount').textContent = sentMessages.length;
        document.getElementById('unreadCount').textContent = unread;

        // æ›´æ–°æ ‡è®°å·²è¯»æŒ‰é’®çŠ¶æ€
        document.getElementById('markAllReadBtn').disabled = unread === 0;
    }

    // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
    function renderMessageList() {
        const container = document.getElementById('messagesContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        let messages = [];
        let title = '';

        switch (currentView) {
            case 'received':
                messages = receivedMessages;
                title = 'æ”¶ä»¶ç®±';
                break;
            case 'sent':
                messages = sentMessages;
                title = 'å‘ä»¶ç®±';
                break;
            case 'unread':
                messages = unreadMessages;
                title = 'æœªè¯»æ¶ˆæ¯';
                break;
        }

        document.getElementById('listTitle').textContent = title;

        if (messages.length === 0) {
            showEmptyState();
            return;
        }

        let html = '<div class="message-list">';
        messages.forEach(message => {
            const isUnread = message.status === 1 && currentView !== 'sent';
            const otherUser = currentView === 'sent' ? message.receiver : message.sender;

            html += `
                    <div class="message-item ${isUnread ? 'unread' : ''}" data-message-id="${message.id}">
                        <div class="message-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="message-avatar">
                                        ${otherUser.username.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="message-info">
                                        <div class="message-user">
                                            ${getDisplayName(otherUser)}
                                            ${currentView === 'sent' ? '(æ”¶ä»¶äºº)' : '(å‘ä»¶äºº)'}
                                        </div>
                                        <div class="message-time">
                                            ${Utils.formatDate(message.gmtCreate, 'YYYY-MM-DD HH:mm')}
                                        </div>
                                    </div>
                                </div>
                                <div class="message-actions">
                                    ${isUnread ? '<span class="badge bg-danger">æœªè¯»</span>' : ''}
                                    ${message.course ? `<span class="badge bg-info">${message.course.name}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="message-content">
                            <p>${truncateText(message.content, 100)}</p>
                        </div>
                        <div class="message-footer">
                            <button class="btn btn-sm btn-outline-primary" onclick="showMessageDetail(${message.id})">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            ${currentView !== 'sent' && isUnread ?
                `<button class="btn btn-sm btn-outline-success ml-2" onclick="markAsRead(${message.id})">æ ‡è®°å·²è¯»</button>` : ''
            }
                        </div>
                    </div>
                `;
        });
        html += '</div>';

        container.innerHTML = html;

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        container.style.display = 'block';
    }

    // è·å–ç”¨æˆ·æ˜¾ç¤ºåç§°
    function getDisplayName(user) {
        // å°è¯•ä»ç”¨æˆ·å¯¹è±¡è·å–å®é™…å§“å
        if (user.student) return user.student.name;
        if (user.teacher) return user.teacher.name;
        return user.username;
    }

    // æˆªæ–­æ–‡æœ¬
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('messagesContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // è§†å›¾åˆ‡æ¢
        document.getElementById('receivedBtn').addEventListener('click', () => switchView('received'));
        document.getElementById('sentBtn').addEventListener('click', () => switchView('sent'));
        document.getElementById('unreadBtn').addEventListener('click', () => switchView('unread'));

        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refreshBtn').addEventListener('click', refreshMessages);

        // å…¨éƒ¨æ ‡ä¸ºå·²è¯»
        document.getElementById('markAllReadBtn').addEventListener('click', markAllAsRead);

        // å‘é€æ¶ˆæ¯
        document.getElementById('composeBtn').addEventListener('click', openComposeModal);
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);

        // å›å¤æŒ‰é’®
        document.getElementById('replyBtn').addEventListener('click', replyMessage);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // åˆ‡æ¢è§†å›¾
    function switchView(view) {
        currentView = view;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('btn-primary', 'active');
            btn.classList.add('btn-outline-primary');
        });

        if (view === 'received') {
            document.getElementById('receivedBtn').classList.remove('btn-outline-primary');
            document.getElementById('receivedBtn').classList.add('btn-primary', 'active');
        } else if (view === 'sent') {
            document.getElementById('sentBtn').classList.remove('btn-outline-primary');
            document.getElementById('sentBtn').classList.add('btn-primary', 'active');
        } else if (view === 'unread') {
            document.getElementById('unreadBtn').classList.remove('btn-outline-primary');
            document.getElementById('unreadBtn').classList.add('btn-primary', 'active');
        }

        renderMessageList();
    }

    // åˆ·æ–°æ¶ˆæ¯
    async function refreshMessages() {
        try {
            await loadMessages();
            updateStatistics();
            renderMessageList();
            Utils.showMessage('æ¶ˆæ¯å·²åˆ·æ–°', 'success');
        } catch (error) {
            console.error('Refresh messages error:', error);
            Utils.showMessage('åˆ·æ–°å¤±è´¥', 'danger');
        }
    }

    // å…¨éƒ¨æ ‡ä¸ºå·²è¯»
    async function markAllAsRead() {
        try {
            await API.Message.markAllAsRead();
            Utils.showMessage('æ‰€æœ‰æ¶ˆæ¯å·²æ ‡è®°ä¸ºå·²è¯»', 'success');
            await refreshMessages();
        } catch (error) {
            console.error('Mark all as read error:', error);
            Utils.showMessage('æ“ä½œå¤±è´¥', 'danger');
        }
    }

    // æ ‡è®°å•æ¡æ¶ˆæ¯ä¸ºå·²è¯»
    async function markAsRead(messageId) {
        try {
            await API.Message.markAsRead(messageId);
            await refreshMessages();
        } catch (error) {
            console.error('Mark as read error:', error);
            Utils.showMessage('æ ‡è®°å¤±è´¥', 'danger');
        }
    }

    // æ‰“å¼€å‘é€æ¶ˆæ¯æ¨¡æ€æ¡†
    function openComposeModal() {
        // å¡«å……æ¥æ”¶è€…é€‰é¡¹
        const receiverSelect = document.getElementById('receiverSelect');
        receiverSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¥æ”¶è€…</option>';

        availableUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name} (${user.type})`;
            receiverSelect.appendChild(option);
        });

        // å¡«å……è¯¾ç¨‹é€‰é¡¹
        const courseSelect = document.getElementById('courseSelect');
        courseSelect.innerHTML = '<option value="">æ— å…³è”è¯¾ç¨‹</option>';

        availableCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = course.name;
            courseSelect.appendChild(option);
        });

        Utils.showModal(document.getElementById('composeModal'));
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const form = document.getElementById('composeForm');

        if (!Utils.validateForm(form)) {
            return;
        }

        const formData = FormUtils.serialize(form);

        try {
            const sendBtn = document.getElementById('sendMessageBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';

            const response = await API.Message.send(
                parseInt(formData.receiverId),
                formData.content.trim(),
                formData.courseId ? parseInt(formData.courseId) : null
            );

            if (response.code === 200) {
                Utils.showMessage('æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                closeModal();
                await refreshMessages();
            } else {
                Utils.showMessage('å‘é€å¤±è´¥: ' + response.message, 'danger');
            }
        } catch (error) {
            console.error('Send message error:', error);
            Utils.showMessage('å‘é€å¤±è´¥: ' + error.message, 'danger');
        } finally {
            const sendBtn = document.getElementById('sendMessageBtn');
            sendBtn.disabled = false;
            sendBtn.textContent = 'å‘é€';
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯è¯¦æƒ…
    function showMessageDetail(messageId) {
        let message = null;

        // åœ¨æ‰€æœ‰æ¶ˆæ¯ä¸­æŸ¥æ‰¾
        message = [...receivedMessages, ...sentMessages].find(m => m.id === messageId);

        if (!message) return;

        selectedMessage = message;
        const isReceived = currentView !== 'sent';
        const otherUser = isReceived ? message.sender : message.receiver;

        document.getElementById('messageDetailContent').innerHTML = `
                <div class="message-detail">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>${isReceived ? 'å‘ä»¶äºº' : 'æ”¶ä»¶äºº'}ï¼š</strong>
                            ${getDisplayName(otherUser)}
                        </div>
                        <div class="col-md-6">
                            <strong>æ—¶é—´ï¼š</strong>
                            ${Utils.formatDate(message.gmtCreate, 'YYYY-MM-DD HH:mm:ss')}
                        </div>
                    </div>
                    ${message.course ? `
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>ç›¸å…³è¯¾ç¨‹ï¼š</strong>
                                <span class="badge bg-info">${message.course.name}</span>
                            </div>
                        </div>
                    ` : ''}
                    <div class="row">
                        <div class="col-12">
                            <strong>æ¶ˆæ¯å†…å®¹ï¼š</strong>
                            <div class="message-content-detail mt-2 p-3" style="background: #f8f9fa; border-radius: 4px;">
                                ${message.content}
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // æ˜¾ç¤ºå›å¤æŒ‰é’®ï¼ˆåªæœ‰æ”¶åˆ°çš„æ¶ˆæ¯æ‰èƒ½å›å¤ï¼‰
        const replyBtn = document.getElementById('replyBtn');
        if (isReceived) {
            replyBtn.style.display = 'inline-block';
        } else {
            replyBtn.style.display = 'none';
        }

        Utils.showModal(document.getElementById('messageDetailModal'));

        // å¦‚æœæ˜¯æœªè¯»æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºå·²è¯»
        if (message.status === 1 && isReceived) {
            markAsRead(messageId);
        }
    }

    // å›å¤æ¶ˆæ¯
    function replyMessage() {
        if (!selectedMessage) return;

        closeDetailModal();

        // æ‰“å¼€å‘é€æ¶ˆæ¯æ¨¡æ€æ¡†å¹¶é¢„å¡«ä¿¡æ¯
        openComposeModal();

        // è®¾ç½®æ¥æ”¶è€…
        document.getElementById('receiverSelect').value = selectedMessage.sender.id;

        // è®¾ç½®ç›¸å…³è¯¾ç¨‹
        if (selectedMessage.course) {
            document.getElementById('courseSelect').value = selectedMessage.course.id;
        }

        // é¢„å¡«å›å¤å†…å®¹
        const originalContent = selectedMessage.content.split('\n').map(line => '> ' + line).join('\n');
        document.getElementById('messageContent').value = `\n\n--- åŸå§‹æ¶ˆæ¯ ---\n${originalContent}`;

        // å°†å…‰æ ‡å®šä½åˆ°å¼€å¤´
        document.getElementById('messageContent').setSelectionRange(0, 0);
        document.getElementById('messageContent').focus();
    }

    // å…³é—­å‘é€æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        document.getElementById('composeForm').reset();
    }

    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
    function closeDetailModal() {
        Utils.closeModal();
        selectedMessage = null;
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.showMessageDetail = showMessageDetail;
    window.markAsRead = markAsRead;
    window.closeModal = closeModal;
    window.closeDetailModal = closeDetailModal;

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
            .message-item {
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                background: white;
                transition: all 0.3s ease;
            }

            .message-item:hover {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .message-item.unread {
                border-left: 4px solid #007bff;
                background: #f8f9ff;
            }

            .message-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                margin-right: 12px;
            }

            .message-user {
                font-weight: 600;
                color: #333;
            }

            .message-time {
                font-size: 12px;
                color: #666;
            }

            .message-content p {
                margin: 8px 0;
                color: #555;
                line-height: 1.5;
            }

            .message-footer {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #f0f0f0;
            }

            .btn-group .btn {
                border-radius: 0;
            }

            .btn-group .btn:first-child {
                border-top-left-radius: 4px;
                border-bottom-left-radius: 4px;
            }

            .btn-group .btn:last-child {
                border-top-right-radius: 4px;
                border-bottom-right-radius: 4px;
            }

            .message-content-detail {
                white-space: pre-wrap;
                word-wrap: break-word;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>