<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½ç­¾ç®¡ç† - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">å­¦é™¢ç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">æŠ½ç­¾ç®¡ç†</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">æŠ½ç­¾ç®¡ç†</h1>
                <p class="page-description">æ‰§è¡Œè¯¾ç¨‹é€‰è¯¾æŠ½ç­¾ï¼Œç®¡ç†é€‰è¯¾ç»“æœ</p>
            </div>

            <!-- æŠ½ç­¾çŠ¶æ€æ¦‚è§ˆ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“š</div>
                    <div class="stat-value" id="totalCourses">0</div>
                    <div class="stat-label">æ€»è¯¾ç¨‹æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">â³</div>
                    <div class="stat-value" id="pendingCourses">0</div>
                    <div class="stat-label">å¾…æŠ½ç­¾è¯¾ç¨‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="completedCourses">0</div>
                    <div class="stat-label">å·²å®ŒæˆæŠ½ç­¾</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">ğŸ‘¥</div>
                    <div class="stat-value" id="totalSelections">0</div>
                    <div class="stat-label">æ€»é€‰è¯¾ç”³è¯·</div>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="card">
                <div class="card-header">
                    <h5>æ‰¹é‡æŠ½ç­¾æ“ä½œ</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <h6><strong>âš ï¸ é‡è¦æé†’ï¼š</strong></h6>
                        <ul class="mb-0" style="margin-left: 20px;">
                            <li>æŠ½ç­¾æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·åœ¨ç¡®è®¤æ‰€æœ‰é€‰è¯¾ç”³è¯·å®Œæˆåæ‰§è¡Œ</li>
                            <li>æŠ½ç­¾å°†æ ¹æ®è¯¾ç¨‹æœ€å¤§äººæ•°éšæœºåˆ†é…åé¢</li>
                            <li>å»ºè®®å…ˆå¯¹å•ä¸ªè¯¾ç¨‹è¿›è¡Œæµ‹è¯•æŠ½ç­¾</li>
                            <li>æ‰¹é‡æŠ½ç­¾å°†å¯¹æœ¬å­¦é™¢æ‰€æœ‰å¾…æŠ½ç­¾è¯¾ç¨‹æ‰§è¡Œ</li>
                        </ul>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>å…¨å­¦é™¢æ‰¹é‡æŠ½ç­¾</h6>
                            <p class="text-muted mb-0">å¯¹æœ¬å­¦é™¢æ‰€æœ‰å¾…æŠ½ç­¾è¯¾ç¨‹æ‰§è¡Œæ‰¹é‡æŠ½ç­¾</p>
                        </div>
                        <button class="btn btn-danger btn-lg" id="batchLotteryBtn">
                            ğŸ² å¼€å§‹æ‰¹é‡æŠ½ç­¾
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¯¾ç¨‹æŠ½ç­¾åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>è¯¾ç¨‹æŠ½ç­¾çŠ¶æ€</h5>
                    <div>
                        <button class="btn btn-secondary" id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
                        <select class="form-select ml-2" id="statusFilter" style="width: 150px; display: inline-block;">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…æŠ½ç­¾</option>
                            <option value="completed">å·²å®Œæˆ</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="coursesContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ²</div>
                        <h5>æš‚æ— è¯¾ç¨‹æ•°æ®</h5>
                        <p class="text-muted">æœ¬å­¦é™¢è¿˜æ²¡æœ‰å¼€è®¾è¯¾ç¨‹</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- æŠ½ç­¾ç»“æœæ¨¡æ€æ¡† -->
<div class="modal" id="lotteryResultModal">
    <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-header">
            <h5 class="modal-title">æŠ½ç­¾ç»“æœ</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="lotteryResultContent">
            <!-- åŠ¨æ€ç”ŸæˆæŠ½ç­¾ç»“æœ -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
            <button type="button" class="btn btn-primary" id="exportResultBtn">å¯¼å‡ºç»“æœ</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentCollege = null;
    let courses = [];
    let filteredCourses = [];
    let courseSelections = {};
    let lotteryResults = {};

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isCollegeAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            const collegeId = AuthManager.getUserCollegeId();
            if (!collegeId) {
                Utils.showMessage('æ— æ³•è·å–å­¦é™¢ä¿¡æ¯', 'danger');
                return;
            }

            currentCollege = collegeId;

            await Promise.all([
                loadCourses(),
                loadSelectionStatistics()
            ]);

            renderCourseList();
            updateStatistics();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
    async function loadCourses() {
        try {
            const response = await API.Course.getByCollege(currentCollege);
            if (response.code === 200) {
                courses = response.data || [];
                filteredCourses = [...courses];

                // ä¸ºæ¯ä¸ªè¯¾ç¨‹åŠ è½½é€‰è¯¾æ•°æ®
                for (const course of courses) {
                    await loadCourseSelections(course.id);
                }
            }
        } catch (error) {
            console.error('Load courses error:', error);
            throw error;
        }
    }

    // åŠ è½½è¯¾ç¨‹é€‰è¯¾æ•°æ®
    async function loadCourseSelections(courseId) {
        try {
            const response = await API.CourseSelection.getCourseSelections(courseId);
            if (response.code === 200) {
                courseSelections[courseId] = response.data || [];
            }
        } catch (error) {
            console.warn(`Load selections for course ${courseId} error:`, error);
            courseSelections[courseId] = [];
        }
    }

    // åŠ è½½é€‰è¯¾ç»Ÿè®¡
    async function loadSelectionStatistics() {
        try {
            const response = await API.CourseSelection.getStatistics();
            if (response.code === 200) {
                // ç»Ÿè®¡æ•°æ®å·²åœ¨courseSelectionsä¸­
            }
        } catch (error) {
            console.warn('Load selection statistics error:', error);
        }
    }

    // æ¸²æŸ“è¯¾ç¨‹åˆ—è¡¨
    function renderCourseList() {
        const container = document.getElementById('coursesContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredCourses.length === 0) {
            showEmptyState();
            return;
        }

        let html = '<div class="row">';

        filteredCourses.forEach(course => {
            const selections = courseSelections[course.id] || [];
            const totalSelections = selections.length;
            const pendingCount = selections.filter(s => s.status === 1).length;
            const selectedCount = selections.filter(s => s.status === 2 && s.lotteryResult === 1).length;
            const rejectedCount = selections.filter(s => s.status === 2 && s.lotteryResult !== 1).length;

            const lotteryStatus = getLotteryStatus(course, selections);
            const canLottery = pendingCount > 0 && course.status === 1;

            html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 ${lotteryStatus.borderClass}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${course.name}</h6>
                                <span class="badge ${lotteryStatus.badgeClass}">${lotteryStatus.text}</span>
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col-3">
                                        <div class="stat-value text-primary">${totalSelections}</div>
                                        <div class="stat-label">ç”³è¯·äººæ•°</div>
                                    </div>
                                    <div class="col-3">
                                        <div class="stat-value text-warning">${pendingCount}</div>
                                        <div class="stat-label">å¾…æŠ½ç­¾</div>
                                    </div>
                                    <div class="col-3">
                                        <div class="stat-value text-success">${selectedCount}</div>
                                        <div class="stat-label">å·²ä¸­ç­¾</div>
                                    </div>
                                    <div class="col-3">
                                        <div class="stat-value text-danger">${rejectedCount}</div>
                                        <div class="stat-label">æœªä¸­ç­¾</div>
                                    </div>
                                </div>

                                <div class="course-info">
                                    <p class="mb-1"><strong>è¯¾ç¨‹ç¼–ç ï¼š</strong>${course.courseCode}</p>
                                    <p class="mb-1"><strong>æˆè¯¾æ•™å¸ˆï¼š</strong>${course.teacher?.name || 'æœªåˆ†é…'}</p>
                                    <p class="mb-1"><strong>æœ€å¤§äººæ•°ï¼š</strong>${course.maxStudents}</p>
                                    <p class="mb-3"><strong>è¶…é¢æƒ…å†µï¼š</strong>
                                        ${totalSelections > course.maxStudents ?
                `<span class="text-danger">è¶…é¢${totalSelections - course.maxStudents}äºº</span>` :
                `<span class="text-success">æœªè¶…é¢</span>`
            }
                                    </p>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-outline-info btn-sm" onclick="viewCourseDetail(${course.id})">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </button>
                                    ${canLottery ?
                `<button class="btn btn-primary btn-sm" onclick="performCourseLottery(${course.id})">
                                            ğŸ² æŠ½ç­¾
                                        </button>` :
                `<button class="btn btn-secondary btn-sm" disabled>
                                            ${pendingCount === 0 ? 'æ— å¾…æŠ½ç­¾' : 'å·²å®Œæˆ'}
                                        </button>`
            }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        });

        html += '</div>';
        container.innerHTML = html;

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        container.style.display = 'block';
    }

    // è·å–æŠ½ç­¾çŠ¶æ€
    function getLotteryStatus(course, selections) {
        const pendingCount = selections.filter(s => s.status === 1).length;
        const hasCompleted = selections.some(s => s.status === 2);

        if (course.status !== 1) {
            return { text: 'è¯¾ç¨‹åœç”¨', badgeClass: 'bg-secondary', borderClass: '' };
        } else if (pendingCount === 0 && !hasCompleted) {
            return { text: 'æ— é€‰è¯¾ç”³è¯·', badgeClass: 'bg-secondary', borderClass: '' };
        } else if (pendingCount > 0) {
            return { text: 'å¾…æŠ½ç­¾', badgeClass: 'bg-warning', borderClass: 'border-warning' };
        } else {
            return { text: 'å·²å®ŒæˆæŠ½ç­¾', badgeClass: 'bg-success', borderClass: 'border-success' };
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = courses.length;
        let pending = 0;
        let completed = 0;
        let totalSelections = 0;

        courses.forEach(course => {
            const selections = courseSelections[course.id] || [];
            const pendingCount = selections.filter(s => s.status === 1).length;
            const hasCompleted = selections.some(s => s.status === 2);

            totalSelections += selections.length;

            if (pendingCount > 0) {
                pending++;
            } else if (hasCompleted) {
                completed++;
            }
        });

        document.getElementById('totalCourses').textContent = total;
        document.getElementById('pendingCourses').textContent = pending;
        document.getElementById('completedCourses').textContent = completed;
        document.getElementById('totalSelections').textContent = totalSelections;
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('coursesContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æ‰¹é‡æŠ½ç­¾
        document.getElementById('batchLotteryBtn').addEventListener('click', performBatchLottery);

        // åˆ·æ–°
        document.getElementById('refreshBtn').addEventListener('click', refreshData);

        // çŠ¶æ€ç­›é€‰
        document.getElementById('statusFilter').addEventListener('change', filterByStatus);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œå•ä¸ªè¯¾ç¨‹æŠ½ç­¾
    async function performCourseLottery(courseId) {
        const course = courses.find(c => c.id === courseId);
        if (!course) return;

        const selections = courseSelections[courseId] || [];
        const pendingCount = selections.filter(s => s.status === 1).length;

        Utils.confirm(
            `ç¡®å®šå¯¹è¯¾ç¨‹"${course.name}"æ‰§è¡ŒæŠ½ç­¾å—ï¼Ÿ\n\n` +
            `ç”³è¯·äººæ•°ï¼š${selections.length}\n` +
            `æœ€å¤§äººæ•°ï¼š${course.maxStudents}\n` +
            `å¾…æŠ½ç­¾äººæ•°ï¼š${pendingCount}\n\n` +
            `âš ï¸ æŠ½ç­¾æ“ä½œä¸å¯æ’¤é”€ï¼`,
            async () => {
                try {
                    Utils.showMessage('æ­£åœ¨æ‰§è¡ŒæŠ½ç­¾...', 'info');

                    const response = await API.CourseSelection.performLottery(courseId);
                    if (response.code === 200) {
                        Utils.showMessage('æŠ½ç­¾å®Œæˆï¼', 'success');
                        await refreshData();

                        // æ˜¾ç¤ºæŠ½ç­¾ç»“æœ
                        await showLotteryResult(courseId);
                    } else {
                        Utils.showMessage('æŠ½ç­¾å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Lottery error:', error);
                    Utils.showMessage('æŠ½ç­¾å¤±è´¥: ' + error.message, 'danger');
                }
            }
        );
    }

    // æ‰§è¡Œæ‰¹é‡æŠ½ç­¾
    async function performBatchLottery() {
        const pendingCourses = courses.filter(course => {
            const selections = courseSelections[course.id] || [];
            const pendingCount = selections.filter(s => s.status === 1).length;
            return pendingCount > 0 && course.status === 1;
        });

        if (pendingCourses.length === 0) {
            Utils.showMessage('æ²¡æœ‰éœ€è¦æŠ½ç­¾çš„è¯¾ç¨‹', 'warning');
            return;
        }

        Utils.confirm(
            `ç¡®å®šå¯¹æœ¬å­¦é™¢æ‰€æœ‰è¯¾ç¨‹æ‰§è¡Œæ‰¹é‡æŠ½ç­¾å—ï¼Ÿ\n\n` +
            `å¾…æŠ½ç­¾è¯¾ç¨‹æ•°ï¼š${pendingCourses.length}\n` +
            `è¯¾ç¨‹åˆ—è¡¨ï¼š${pendingCourses.map(c => c.name).join('ã€')}\n\n` +
            `âš ï¸ æ‰¹é‡æŠ½ç­¾æ“ä½œä¸å¯æ’¤é”€ï¼`,
            async () => {
                try {
                    const batchBtn = document.getElementById('batchLotteryBtn');
                    batchBtn.disabled = true;
                    batchBtn.textContent = 'æŠ½ç­¾ä¸­...';

                    Utils.showMessage('æ­£åœ¨æ‰§è¡Œæ‰¹é‡æŠ½ç­¾...', 'info');

                    const response = await API.CourseSelection.performCollegeLottery(currentCollege);
                    if (response.code === 200) {
                        Utils.showMessage('æ‰¹é‡æŠ½ç­¾å®Œæˆï¼', 'success');
                        await refreshData();
                    } else {
                        Utils.showMessage('æ‰¹é‡æŠ½ç­¾å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Batch lottery error:', error);
                    Utils.showMessage('æ‰¹é‡æŠ½ç­¾å¤±è´¥: ' + error.message, 'danger');
                } finally {
                    const batchBtn = document.getElementById('batchLotteryBtn');
                    batchBtn.disabled = false;
                    batchBtn.textContent = 'ğŸ² å¼€å§‹æ‰¹é‡æŠ½ç­¾';
                }
            }
        );
    }

    // æŸ¥çœ‹è¯¾ç¨‹è¯¦æƒ…
    function viewCourseDetail(courseId) {
        const course = courses.find(c => c.id === courseId);
        const selections = courseSelections[courseId] || [];

        if (!course) return;

        const selectedStudents = selections.filter(s => s.status === 2 && s.lotteryResult === 1);
        const rejectedStudents = selections.filter(s => s.status === 2 && s.lotteryResult !== 1);
        const pendingStudents = selections.filter(s => s.status === 1);

        const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>è¯¾ç¨‹ä¿¡æ¯</h6>
                        <p><strong>è¯¾ç¨‹åç§°ï¼š</strong>${course.name}</p>
                        <p><strong>è¯¾ç¨‹ç¼–ç ï¼š</strong>${course.courseCode}</p>
                        <p><strong>æˆè¯¾æ•™å¸ˆï¼š</strong>${course.teacher?.name || 'æœªåˆ†é…'}</p>
                        <p><strong>æœ€å¤§äººæ•°ï¼š</strong>${course.maxStudents}</p>
                        <p><strong>å­¦åˆ†ï¼š</strong>${course.credits}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>é€‰è¯¾ç»Ÿè®¡</h6>
                        <p><strong>æ€»ç”³è¯·äººæ•°ï¼š</strong>${selections.length}</p>
                        <p><strong>å·²ä¸­ç­¾ï¼š</strong><span class="text-success">${selectedStudents.length}</span></p>
                        <p><strong>æœªä¸­ç­¾ï¼š</strong><span class="text-danger">${rejectedStudents.length}</span></p>
                        <p><strong>å¾…æŠ½ç­¾ï¼š</strong><span class="text-warning">${pendingStudents.length}</span></p>
                        <p><strong>ä¸­ç­¾ç‡ï¼š</strong>${selections.length > 0 ? ((selectedStudents.length / selections.length) * 100).toFixed(1) : 0}%</p>
                    </div>
                </div>

                ${selectedStudents.length > 0 ? `
                <div class="mt-3">
                    <h6>ä¸­ç­¾å­¦ç”Ÿåå•</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr><th>å­¦å·</th><th>å§“å</th><th>å¹´çº§</th><th>ç­çº§</th></tr>
                            </thead>
                            <tbody>
                                ${selectedStudents.map(s => `
                                    <tr>
                                        <td>${s.student.studentNo}</td>
                                        <td>${s.student.name}</td>
                                        <td>${s.student.grade}</td>
                                        <td>${s.student.class}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>` : ''}
            `;

        const modal = Utils.createModal(`${course.name} - è¯¦ç»†ä¿¡æ¯`, content, [
            { text: 'å…³é—­', class: 'btn-secondary', onclick: 'Utils.closeModal()' }
        ]);
        Utils.showModal(modal);
    }

    // æ˜¾ç¤ºæŠ½ç­¾ç»“æœ
    async function showLotteryResult(courseId) {
        try {
            // é‡æ–°åŠ è½½æœ€æ–°çš„é€‰è¯¾æ•°æ®
            await loadCourseSelections(courseId);

            const course = courses.find(c => c.id === courseId);
            const selections = courseSelections[courseId] || [];
            const selectedStudents = selections.filter(s => s.status === 2 && s.lotteryResult === 1);
            const rejectedStudents = selections.filter(s => s.status === 2 && s.lotteryResult !== 1);

            lotteryResults[courseId] = { course, selectedStudents, rejectedStudents };

            const content = `
                    <div class="text-center mb-4">
                        <h4>ğŸ‰ ${course.name} æŠ½ç­¾ç»“æœ</h4>
                        <p class="text-muted">æŠ½ç­¾å·²å®Œæˆï¼Œä»¥ä¸‹æ˜¯æœ€ç»ˆç»“æœ</p>
                    </div>

                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <div class="stat-value text-success">${selectedStudents.length}</div>
                            <div class="stat-label">ä¸­ç­¾äººæ•°</div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-value text-danger">${rejectedStudents.length}</div>
                            <div class="stat-label">æœªä¸­ç­¾äººæ•°</div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-value text-info">${((selectedStudents.length / (selectedStudents.length + rejectedStudents.length)) * 100).toFixed(1)}%</div>
                            <div class="stat-label">ä¸­ç­¾ç‡</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">âœ… ä¸­ç­¾å­¦ç”Ÿ</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr><th>å­¦å·</th><th>å§“å</th><th>ç­çº§</th></tr>
                                    </thead>
                                    <tbody>
                                        ${selectedStudents.map(s => `
                                            <tr>
                                                <td>${s.student.studentNo}</td>
                                                <td>${s.student.name}</td>
                                                <td>${s.student.class}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">âŒ æœªä¸­ç­¾å­¦ç”Ÿ</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr><th>å­¦å·</th><th>å§“å</th><th>ç­çº§</th></tr>
                                    </thead>
                                    <tbody>
                                        ${rejectedStudents.map(s => `
                                            <tr>
                                                <td>${s.student.studentNo}</td>
                                                <td>${s.student.name}</td>
                                                <td>${s.student.class}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

            document.getElementById('lotteryResultContent').innerHTML = content;
            Utils.showModal(document.getElementById('lotteryResultModal'));
        } catch (error) {
            console.error('Show lottery result error:', error);
        }
    }

    // çŠ¶æ€ç­›é€‰
    function filterByStatus() {
        const status = document.getElementById('statusFilter').value;

        if (!status) {
            filteredCourses = [...courses];
        } else {
            filteredCourses = courses.filter(course => {
                const selections = courseSelections[course.id] || [];
                const pendingCount = selections.filter(s => s.status === 1).length;
                const hasCompleted = selections.some(s => s.status === 2);

                if (status === 'pending') {
                    return pendingCount > 0 && course.status === 1;
                } else if (status === 'completed') {
                    return hasCompleted && pendingCount === 0;
                }
                return true;
            });
        }

        renderCourseList();
    }

    // åˆ·æ–°æ•°æ®
    async function refreshData() {
        try {
            Utils.showMessage('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
            await loadPageData();
            Utils.showMessage('æ•°æ®åˆ·æ–°å®Œæˆ', 'success');
        } catch (error) {
            console.error('Refresh data error:', error);
            Utils.showMessage('åˆ·æ–°å¤±è´¥', 'danger');
        }
    }

    // å¯¼å‡ºæŠ½ç­¾ç»“æœ
    function exportLotteryResult() {
        const results = Object.values(lotteryResults);
        if (results.length === 0) {
            Utils.showMessage('æ²¡æœ‰æŠ½ç­¾ç»“æœå¯å¯¼å‡º', 'warning');
            return;
        }

        let csvContent = 'è¯¾ç¨‹ç¼–ç ,è¯¾ç¨‹åç§°,å­¦å·,å§“å,å¹´çº§,ç­çº§,æŠ½ç­¾ç»“æœ\n';

        results.forEach(result => {
            const { course, selectedStudents, rejectedStudents } = result;

            selectedStudents.forEach(s => {
                csvContent += `${course.courseCode},${course.name},${s.student.studentNo},${s.student.name},${s.student.grade},${s.student.class},ä¸­ç­¾\n`;
            });

            rejectedStudents.forEach(s => {
                csvContent += `${course.courseCode},${course.name},${s.student.studentNo},${s.student.name},${s.student.grade},${s.student.class},æœªä¸­ç­¾\n`;
            });
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `æŠ½ç­¾ç»“æœ_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('æŠ½ç­¾ç»“æœå¯¼å‡ºæˆåŠŸ', 'success');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
    }

    // ç»‘å®šå¯¼å‡ºæŒ‰é’®äº‹ä»¶
    document.getElementById('exportResultBtn').addEventListener('click', exportLotteryResult);

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.viewCourseDetail = viewCourseDetail;
    window.performCourseLottery = performCourseLottery;
    window.closeModal = closeModal;
</script>
</body>
</html>