<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹ç®¡ç† - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">å­¦é™¢ç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">è¯¾ç¨‹ç®¡ç†</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">è¯¾ç¨‹ç®¡ç†</h1>
                <p class="page-description">ç®¡ç†å­¦é™¢å¼€è®¾çš„æ‰€æœ‰è¯¾ç¨‹</p>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“š</div>
                    <div class="stat-value" id="totalCourses">-</div>
                    <div class="stat-label">æ€»è¯¾ç¨‹æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="activeCourses">-</div>
                    <div class="stat-label">å¯ç”¨è¯¾ç¨‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">ğŸ‘¥</div>
                    <div class="stat-value" id="totalSelections">-</div>
                    <div class="stat-label">æ€»é€‰è¯¾æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">â³</div>
                    <div class="stat-value" id="pendingLottery">-</div>
                    <div class="stat-label">å¾…æŠ½ç­¾</div>
                </div>
            </div>

            <!-- æ“ä½œå·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text"
                                   class="form-control"
                                   id="searchInput"
                                   placeholder="æœç´¢è¯¾ç¨‹åç§°æˆ–ç¼–ç ...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="1">å¯ç”¨</option>
                                <option value="0">åœç”¨</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="teacherFilter">
                                <option value="">å…¨éƒ¨æ•™å¸ˆ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
                            <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                        </div>
                        <div class="col-md-2 text-right">
                            <button class="btn btn-success" id="addCourseBtn">
                                <span>â•</span> æ·»åŠ è¯¾ç¨‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¾ç¨‹åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h5>è¯¾ç¨‹åˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="tableContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <p class="text-muted">æš‚æ— è¯¾ç¨‹æ•°æ®</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- è¯¾ç¨‹ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal" id="courseModal">
    <div class="modal-dialog" style="max-width: 600px;">
        <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">æ·»åŠ è¯¾ç¨‹</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="courseForm">
                <input type="hidden" id="courseId">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="courseCode" class="form-label">è¯¾ç¨‹ç¼–ç  *</label>
                            <input type="text"
                                   class="form-control"
                                   id="courseCode"
                                   name="courseCode"
                                   required
                                   placeholder="å¦‚ï¼šCS101">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="courseName" class="form-label">è¯¾ç¨‹åç§° *</label>
                            <input type="text"
                                   class="form-control"
                                   id="courseName"
                                   name="name"
                                   required
                                   placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="courseCredits" class="form-label">å­¦åˆ† *</label>
                            <input type="number"
                                   class="form-control"
                                   id="courseCredits"
                                   name="credits"
                                   required
                                   min="1"
                                   max="10"
                                   placeholder="1-10">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="maxStudents" class="form-label">æœ€å¤§é€‰è¯¾äººæ•° *</label>
                            <input type="number"
                                   class="form-control"
                                   id="maxStudents"
                                   name="maxStudents"
                                   required
                                   min="1"
                                   max="200"
                                   placeholder="1-200">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="courseTeacher" class="form-label">æˆè¯¾æ•™å¸ˆ *</label>
                            <select class="form-select" id="courseTeacher" name="teacherId" required>
                                <option value="">è¯·é€‰æ‹©æ•™å¸ˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="courseStatus" class="form-label">è¯¾ç¨‹çŠ¶æ€ *</label>
                            <select class="form-select" id="courseStatus" name="status" required>
                                <option value="1">å¯ç”¨</option>
                                <option value="0">åœç”¨</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="courseDescription" class="form-label">è¯¾ç¨‹æè¿°</label>
                    <textarea class="form-control"
                              id="courseDescription"
                              name="description"
                              rows="3"
                              placeholder="è¯·è¾“å…¥è¯¾ç¨‹æè¿°..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="saveCourseBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentCollege = null;
    let courses = [];
    let filteredCourses = [];
    let teachers = [];
    let isEditing = false;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isCollegeAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            currentCollege = AuthManager.getUserCollegeId();
            if (!currentCollege) {
                Utils.showMessage('æ— æ³•è·å–å­¦é™¢ä¿¡æ¯', 'danger');
                return;
            }

            await Promise.all([
                loadCourses(),
                loadTeachers()
            ]);

            renderTeacherFilter();
            renderTeacherSelect();
            renderCourseTable();
            loadStatistics();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
    async function loadCourses() {
        try {
            const response = await API.Course.getByCollege(currentCollege);
            if (response.code === 200) {
                courses = response.data || [];
                filteredCourses = [...courses];
            }
        } catch (error) {
            console.error('Load courses error:', error);
            throw error;
        }
    }

    // åŠ è½½æ•™å¸ˆåˆ—è¡¨
    async function loadTeachers() {
        try {
            const response = await API.Teacher.getByCollege(currentCollege);
            if (response.code === 200) {
                teachers = response.data || [];
            }
        } catch (error) {
            console.warn('Load teachers error:', error);
        }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStatistics() {
        try {
            const activeCourses = courses.filter(c => c.status === 1).length;
            document.getElementById('totalCourses').textContent = courses.length;
            document.getElementById('activeCourses').textContent = activeCourses;

            // åŠ è½½é€‰è¯¾ç»Ÿè®¡
            const statsResponse = await API.CourseSelection.getStatistics();
            if (statsResponse.code === 200) {
                const stats = statsResponse.data;
                const collegeStats = Object.entries(stats)
                    .filter(([courseId]) => courses.some(c => c.id == courseId))
                    .reduce((sum, [, count]) => sum + count, 0);

                document.getElementById('totalSelections').textContent = collegeStats;
            }
        } catch (error) {
            console.warn('Load statistics error:', error);
        }
    }

    // æ¸²æŸ“æ•™å¸ˆç­›é€‰å™¨
    function renderTeacherFilter() {
        const teacherFilter = document.getElementById('teacherFilter');
        teacherFilter.innerHTML = '<option value="">å…¨éƒ¨æ•™å¸ˆ</option>';

        teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = teacher.name;
            teacherFilter.appendChild(option);
        });
    }

    // æ¸²æŸ“æ•™å¸ˆé€‰æ‹©å™¨
    function renderTeacherSelect() {
        const teacherSelect = document.getElementById('courseTeacher');
        teacherSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ•™å¸ˆ</option>';

        teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = `${teacher.name} (${teacher.title})`;
            teacherSelect.appendChild(option);
        });
    }

    // æ¸²æŸ“è¯¾ç¨‹è¡¨æ ¼
    function renderCourseTable() {
        const tableContainer = document.getElementById('tableContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredCourses.length === 0) {
            showEmptyState();
            return;
        }

        const columns = [
            { field: 'courseCode', title: 'è¯¾ç¨‹ç¼–ç ', width: '100px' },
            { field: 'name', title: 'è¯¾ç¨‹åç§°' },
            { field: 'credits', title: 'å­¦åˆ†', width: '80px' },
            {
                field: 'teacher',
                title: 'æˆè¯¾æ•™å¸ˆ',
                width: '120px',
                render: (value) => value?.name || 'æœªåˆ†é…'
            },
            { field: 'maxStudents', title: 'æœ€å¤§äººæ•°', width: '100px' },
            {
                field: 'status',
                title: 'çŠ¶æ€',
                width: '80px',
                render: (value) => value === 1 ?
                    '<span class="badge bg-success">å¯ç”¨</span>' :
                    '<span class="badge bg-secondary">åœç”¨</span>'
            },
            {
                field: 'gmtCreate',
                title: 'åˆ›å»ºæ—¶é—´',
                width: '150px',
                render: (value) => Utils.formatDate(value, 'YYYY-MM-DD')
            },
            {
                field: 'actions',
                title: 'æ“ä½œ',
                width: '200px',
                render: (value, row) => `
                        <button class="btn btn-sm btn-primary" onclick="editCourse(${row.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-info ml-1" onclick="setPrerequisites(${row.id})">å…ˆä¿®</button>
                        <button class="btn btn-sm btn-danger ml-1" onclick="deleteCourse(${row.id})">åˆ é™¤</button>
                    `
            }
        ];

        TableUtils.createTable(filteredCourses, columns, tableContainer);

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        tableContainer.style.display = 'block';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');

        const performSearch = () => {
            const keyword = searchInput.value.trim().toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const teacherId = document.getElementById('teacherFilter').value;

            filteredCourses = courses.filter(course => {
                let match = true;

                if (keyword) {
                    match = match && (
                        course.name.toLowerCase().includes(keyword) ||
                        course.courseCode.toLowerCase().includes(keyword)
                    );
                }

                if (status !== '') {
                    match = match && course.status == status;
                }

                if (teacherId) {
                    match = match && course.teacher?.id == teacherId;
                }

                return match;
            });

            renderCourseTable();
        };

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        resetBtn.addEventListener('click', () => {
            searchInput.value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('teacherFilter').value = '';
            filteredCourses = [...courses];
            renderCourseTable();
        });

        // æ·»åŠ è¯¾ç¨‹
        document.getElementById('addCourseBtn').addEventListener('click', () => {
            openCourseModal();
        });

        // ä¿å­˜è¯¾ç¨‹
        document.getElementById('saveCourseBtn').addEventListener('click', saveCourse);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰“å¼€è¯¾ç¨‹ç¼–è¾‘æ¨¡æ€æ¡†
    function openCourseModal(course = null) {
        isEditing = !!course;

        document.getElementById('modalTitle').textContent = isEditing ? 'ç¼–è¾‘è¯¾ç¨‹' : 'æ·»åŠ è¯¾ç¨‹';
        document.getElementById('courseId').value = course?.id || '';
        document.getElementById('courseCode').value = course?.courseCode || '';
        document.getElementById('courseName').value = course?.name || '';
        document.getElementById('courseCredits').value = course?.credits || '';
        document.getElementById('maxStudents').value = course?.maxStudents || '';
        document.getElementById('courseTeacher').value = course?.teacher?.id || '';
        document.getElementById('courseStatus').value = course?.status ?? 1;
        document.getElementById('courseDescription').value = course?.description || '';

        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè¯¾ç¨‹ç¼–ç åªè¯»
        document.getElementById('courseCode').readOnly = isEditing;

        Utils.showModal(document.getElementById('courseModal'));
    }

    // ä¿å­˜è¯¾ç¨‹
    async function saveCourse() {
        const form = document.getElementById('courseForm');

        if (!Utils.validateForm(form)) {
            return;
        }

        const formData = FormUtils.serialize(form);
        const courseData = {
            courseCode: formData.courseCode.trim(),
            name: formData.name.trim(),
            credits: parseInt(formData.credits),
            maxStudents: parseInt(formData.maxStudents),
            teacherId: parseInt(formData.teacherId),
            collegeId: currentCollege,
            status: parseInt(formData.status),
            description: formData.description.trim()
        };

        try {
            const saveBtn = document.getElementById('saveCourseBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            let response;
            if (isEditing) {
                const courseId = document.getElementById('courseId').value;
                response = await API.Course.update(courseId, courseData);
            } else {
                response = await API.Course.create(courseData);
            }

            if (response.code === 200) {
                Utils.showMessage(isEditing ? 'è¯¾ç¨‹æ›´æ–°æˆåŠŸ' : 'è¯¾ç¨‹åˆ›å»ºæˆåŠŸ', 'success');
                closeModal();
                await loadCourses();
                renderCourseTable();
                loadStatistics();
            } else {
                Utils.showMessage('ä¿å­˜å¤±è´¥: ' + response.message, 'danger');
            }
        } catch (error) {
            console.error('Save course error:', error);
            Utils.showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
        } finally {
            const saveBtn = document.getElementById('saveCourseBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
        }
    }

    // ç¼–è¾‘è¯¾ç¨‹
    function editCourse(courseId) {
        const course = courses.find(c => c.id === courseId);
        if (course) {
            openCourseModal(course);
        }
    }

    // åˆ é™¤è¯¾ç¨‹
    function deleteCourse(courseId) {
        const course = courses.find(c => c.id === courseId);
        if (!course) return;

        Utils.confirm(
            `ç¡®å®šè¦åˆ é™¤è¯¾ç¨‹"${course.name}"å—ï¼Ÿ\n\nâš ï¸ åˆ é™¤åï¼Œç›¸å…³çš„é€‰è¯¾è®°å½•å’Œæˆç»©å°†å—åˆ°å½±å“ï¼`,
            async () => {
                try {
                    const response = await API.Course.delete(courseId);
                    if (response.code === 200) {
                        Utils.showMessage('è¯¾ç¨‹åˆ é™¤æˆåŠŸ', 'success');
                        await loadCourses();
                        renderCourseTable();
                        loadStatistics();
                    } else {
                        Utils.showMessage('åˆ é™¤å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Delete course error:', error);
                    Utils.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
                }
            }
        );
    }

    // è®¾ç½®å…ˆä¿®è¯¾ç¨‹
    function setPrerequisites(courseId) {
        const course = courses.find(c => c.id === courseId);
        if (!course) return;

        Utils.showMessage('å…ˆä¿®è¯¾ç¨‹è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // å…³é—­è¯¾ç¨‹æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        document.getElementById('courseForm').reset();

        // æ¸…é™¤éªŒè¯çŠ¶æ€
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => Utils.clearFieldError(field));
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.editCourse = editCourse;
    window.deleteCourse = deleteCourse;
    window.setPrerequisites = setPrerequisites;
    window.closeModal = closeModal;
</script>
</body>
</html>