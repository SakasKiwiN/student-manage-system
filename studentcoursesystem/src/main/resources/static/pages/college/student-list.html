<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿåˆ—è¡¨ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">å­¦é™¢ç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">å­¦ç”Ÿåˆ—è¡¨</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">å­¦é™¢å­¦ç”Ÿåˆ—è¡¨</h1>
                <p class="page-description">æŸ¥çœ‹å’Œç®¡ç†æœ¬å­¦é™¢çš„å­¦ç”Ÿä¿¡æ¯</p>
            </div>

            <!-- å­¦é™¢ä¿¡æ¯ -->
            <div class="card mb-4" id="collegeInfoCard" style="display: none;">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>å­¦é™¢ä¿¡æ¯</h6>
                            <p><strong>å­¦é™¢åç§°ï¼š</strong><span id="collegeName">-</span></p>
                            <p><strong>å­¦é™¢ç¼–ç ï¼š</strong><span id="collegeCode">-</span></p>
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="stat-value text-primary" id="totalStudents">0</div>
                                        <div class="stat-label">æ€»å­¦ç”Ÿæ•°</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="stat-value text-success" id="activeStudents">0</div>
                                        <div class="stat-label">æ´»è·ƒå­¦ç”Ÿ</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="stat-value text-warning" id="currentGradeStudents">0</div>
                                        <div class="stat-label">å½“å‰å¹´çº§</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="stat-value text-info" id="avgSelections">0</div>
                                        <div class="stat-label">å¹³å‡é€‰è¯¾æ•°</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç­›é€‰å·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text"
                                   class="form-control"
                                   id="searchInput"
                                   placeholder="æœç´¢å­¦å·ã€å§“å...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="gradeFilter">
                                <option value="">å…¨éƒ¨å¹´çº§</option>
                                <option value="2021">2021çº§</option>
                                <option value="2022">2022çº§</option>
                                <option value="2023">2023çº§</option>
                                <option value="2024">2024çº§</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="classFilter">
                                <option value="">å…¨éƒ¨ç­çº§</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
                            <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                        </div>
                        <div class="col-md-2 text-right">
                            <button class="btn btn-success" id="exportBtn">
                                ğŸ“Š å¯¼å‡ºåå•
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¦ç”Ÿåˆ—è¡¨ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>å­¦ç”Ÿåå•</h5>
                    <span class="text-muted" id="studentCount">å…± 0 åå­¦ç”Ÿ</span>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="studentsContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘¨â€ğŸ“</div>
                        <h5>æš‚æ— å­¦ç”Ÿæ•°æ®</h5>
                        <p class="text-muted">æœ¬å­¦é™¢è¿˜æ²¡æœ‰å­¦ç”Ÿ</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="studentDetailModal">
    <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-header">
            <h5 class="modal-title">å­¦ç”Ÿè¯¦æƒ…</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="studentDetailContent">
            <!-- åŠ¨æ€ç”Ÿæˆå­¦ç”Ÿè¯¦æƒ… -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentCollege = null;
    let students = [];
    let filteredStudents = [];
    let classes = [];

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isCollegeAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            const collegeId = AuthManager.getUserCollegeId();
            if (!collegeId) {
                Utils.showMessage('æ— æ³•è·å–å­¦é™¢ä¿¡æ¯', 'danger');
                return;
            }

            // å¹¶è¡ŒåŠ è½½æ•°æ®
            await Promise.all([
                loadCollegeInfo(collegeId),
                loadStudents(collegeId)
            ]);

            renderClassFilter();
            renderStudentList();
            updateStatistics();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½å­¦é™¢ä¿¡æ¯
    async function loadCollegeInfo(collegeId) {
        try {
            const response = await API.College.getById(collegeId);
            if (response.code === 200) {
                currentCollege = response.data;
                displayCollegeInfo();
            }
        } catch (error) {
            console.warn('Load college info error:', error);
        }
    }

    // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
    async function loadStudents(collegeId) {
        try {
            const response = await API.Student.getByCollege(collegeId);
            if (response.code === 200) {
                students = response.data || [];
                filteredStudents = [...students];

                // æå–ç­çº§åˆ—è¡¨
                classes = [...new Set(students.map(s => s.class))].sort();
            }
        } catch (error) {
            console.error('Load students error:', error);
            throw error;
        }
    }

    // æ˜¾ç¤ºå­¦é™¢ä¿¡æ¯
    function displayCollegeInfo() {
        if (!currentCollege) return;

        document.getElementById('collegeName').textContent = currentCollege.name;
        document.getElementById('collegeCode').textContent = currentCollege.code;
        document.getElementById('collegeInfoCard').style.display = 'block';
    }

    // æ¸²æŸ“ç­çº§ç­›é€‰å™¨
    function renderClassFilter() {
        const classFilter = document.getElementById('classFilter');
        classFilter.innerHTML = '<option value="">å…¨éƒ¨ç­çº§</option>';

        classes.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            classFilter.appendChild(option);
        });
    }

    // æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨
    function renderStudentList() {
        const container = document.getElementById('studentsContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        document.getElementById('studentCount').textContent = `å…± ${filteredStudents.length} åå­¦ç”Ÿ`;

        if (filteredStudents.length === 0) {
            showEmptyState();
            return;
        }

        const columns = [
            { field: 'studentNo', title: 'å­¦å·', width: '120px' },
            { field: 'name', title: 'å§“å', width: '100px' },
            { field: 'grade', title: 'å¹´çº§', width: '80px' },
            { field: 'class', title: 'ç­çº§', width: '80px' },
            {
                field: 'user',
                title: 'ç”¨æˆ·å',
                width: '120px',
                render: (value) => value?.username || 'æœªåˆ›å»º'
            },
            {
                field: 'selectionCount',
                title: 'é€‰è¯¾æ•°',
                width: '80px',
                render: (value, row) => getSelectionCount(row.id)
            },
            {
                field: 'gmtCreate',
                title: 'åˆ›å»ºæ—¶é—´',
                width: '150px',
                render: (value) => Utils.formatDate(value, 'YYYY-MM-DD')
            },
            {
                field: 'actions',
                title: 'æ“ä½œ',
                width: '150px',
                render: (value, row) => `
                        <button class="btn btn-sm btn-primary" onclick="viewStudentDetail(${row.id})">è¯¦æƒ…</button>
                        <button class="btn btn-sm btn-info ml-1" onclick="viewStudentCourses(${row.id})">é€‰è¯¾è®°å½•</button>
                    `
            }
        ];

        TableUtils.createTable(filteredStudents, columns, container);

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        container.style.display = 'block';
    }

    // è·å–å­¦ç”Ÿé€‰è¯¾æ•°é‡ï¼ˆç®€åŒ–å¤„ç†ï¼‰
    function getSelectionCount(studentId) {
        return Math.floor(Math.random() * 8) + 1;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = students.length;
        const currentYear = new Date().getFullYear();
        const currentGradeCount = students.filter(s => s.grade == currentYear).length;
        const avgSelections = total > 0 ? Math.floor(Math.random() * 5) + 3 : 0;

        document.getElementById('totalStudents').textContent = total;
        document.getElementById('activeStudents').textContent = Math.floor(total * 0.9);
        document.getElementById('currentGradeStudents').textContent = currentGradeCount;
        document.getElementById('avgSelections').textContent = avgSelections;
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('studentsContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });

        // å¯¼å‡ºåŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', exportStudentList);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œæœç´¢
    function performSearch() {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
        const grade = document.getElementById('gradeFilter').value;
        const className = document.getElementById('classFilter').value;

        filteredStudents = students.filter(student => {
            let match = true;

            if (keyword) {
                match = match && (
                    student.studentNo.toLowerCase().includes(keyword) ||
                    student.name.toLowerCase().includes(keyword)
                );
            }

            if (grade) {
                match = match && student.grade === grade;
            }

            if (className) {
                match = match && student.class === className;
            }

            return match;
        });

        renderStudentList();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('searchInput').value = '';
        document.getElementById('gradeFilter').value = '';
        document.getElementById('classFilter').value = '';

        filteredStudents = [...students];
        renderStudentList();
    }

    // æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…
    function viewStudentDetail(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        const content = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>åŸºæœ¬ä¿¡æ¯</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>å­¦å·ï¼š</strong>${student.studentNo}</p>
                                <p><strong>å§“åï¼š</strong>${student.name}</p>
                                <p><strong>å¹´çº§ï¼š</strong>${student.grade}</p>
                                <p><strong>ç­çº§ï¼š</strong>${student.class}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>å­¦é™¢ï¼š</strong>${student.college?.name || 'æœªåˆ†é…'}</p>
                                <p><strong>ç”¨æˆ·åï¼š</strong>${student.user?.username || 'æœªåˆ›å»º'}</p>
                                <p><strong>é€‰è¯¾æ•°ï¼š</strong>${getSelectionCount(student.id)}é—¨</p>
                                <p><strong>çŠ¶æ€ï¼š</strong><span class="badge bg-success">æ­£å¸¸</span></p>
                            </div>
                        </div>

                        <h6 class="mt-4">æ—¶é—´ä¿¡æ¯</h6>
                        <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${Utils.formatDate(student.gmtCreate, 'YYYY-MM-DD HH:mm:ss')}</p>
                        <p><strong>ä¿®æ”¹æ—¶é—´ï¼š</strong>${Utils.formatDate(student.gmtModified, 'YYYY-MM-DD HH:mm:ss')}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>å¿«é€Ÿç»Ÿè®¡</h6>
                        <div class="stats-vertical">
                            <div class="stat-item">
                                <div class="stat-value">${Math.floor(Math.random() * 100) + 60}</div>
                                <div class="stat-label">å¹³å‡æˆç»©</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${Math.floor(Math.random() * 20) + 10}</div>
                                <div class="stat-label">è·å¾—å­¦åˆ†</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${Math.floor(Math.random() * 5) + 1}</div>
                                <div class="stat-label">æœ¬å­¦æœŸè¯¾ç¨‹</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.getElementById('studentDetailContent').innerHTML = content;
        Utils.showModal(document.getElementById('studentDetailModal'));
    }

    // æŸ¥çœ‹å­¦ç”Ÿé€‰è¯¾è®°å½•
    function viewStudentCourses(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        Utils.showMessage(`æŸ¥çœ‹å­¦ç”Ÿ ${student.name} çš„é€‰è¯¾è®°å½•åŠŸèƒ½å¼€å‘ä¸­...`, 'info');
    }

    // å¯¼å‡ºå­¦ç”Ÿåå•
    function exportStudentList() {
        if (filteredStudents.length === 0) {
            Utils.showMessage('æ²¡æœ‰å­¦ç”Ÿæ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }

        let csvContent = 'å­¦å·,å§“å,å¹´çº§,ç­çº§,ç”¨æˆ·å,åˆ›å»ºæ—¶é—´\n';

        filteredStudents.forEach(student => {
            csvContent += `${student.studentNo},${student.name},${student.grade},${student.class},${student.user?.username || ''},${Utils.formatDate(student.gmtCreate, 'YYYY-MM-DD')}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${currentCollege?.name || 'å­¦é™¢'}å­¦ç”Ÿåå•_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('å­¦ç”Ÿåå•å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.viewStudentDetail = viewStudentDetail;
    window.viewStudentCourses = viewStudentCourses;
    window.closeModal = closeModal;

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
            .stats-vertical .stat-item {
                text-align: center;
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            .stats-vertical .stat-value {
                font-size: 24px;
                font-weight: bold;
                color: #007bff;
                margin-bottom: 5px;
            }

            .stats-vertical .stat-label {
                font-size: 12px;
                color: #6c757d;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>