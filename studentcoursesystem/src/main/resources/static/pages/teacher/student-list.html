<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç®¡ç† - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">æ•™å­¦ç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">å­¦ç”Ÿç®¡ç†</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">å­¦ç”Ÿç®¡ç†</h1>
                <p class="page-description">æŸ¥çœ‹å’Œç®¡ç†æ‚¨è¯¾ç¨‹çš„é€‰è¯¾å­¦ç”Ÿ</p>
            </div>

            <!-- è¯¾ç¨‹é€‰æ‹© -->
            <div class="card">
                <div class="card-header">
                    <h5>é€‰æ‹©è¯¾ç¨‹</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">æˆ‘çš„è¯¾ç¨‹</label>
                                <select class="form-select" id="courseSelect">
                                    <option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" id="loadStudentsBtn" disabled>åŠ è½½å­¦ç”Ÿåˆ—è¡¨</button>
                                    <button class="btn btn-success ml-2" id="exportListBtn" disabled>å¯¼å‡ºåå•</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¯¾ç¨‹ä¿¡æ¯æ˜¾ç¤º -->
                    <div id="courseInfo" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>è¯¾ç¨‹ç¼–ç ï¼š</strong><span id="courseCode">-</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>å­¦åˆ†ï¼š</strong><span id="courseCredits">-</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>æœ€å¤§äººæ•°ï¼š</strong><span id="maxStudents">-</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>å½“å‰çŠ¶æ€ï¼š</strong><span id="courseStatus">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¦ç”Ÿç»Ÿè®¡ -->
            <div class="stats-grid mb-4" id="statsGrid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ‘¥</div>
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">æ€»ç”³è¯·äººæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="selectedStudents">0</div>
                    <div class="stat-label">å·²é€‰ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">â³</div>
                    <div class="stat-value" id="pendingStudents">0</div>
                    <div class="stat-label">å¾…æŠ½ç­¾</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">âŒ</div>
                    <div class="stat-value" id="rejectedStudents">0</div>
                    <div class="stat-label">æœªä¸­ç­¾</div>
                </div>
            </div>

            <!-- ç­›é€‰å·¥å…·æ  -->
            <div class="card" id="filterCard" style="display: none;">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">é€‰è¯¾çŠ¶æ€</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="1">ç”³è¯·ä¸­</option>
                                    <option value="2">å·²ç¡®å®š</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">æŠ½ç­¾ç»“æœ</label>
                                <select class="form-select" id="resultFilter">
                                    <option value="">å…¨éƒ¨ç»“æœ</option>
                                    <option value="1">ä¸­ç­¾</option>
                                    <option value="0">æœªä¸­ç­¾</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">ç­çº§</label>
                                <select class="form-select" id="classFilter">
                                    <option value="">å…¨éƒ¨ç­çº§</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">æœç´¢</label>
                                <input type="text"
                                       class="form-control"
                                       id="searchInput"
                                       placeholder="æœç´¢å­¦å·ã€å§“å...">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
                            <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¦ç”Ÿåˆ—è¡¨ -->
            <div class="card" id="studentsCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>å­¦ç”Ÿåˆ—è¡¨</h5>
                    <span class="text-muted" id="studentCount">å…± 0 åå­¦ç”Ÿ</span>
                </div>
                <div class="card-body">
                    <div id="studentsLoadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½å­¦ç”Ÿæ•°æ®ä¸­...</p>
                    </div>

                    <div id="studentsTableContainer" style="display: none;"></div>

                    <div id="studentsEmptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘¥</div>
                        <h5>è¯¥è¯¾ç¨‹æš‚æ— é€‰è¯¾å­¦ç”Ÿ</h5>
                        <p class="text-muted">è¿˜æ²¡æœ‰å­¦ç”Ÿç”³è¯·é€‰æ‹©è¿™é—¨è¯¾ç¨‹</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="studentDetailModal">
    <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-header">
            <h5 class="modal-title">å­¦ç”Ÿè¯¦æƒ…</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="studentDetailContent">
            <!-- åŠ¨æ€ç”Ÿæˆå­¦ç”Ÿè¯¦æƒ… -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
            <button type="button" class="btn btn-primary" id="sendMessageBtn" style="display: none;">å‘é€æ¶ˆæ¯</button>
        </div>
    </div>
</div>

<!-- å‘é€æ¶ˆæ¯æ¨¡æ€æ¡† -->
<div class="modal" id="sendMessageModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h5 class="modal-title">å‘é€æ¶ˆæ¯</h5>
            <button type="button" class="modal-close" onclick="closeSendMessageModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="messageForm">
                <input type="hidden" id="messageReceiverId">
                <div class="form-group">
                    <label class="form-label">æ¥æ”¶äºº</label>
                    <input type="text" class="form-control" id="receiverName" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">ç›¸å…³è¯¾ç¨‹</label>
                    <input type="text" class="form-control" id="relatedCourse" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¶ˆæ¯å†…å®¹ *</label>
                    <textarea class="form-control"
                              id="messageContent"
                              rows="5"
                              required
                              placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..."
                              maxlength="1000"></textarea>
                    <small class="text-muted">æœ€å¤š1000ä¸ªå­—ç¬¦</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSendMessageModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="confirmSendBtn">å‘é€</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentTeacher = null;
    let myCourses = [];
    let currentCourse = null;
    let allStudents = [];
    let filteredStudents = [];
    let classes = [];
    let selectedStudent = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isTeacher()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            // è·å–å½“å‰æ•™å¸ˆä¿¡æ¯
            const teacherResponse = await API.Teacher.getCurrent();
            if (teacherResponse.code === 200) {
                currentTeacher = teacherResponse.data;
                await loadMyCourses();

                // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æŒ‡å®šäº†è¯¾ç¨‹ID
                const courseId = Utils.getUrlParam('courseId');
                if (courseId && myCourses.some(c => c.id == courseId)) {
                    document.getElementById('courseSelect').value = courseId;
                    currentCourse = myCourses.find(c => c.id == courseId);
                    if (currentCourse) {
                        await loadCourseStudents();
                        updateCourseInfo();
                        showStudentManagement();
                    }
                }
            }
        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æˆ‘çš„è¯¾ç¨‹
    async function loadMyCourses() {
        try {
            if (!currentTeacher) return;

            const response = await API.Course.getByTeacher(currentTeacher.id);
            if (response.code === 200) {
                myCourses = response.data || [];
                renderCourseSelect();
            }
        } catch (error) {
            console.error('Load my courses error:', error);
            Utils.showMessage('åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥', 'danger');
        }
    }

    // æ¸²æŸ“è¯¾ç¨‹é€‰æ‹©å™¨
    function renderCourseSelect() {
        const courseSelect = document.getElementById('courseSelect');
        courseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>';

        myCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = `${course.name} (${course.courseCode})`;
            courseSelect.appendChild(option);
        });
    }

    // åŠ è½½è¯¾ç¨‹å­¦ç”Ÿ
    async function loadCourseStudents() {
        try {
            if (!currentCourse) return;

            const loadingContainer = document.getElementById('studentsLoadingContainer');
            const tableContainer = document.getElementById('studentsTableContainer');
            const emptyContainer = document.getElementById('studentsEmptyContainer');

            loadingContainer.style.display = 'block';
            tableContainer.style.display = 'none';
            emptyContainer.style.display = 'none';

            const response = await API.CourseSelection.getCourseSelections(currentCourse.id);

            if (response.code === 200) {
                allStudents = response.data || [];
                filteredStudents = [...allStudents];

                if (allStudents.length === 0) {
                    showStudentsEmptyState();
                } else {
                    extractClasses();
                    renderClassFilter();
                    renderStudentsTable();
                    updateStatistics();
                }
            } else {
                Utils.showMessage('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥: ' + response.message, 'danger');
                showStudentsEmptyState();
            }
        } catch (error) {
            console.error('Load course students error:', error);
            Utils.showMessage('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥', 'danger');
            showStudentsEmptyState();
        } finally {
            document.getElementById('studentsLoadingContainer').style.display = 'none';
        }
    }

    // æå–ç­çº§åˆ—è¡¨
    function extractClasses() {
        const classSet = new Set();
        allStudents.forEach(selection => {
            if (selection.student.class) {
                classSet.add(selection.student.class);
            }
        });
        classes = Array.from(classSet).sort();
    }

    // æ¸²æŸ“ç­çº§ç­›é€‰å™¨
    function renderClassFilter() {
        const classFilter = document.getElementById('classFilter');
        classFilter.innerHTML = '<option value="">å…¨éƒ¨ç­çº§</option>';

        classes.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            classFilter.appendChild(option);
        });
    }

    // æ¸²æŸ“å­¦ç”Ÿè¡¨æ ¼
    function renderStudentsTable() {
        const tableContainer = document.getElementById('studentsTableContainer');

        const columns = [
            { field: 'student.studentNo', title: 'å­¦å·', width: '120px' },
            { field: 'student.name', title: 'å§“å', width: '100px' },
            { field: 'student.grade', title: 'å¹´çº§', width: '80px' },
            { field: 'student.class', title: 'ç­çº§', width: '80px' },
            {
                field: 'status',
                title: 'é€‰è¯¾çŠ¶æ€',
                width: '100px',
                render: (value) => {
                    if (value === 1) {
                        return '<span class="badge bg-warning">ç”³è¯·ä¸­</span>';
                    } else if (value === 2) {
                        return '<span class="badge bg-info">å·²ç¡®å®š</span>';
                    }
                    return '<span class="badge bg-secondary">æœªçŸ¥</span>';
                }
            },
            {
                field: 'lotteryResult',
                title: 'æŠ½ç­¾ç»“æœ',
                width: '100px',
                render: (value, row) => {
                    if (row.status === 1) {
                        return '<span class="text-muted">å¾…æŠ½ç­¾</span>';
                    } else if (row.status === 2) {
                        if (value === 1) {
                            return '<span class="badge bg-success">ä¸­ç­¾</span>';
                        } else {
                            return '<span class="badge bg-danger">æœªä¸­ç­¾</span>';
                        }
                    }
                    return '<span class="text-muted">-</span>';
                }
            },
            {
                field: 'gmtCreate',
                title: 'ç”³è¯·æ—¶é—´',
                width: '150px',
                render: (value) => Utils.formatDate(value, 'YYYY-MM-DD HH:mm')
            },
            {
                field: 'actions',
                title: 'æ“ä½œ',
                width: '180px',
                render: (value, row) => `
                    <button class="btn btn-sm btn-primary" onclick="viewStudentDetail(${row.student.id})">
                        è¯¦æƒ…
                    </button>
                    <button class="btn btn-sm btn-success ml-1" onclick="sendMessage(${row.student.id})">
                        å‘æ¶ˆæ¯
                    </button>
                    <button class="btn btn-sm btn-info ml-1" onclick="viewStudentScores(${row.student.id})">
                        æˆç»©
                    </button>
                `
            }
        ];

        TableUtils.createTable(filteredStudents, columns, tableContainer);

        tableContainer.style.display = 'block';
        document.getElementById('studentCount').textContent = `å…± ${filteredStudents.length} åå­¦ç”Ÿ`;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = allStudents.length;
        const selected = allStudents.filter(s => s.status === 2 && s.lotteryResult === 1).length;
        const pending = allStudents.filter(s => s.status === 1).length;
        const rejected = allStudents.filter(s => s.status === 2 && s.lotteryResult !== 1).length;

        document.getElementById('totalStudents').textContent = total;
        document.getElementById('selectedStudents').textContent = selected;
        document.getElementById('pendingStudents').textContent = pending;
        document.getElementById('rejectedStudents').textContent = rejected;
    }

    // æ˜¾ç¤ºå­¦ç”Ÿç®¡ç†ç•Œé¢
    function showStudentManagement() {
        document.getElementById('statsGrid').style.display = 'grid';
        document.getElementById('filterCard').style.display = 'block';
        document.getElementById('studentsCard').style.display = 'block';
    }

    // æ›´æ–°è¯¾ç¨‹ä¿¡æ¯
    function updateCourseInfo() {
        if (!currentCourse) return;

        document.getElementById('courseCode').textContent = currentCourse.courseCode;
        document.getElementById('courseCredits').textContent = currentCourse.credits;
        document.getElementById('maxStudents').textContent = currentCourse.maxStudents;
        document.getElementById('courseStatus').innerHTML = currentCourse.status === 1 ?
            '<span class="badge bg-success">å¯ç”¨</span>' :
            '<span class="badge bg-secondary">åœç”¨</span>';

        document.getElementById('courseInfo').style.display = 'block';
        document.getElementById('loadStudentsBtn').disabled = false;
        document.getElementById('exportListBtn').disabled = false;
    }

    // æ˜¾ç¤ºå­¦ç”Ÿç©ºçŠ¶æ€
    function showStudentsEmptyState() {
        document.getElementById('studentsLoadingContainer').style.display = 'none';
        document.getElementById('studentsTableContainer').style.display = 'none';
        document.getElementById('studentsEmptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // è¯¾ç¨‹é€‰æ‹©
        const courseSelect = document.getElementById('courseSelect');

        courseSelect.addEventListener('change', function() {
            const courseId = this.value;
            currentCourse = myCourses.find(c => c.id == courseId);

            if (currentCourse) {
                updateCourseInfo();
            } else {
                hideCourseInfo();
            }
        });

        // åŠ è½½å­¦ç”ŸæŒ‰é’®
        document.getElementById('loadStudentsBtn').addEventListener('click', function() {
            if (currentCourse) {
                loadCourseStudents();
                showStudentManagement();
            }
        });

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });

        // ç­›é€‰å™¨å˜åŒ–
        document.getElementById('statusFilter').addEventListener('change', performSearch);
        document.getElementById('resultFilter').addEventListener('change', performSearch);
        document.getElementById('classFilter').addEventListener('change', performSearch);

        // å¯¼å‡ºåå•
        document.getElementById('exportListBtn').addEventListener('click', exportStudentList);

        // å‘é€æ¶ˆæ¯ç¡®è®¤
        document.getElementById('confirmSendBtn').addEventListener('click', confirmSendMessage);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // éšè—è¯¾ç¨‹ä¿¡æ¯
    function hideCourseInfo() {
        document.getElementById('courseInfo').style.display = 'none';
        document.getElementById('statsGrid').style.display = 'none';
        document.getElementById('filterCard').style.display = 'none';
        document.getElementById('studentsCard').style.display = 'none';
        document.getElementById('loadStudentsBtn').disabled = true;
        document.getElementById('exportListBtn').disabled = true;
    }

    // æ‰§è¡Œæœç´¢
    function performSearch() {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const result = document.getElementById('resultFilter').value;
        const className = document.getElementById('classFilter').value;

        filteredStudents = allStudents.filter(selection => {
            let match = true;

            if (keyword) {
                const student = selection.student;
                match = match && (
                    student.studentNo.toLowerCase().includes(keyword) ||
                    student.name.toLowerCase().includes(keyword)
                );
            }

            if (status) {
                match = match && selection.status == status;
            }

            if (result !== '' && selection.status === 2) {
                match = match && selection.lotteryResult == result;
            }

            if (className) {
                match = match && selection.student.class === className;
            }

            return match;
        });

        renderStudentsTable();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('resultFilter').value = '';
        document.getElementById('classFilter').value = '';

        filteredStudents = [...allStudents];
        renderStudentsTable();
    }

    // æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…
    function viewStudentDetail(studentId) {
        const selection = allStudents.find(s => s.student.id === studentId);
        if (!selection) return;

        selectedStudent = selection.student;
        const student = selection.student;

        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6>åŸºæœ¬ä¿¡æ¯</h6>
                    <p><strong>å­¦å·ï¼š</strong>${student.studentNo}</p>
                    <p><strong>å§“åï¼š</strong>${student.name}</p>
                    <p><strong>å¹´çº§ï¼š</strong>${student.grade}</p>
                    <p><strong>ç­çº§ï¼š</strong>${student.class}</p>
                    <p><strong>å­¦é™¢ï¼š</strong>${student.college?.name || 'æœªçŸ¥'}</p>
                </div>
                <div class="col-md-6">
                    <h6>é€‰è¯¾ä¿¡æ¯</h6>
                    <p><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${Utils.formatDate(selection.gmtCreate, 'YYYY-MM-DD HH:mm')}</p>
                    <p><strong>é€‰è¯¾çŠ¶æ€ï¼š</strong>
                        ${selection.status === 1 ? '<span class="badge bg-warning">ç”³è¯·ä¸­</span>' :
            '<span class="badge bg-info">å·²ç¡®å®š</span>'}
                    </p>
                    <p><strong>æŠ½ç­¾ç»“æœï¼š</strong>
                        ${selection.status === 1 ? '<span class="text-muted">å¾…æŠ½ç­¾</span>' :
            (selection.lotteryResult === 1 ?
                '<span class="badge bg-success">ä¸­ç­¾</span>' :
                '<span class="badge bg-danger">æœªä¸­ç­¾</span>')}
                    </p>
                    <p><strong>å½“å‰è¯¾ç¨‹ï¼š</strong>${currentCourse.name}</p>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <h6>å­¦ä¹ æƒ…å†µ</h6>
                    <p><strong>æœ¬è¯¾ç¨‹æˆç»©ï¼š</strong><span id="studentScore">æŸ¥è¯¢ä¸­...</span></p>
                    <p><strong>é€‰è¯¾æ€»æ•°ï¼š</strong><span id="totalSelections">æŸ¥è¯¢ä¸­...</span></p>
                    <p><strong>å¹³å‡æˆç»©ï¼š</strong><span id="averageScore">æŸ¥è¯¢ä¸­...</span></p>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <h6>å¿«é€Ÿæ“ä½œ</h6>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="sendMessage(${student.id})">å‘é€æ¶ˆæ¯</button>
                        <button class="btn btn-info btn-sm" onclick="viewStudentScores(${student.id})">æŸ¥çœ‹æˆç»©</button>
                        <a href="/pages/teacher/score-input.html?courseId=${currentCourse.id}"
                           class="btn btn-success btn-sm">å½•å…¥æˆç»©</a>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('studentDetailContent').innerHTML = content;
        document.getElementById('sendMessageBtn').style.display = 'inline-block';
        document.getElementById('sendMessageBtn').onclick = () => sendMessage(student.id);

        Utils.showModal(document.getElementById('studentDetailModal'));

        // å¼‚æ­¥åŠ è½½å­¦ç”Ÿæˆç»©ä¿¡æ¯
        loadStudentScoreInfo(studentId);
    }

    // åŠ è½½å­¦ç”Ÿæˆç»©ä¿¡æ¯
    async function loadStudentScoreInfo(studentId) {
        try {
            // æŸ¥è¯¢æœ¬è¯¾ç¨‹æˆç»©
            const courseScoreResponse = await API.Score.getByStudentAndCourse(studentId, currentCourse.id);
            const scoreSpan = document.getElementById('studentScore');
            if (courseScoreResponse.code === 200 && courseScoreResponse.data) {
                scoreSpan.textContent = courseScoreResponse.data.score + 'åˆ†';
                scoreSpan.className = 'text-success';
            } else {
                scoreSpan.textContent = 'æœªå½•å…¥';
                scoreSpan.className = 'text-muted';
            }

            // æŸ¥è¯¢å­¦ç”Ÿæ‰€æœ‰é€‰è¯¾
            const selectionsResponse = await API.CourseSelection.getByStudent(studentId);
            if (selectionsResponse.code === 200) {
                document.getElementById('totalSelections').textContent = selectionsResponse.data.length + 'é—¨';
            }

            // æŸ¥è¯¢å­¦ç”Ÿæ‰€æœ‰æˆç»©
            const allScoresResponse = await API.Score.getByStudent(studentId);
            if (allScoresResponse.code === 200 && allScoresResponse.data.length > 0) {
                const scores = allScoresResponse.data.map(s => s.score);
                const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                document.getElementById('averageScore').textContent = average.toFixed(2) + 'åˆ†';
            } else {
                document.getElementById('averageScore').textContent = 'æš‚æ— æˆç»©';
            }
        } catch (error) {
            console.warn('Load student score info error:', error);
        }
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage(studentId) {
        const student = allStudents.find(s => s.student.id === studentId)?.student;
        if (!student) return;

        document.getElementById('messageReceiverId').value = student.user.id;
        document.getElementById('receiverName').value = `${student.name} (${student.studentNo})`;
        document.getElementById('relatedCourse').value = `${currentCourse.name} (${currentCourse.courseCode})`;
        document.getElementById('messageContent').value = '';

        // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
        Utils.closeModal();

        setTimeout(() => {
            Utils.showModal(document.getElementById('sendMessageModal'));
        }, 300);
    }

    // ç¡®è®¤å‘é€æ¶ˆæ¯
    async function confirmSendMessage() {
        const form = document.getElementById('messageForm');

        if (!Utils.validateForm(form)) {
            return;
        }

        try {
            const confirmBtn = document.getElementById('confirmSendBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'å‘é€ä¸­...';

            const receiverId = document.getElementById('messageReceiverId').value;
            const content = document.getElementById('messageContent').value.trim();

            const response = await API.Message.send(receiverId, content, currentCourse.id);

            if (response.code === 200) {
                Utils.showMessage('æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                closeSendMessageModal();
            } else {
                Utils.showMessage('å‘é€å¤±è´¥: ' + response.message, 'danger');
            }
        } catch (error) {
            console.error('Send message error:', error);
            Utils.showMessage('å‘é€å¤±è´¥: ' + error.message, 'danger');
        } finally {
            const confirmBtn = document.getElementById('confirmSendBtn');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'å‘é€';
        }
    }

    // æŸ¥çœ‹å­¦ç”Ÿæˆç»©
    function viewStudentScores(studentId) {
        const student = allStudents.find(s => s.student.id === studentId)?.student;
        if (!student) return;

        Utils.showMessage(`æŸ¥çœ‹å­¦ç”Ÿ ${student.name} çš„è¯¦ç»†æˆç»©åŠŸèƒ½å¼€å‘ä¸­...`, 'info');
        // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°æˆç»©è¯¦æƒ…é¡µé¢æˆ–æ‰“å¼€æ–°çš„æ¨¡æ€æ¡†
    }

    // å¯¼å‡ºå­¦ç”Ÿåå•
    function exportStudentList() {
        if (!currentCourse || filteredStudents.length === 0) {
            Utils.showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }

        let csvContent = 'å­¦å·,å§“å,å¹´çº§,ç­çº§,é€‰è¯¾çŠ¶æ€,æŠ½ç­¾ç»“æœ,ç”³è¯·æ—¶é—´\n';

        filteredStudents.forEach(selection => {
            const student = selection.student;
            const status = selection.status === 1 ? 'ç”³è¯·ä¸­' : 'å·²ç¡®å®š';
            const result = selection.status === 1 ? 'å¾…æŠ½ç­¾' :
                (selection.lotteryResult === 1 ? 'ä¸­ç­¾' : 'æœªä¸­ç­¾');
            const applyTime = Utils.formatDate(selection.gmtCreate, 'YYYY-MM-DD HH:mm');

            csvContent += `${student.studentNo},${student.name},${student.grade},${student.class},${status},${result},${applyTime}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${currentCourse.name}_å­¦ç”Ÿåå•_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('å­¦ç”Ÿåå•å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        selectedStudent = null;
    }

    // å…³é—­å‘é€æ¶ˆæ¯æ¨¡æ€æ¡†
    function closeSendMessageModal() {
        Utils.closeModal();
        document.getElementById('messageForm').reset();
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.viewStudentDetail = viewStudentDetail;
    window.sendMessage = sendMessage;
    window.viewStudentScores = viewStudentScores;
    window.closeModal = closeModal;
    window.closeSendMessageModal = closeSendMessageModal;
</script>
</body>
</html>