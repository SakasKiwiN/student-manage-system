<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¯¾ç¨‹ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">æ•™å­¦ç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">æˆ‘çš„è¯¾ç¨‹</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">æˆ‘çš„è¯¾ç¨‹</h1>
                <p class="page-description">æŸ¥çœ‹å’Œç®¡ç†æ‚¨æˆè¯¾çš„æ‰€æœ‰è¯¾ç¨‹</p>
            </div>

            <!-- æ•™å­¦ç»Ÿè®¡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“š</div>
                    <div class="stat-value" id="totalCourses">0</div>
                    <div class="stat-label">æ€»è¯¾ç¨‹æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="activeCourses">0</div>
                    <div class="stat-label">å¯ç”¨è¯¾ç¨‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">ğŸ‘¥</div>
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">æ€»å­¦ç”Ÿæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9b59b6; color: white;">ğŸ“Š</div>
                    <div class="stat-value" id="avgScore">0</div>
                    <div class="stat-label">å¹³å‡åˆ†</div>
                </div>
            </div>

            <!-- ç­›é€‰å·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">è¯¾ç¨‹çŠ¶æ€</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="1">å¯ç”¨</option>
                                    <option value="0">åœç”¨</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">å­¦åˆ†</label>
                                <select class="form-select" id="creditsFilter">
                                    <option value="">å…¨éƒ¨å­¦åˆ†</option>
                                    <option value="1">1å­¦åˆ†</option>
                                    <option value="2">2å­¦åˆ†</option>
                                    <option value="3">3å­¦åˆ†</option>
                                    <option value="4">4å­¦åˆ†</option>
                                    <option value="5">5å­¦åˆ†åŠä»¥ä¸Š</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">æœç´¢</label>
                                <input type="text"
                                       class="form-control"
                                       id="searchInput"
                                       placeholder="æœç´¢è¯¾ç¨‹åç§°æˆ–ç¼–ç ...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¾ç¨‹åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h5>æˆ‘çš„æˆè¯¾è¯¾ç¨‹</h5>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="coursesContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“š</div>
                        <h5>æš‚æ— æˆè¯¾è¯¾ç¨‹</h5>
                        <p class="text-muted">æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…ä»»ä½•è¯¾ç¨‹</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- è¯¾ç¨‹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="courseDetailModal">
    <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-header">
            <h5 class="modal-title">è¯¾ç¨‹è¯¦æƒ…</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="courseDetailContent">
            <!-- åŠ¨æ€ç”Ÿæˆè¯¾ç¨‹è¯¦æƒ… -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentTeacher = null;
    let myCourses = [];
    let filteredCourses = [];
    let courseStatistics = {};

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isTeacher()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            // è·å–å½“å‰æ•™å¸ˆä¿¡æ¯
            const teacherResponse = await API.Teacher.getCurrent();
            if (teacherResponse.code === 200) {
                currentTeacher = teacherResponse.data;
                await loadMyCourses();
                await loadCourseStatistics();

                renderCourseList();
                updateStatistics();
            }
        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æˆ‘çš„è¯¾ç¨‹
    async function loadMyCourses() {
        try {
            if (!currentTeacher) return;

            const response = await API.Course.getByTeacher(currentTeacher.id);
            if (response.code === 200) {
                myCourses = response.data || [];
                filteredCourses = [...myCourses];
            }
        } catch (error) {
            console.error('Load my courses error:', error);
            throw error;
        }
    }

    // åŠ è½½è¯¾ç¨‹ç»Ÿè®¡æ•°æ®
    async function loadCourseStatistics() {
        try {
            for (const course of myCourses) {
                // è·å–é€‰è¯¾ç»Ÿè®¡
                const selectionsResponse = await API.CourseSelection.getCourseSelections(course.id);
                const scoresResponse = await API.Score.getCourseStatistics(course.id);

                courseStatistics[course.id] = {
                    selections: selectionsResponse.code === 200 ? selectionsResponse.data : [],
                    scoreStats: scoresResponse.code === 200 ? scoresResponse.data : {}
                };
            }
        } catch (error) {
            console.warn('Load course statistics error:', error);
        }
    }

    // æ¸²æŸ“è¯¾ç¨‹åˆ—è¡¨
    function renderCourseList() {
        const container = document.getElementById('coursesContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredCourses.length === 0) {
            showEmptyState();
            return;
        }

        let html = '<div class="row">';

        filteredCourses.forEach(course => {
            const stats = courseStatistics[course.id] || { selections: [], scoreStats: {} };
            const enrolledStudents = stats.selections.filter(s => s.status === 2 && s.lotteryResult === 1).length;
            const averageScore = stats.scoreStats.average || 0;

            html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 ${course.status === 1 ? 'border-success' : 'border-secondary'}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${course.name}</h6>
                                <span class="badge ${course.status === 1 ? 'bg-success' : 'bg-secondary'}">
                                    ${course.status === 1 ? 'å¯ç”¨' : 'åœç”¨'}
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col-6">
                                        <div class="stat-value text-primary">${enrolledStudents}</div>
                                        <div class="stat-label">é€‰è¯¾å­¦ç”Ÿ</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-value text-success">${averageScore.toFixed(1)}</div>
                                        <div class="stat-label">å¹³å‡åˆ†</div>
                                    </div>
                                </div>

                                <div class="course-info">
                                    <p class="mb-1"><strong>è¯¾ç¨‹ç¼–ç ï¼š</strong>${course.courseCode}</p>
                                    <p class="mb-1"><strong>å­¦åˆ†ï¼š</strong>${course.credits}</p>
                                    <p class="mb-1"><strong>æœ€å¤§äººæ•°ï¼š</strong>${course.maxStudents}</p>
                                    <p class="mb-3"><strong>å¼€è¯¾å­¦é™¢ï¼š</strong>${course.college?.name || 'æœªçŸ¥'}</p>
                                </div>

                                <div class="progress mb-3">
                                    <div class="progress-bar ${getProgressColor(enrolledStudents, course.maxStudents)}"
                                         style="width: ${(enrolledStudents / course.maxStudents * 100)}%">
                                        ${Math.round(enrolledStudents / course.maxStudents * 100)}%
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-outline-info btn-sm" onclick="viewCourseDetail(${course.id})">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </button>
                                    <div class="btn-group">
                                        <a href="/pages/teacher/score-input.html?courseId=${course.id}"
                                           class="btn btn-primary btn-sm">å½•å…¥æˆç»©</a>
                                        <a href="/pages/teacher/courseware.html?courseId=${course.id}"
                                           class="btn btn-success btn-sm">è¯¾ä»¶ç®¡ç†</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        });

        html += '</div>';
        container.innerHTML = html;

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        container.style.display = 'block';
    }

    // è·å–è¿›åº¦æ¡é¢œè‰²
    function getProgressColor(enrolled, max) {
        const ratio = enrolled / max;
        if (ratio >= 0.9) return 'bg-danger';
        if (ratio >= 0.7) return 'bg-warning';
        return 'bg-success';
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = myCourses.length;
        const active = myCourses.filter(c => c.status === 1).length;

        let totalStudents = 0;
        let totalScores = 0;
        let scoreCount = 0;

        myCourses.forEach(course => {
            const stats = courseStatistics[course.id] || { selections: [], scoreStats: {} };
            const enrolled = stats.selections.filter(s => s.status === 2 && s.lotteryResult === 1).length;
            totalStudents += enrolled;

            if (stats.scoreStats.average) {
                totalScores += stats.scoreStats.average * enrolled;
                scoreCount += enrolled;
            }
        });

        const avgScore = scoreCount > 0 ? (totalScores / scoreCount) : 0;

        document.getElementById('totalCourses').textContent = total;
        document.getElementById('activeCourses').textContent = active;
        document.getElementById('totalStudents').textContent = totalStudents;
        document.getElementById('avgScore').textContent = avgScore.toFixed(1);
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('coursesContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchBtn').addEventListener('click', performSearch);

        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });

        // ç­›é€‰å™¨å˜åŒ–
        document.getElementById('statusFilter').addEventListener('change', performSearch);
        document.getElementById('creditsFilter').addEventListener('change', performSearch);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œæœç´¢
    function performSearch() {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const credits = document.getElementById('creditsFilter').value;

        filteredCourses = myCourses.filter(course => {
            let match = true;

            if (keyword) {
                match = match && (
                    course.name.toLowerCase().includes(keyword) ||
                    course.courseCode.toLowerCase().includes(keyword)
                );
            }

            if (status !== '') {
                match = match && course.status == status;
            }

            if (credits) {
                if (credits === '5') {
                    match = match && course.credits >= 5;
                } else {
                    match = match && course.credits == credits;
                }
            }

            return match;
        });

        renderCourseList();
    }

    // æŸ¥çœ‹è¯¾ç¨‹è¯¦æƒ…
    function viewCourseDetail(courseId) {
        const course = myCourses.find(c => c.id === courseId);
        if (!course) return;

        const stats = courseStatistics[courseId] || { selections: [], scoreStats: {} };
        const totalSelections = stats.selections.length;
        const enrolledStudents = stats.selections.filter(s => s.status === 2 && s.lotteryResult === 1);
        const pendingStudents = stats.selections.filter(s => s.status === 1);
        const rejectedStudents = stats.selections.filter(s => s.status === 2 && s.lotteryResult !== 1);

        const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>è¯¾ç¨‹ä¿¡æ¯</h6>
                        <p><strong>è¯¾ç¨‹ç¼–ç ï¼š</strong>${course.courseCode}</p>
                        <p><strong>è¯¾ç¨‹åç§°ï¼š</strong>${course.name}</p>
                        <p><strong>å­¦åˆ†ï¼š</strong>${course.credits}</p>
                        <p><strong>æœ€å¤§äººæ•°ï¼š</strong>${course.maxStudents}</p>
                        <p><strong>å¼€è¯¾å­¦é™¢ï¼š</strong>${course.college?.name || 'æœªçŸ¥'}</p>
                        <p><strong>è¯¾ç¨‹çŠ¶æ€ï¼š</strong>
                            <span class="badge ${course.status === 1 ? 'bg-success' : 'bg-secondary'}">
                                ${course.status === 1 ? 'å¯ç”¨' : 'åœç”¨'}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>é€‰è¯¾ç»Ÿè®¡</h6>
                        <p><strong>æ€»ç”³è¯·äººæ•°ï¼š</strong>${totalSelections}</p>
                        <p><strong>å·²é€‰ä¸­ï¼š</strong><span class="text-success">${enrolledStudents.length}</span></p>
                        <p><strong>å¾…æŠ½ç­¾ï¼š</strong><span class="text-warning">${pendingStudents.length}</span></p>
                        <p><strong>æœªä¸­ç­¾ï¼š</strong><span class="text-danger">${rejectedStudents.length}</span></p>
                        <p><strong>é€‰è¯¾ç‡ï¼š</strong>${course.maxStudents > 0 ? ((enrolledStudents.length / course.maxStudents) * 100).toFixed(1) : 0}%</p>
                        <p><strong>ç”³è¯·ç‡ï¼š</strong>${course.maxStudents > 0 ? ((totalSelections / course.maxStudents) * 100).toFixed(1) : 0}%</p>
                    </div>
                </div>

                ${stats.scoreStats.average ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>æˆç»©ç»Ÿè®¡</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>å¹³å‡åˆ†ï¼š</strong>${stats.scoreStats.average.toFixed(2)}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>æœ€é«˜åˆ†ï¼š</strong>${stats.scoreStats.maxScore || 0}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>æœ€ä½åˆ†ï¼š</strong>${stats.scoreStats.minScore || 0}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>åŠæ ¼ç‡ï¼š</strong>${stats.scoreStats.passRate || 0}%</p>
                            </div>
                        </div>
                    </div>
                </div>` : ''}

                ${course.description ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>è¯¾ç¨‹æè¿°</h6>
                        <p>${course.description}</p>
                    </div>
                </div>` : ''}

                <div class="row mt-3">
                    <div class="col-12">
                        <h6>å¿«é€Ÿæ“ä½œ</h6>
                        <div class="btn-group">
                            <a href="/pages/teacher/score-input.html?courseId=${course.id}"
                               class="btn btn-primary btn-sm">å½•å…¥æˆç»©</a>
                            <a href="/pages/teacher/courseware.html?courseId=${course.id}"
                               class="btn btn-success btn-sm">è¯¾ä»¶ç®¡ç†</a>
                            <a href="/pages/teacher/student-list.html?courseId=${course.id}"
                               class="btn btn-info btn-sm">å­¦ç”Ÿåå•</a>
                        </div>
                    </div>
                </div>
            `;

        document.getElementById('courseDetailContent').innerHTML = content;
        Utils.showModal(document.getElementById('courseDetailModal'));
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.viewCourseDetail = viewCourseDetail;
    window.closeModal = closeModal;
</script>
</body>
</html>