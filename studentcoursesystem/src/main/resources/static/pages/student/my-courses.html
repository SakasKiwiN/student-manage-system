<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¯¾ç¨‹ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">é€‰è¯¾ç³»ç»Ÿ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">æˆ‘çš„è¯¾ç¨‹</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">æˆ‘çš„è¯¾ç¨‹</h1>
                <p class="page-description">æŸ¥çœ‹å·²é€‰è¯¾ç¨‹çš„è¯¦ç»†ä¿¡æ¯å’ŒçŠ¶æ€</p>
            </div>

            <!-- é€‰è¯¾ç»Ÿè®¡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“š</div>
                    <div class="stat-value" id="totalCourses">0</div>
                    <div class="stat-label">æ€»é€‰è¯¾æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">â³</div>
                    <div class="stat-value" id="pendingCourses">0</div>
                    <div class="stat-label">ç”³è¯·ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="selectedCourses">0</div>
                    <div class="stat-label">å·²ä¸­ç­¾</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">âŒ</div>
                    <div class="stat-value" id="rejectedCourses">0</div>
                    <div class="stat-label">æœªä¸­ç­¾</div>
                </div>
            </div>

            <!-- ç­›é€‰å·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">è¯¾ç¨‹çŠ¶æ€</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="1">ç”³è¯·ä¸­</option>
                                    <option value="2">å·²ä¸­ç­¾</option>
                                    <option value="3">æœªä¸­ç­¾</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">å¼€è¯¾å­¦é™¢</label>
                                <select class="form-select" id="collegeFilter">
                                    <option value="">å…¨éƒ¨å­¦é™¢</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" id="filterBtn">ç­›é€‰</button>
                                    <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¾ç¨‹åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>æˆ‘çš„é€‰è¯¾åˆ—è¡¨</h5>
                    <div>
                        <button class="btn btn-success" id="exportBtn">
                            <span>ğŸ“Š</span> å¯¼å‡ºè¯¾ç¨‹è¡¨
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="coursesContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“š</div>
                        <h5>è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•è¯¾ç¨‹</h5>
                        <p class="text-muted">å¿«å»<a href="/pages/student/course-select.html">è¯¾ç¨‹é€‰æ‹©</a>é¡µé¢æŒ‘é€‰æ‚¨æ„Ÿå…´è¶£çš„è¯¾ç¨‹å§ï¼</p>
                    </div>
                </div>
            </div>

            <!-- å­¦åˆ†ç»Ÿè®¡ -->
            <div class="card" id="creditStats" style="display: none;">
                <div class="card-header">
                    <h5>å­¦åˆ†ç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-primary" id="totalCredits">0</div>
                                <div class="stat-label">æ€»å­¦åˆ†</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-success" id="earnedCredits">0</div>
                                <div class="stat-label">å·²è·å­¦åˆ†</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-warning" id="pendingCredits">0</div>
                                <div class="stat-label">å¾…å®šå­¦åˆ†</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-danger" id="lostCredits">0</div>
                                <div class="stat-label">å¤±å»å­¦åˆ†</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- è¯¾ç¨‹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="courseDetailModal">
    <div class="modal-dialog" style="max-width: 600px;">
        <div class="modal-header">
            <h5 class="modal-title">è¯¾ç¨‹è¯¦æƒ…</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="courseDetailContent">
            <!-- åŠ¨æ€ç”Ÿæˆè¯¾ç¨‹è¯¦æƒ… -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
            <button type="button" class="btn btn-danger" id="cancelCourseBtn" style="display: none;">å–æ¶ˆé€‰è¯¾</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentStudent = null;
    let myCourses = [];
    let filteredCourses = [];
    let colleges = [];
    let selectedCourse = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isStudent()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            // è·å–å½“å‰å­¦ç”Ÿä¿¡æ¯
            const studentResponse = await API.Student.getCurrent();
            if (studentResponse.code === 200) {
                currentStudent = studentResponse.data;
            }

            // å¹¶è¡ŒåŠ è½½æ•°æ®
            await Promise.all([
                loadMyCourses(),
                loadColleges()
            ]);

            renderCollegeFilter();
            renderCourseList();
            updateStatistics();
            updateCreditStats();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æˆ‘çš„è¯¾ç¨‹
    async function loadMyCourses() {
        try {
            const response = await API.CourseSelection.getMySelections();
            if (response.code === 200) {
                myCourses = response.data || [];
                filteredCourses = [...myCourses];
            }
        } catch (error) {
            console.error('Load my courses error:', error);
            throw error;
        }
    }

    // åŠ è½½å­¦é™¢åˆ—è¡¨
    async function loadColleges() {
        try {
            const response = await API.College.getAll();
            if (response.code === 200) {
                colleges = response.data || [];
            }
        } catch (error) {
            console.warn('Load colleges error:', error);
        }
    }

    // æ¸²æŸ“å­¦é™¢ç­›é€‰å™¨
    function renderCollegeFilter() {
        const collegeFilter = document.getElementById('collegeFilter');
        collegeFilter.innerHTML = '<option value="">å…¨éƒ¨å­¦é™¢</option>';

        colleges.forEach(college => {
            const option = document.createElement('option');
            option.value = college.id;
            option.textContent = college.name;
            collegeFilter.appendChild(option);
        });
    }

    // æ¸²æŸ“è¯¾ç¨‹åˆ—è¡¨
    function renderCourseList() {
        const container = document.getElementById('coursesContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredCourses.length === 0) {
            showEmptyState();
            return;
        }

        let html = '<div class="row">';
        filteredCourses.forEach(selection => {
            const course = selection.course;
            const status = getSelectionStatus(selection);
            const statusClass = getStatusClass(selection);

            html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 ${statusClass.border}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${course.name}</h6>
                                    <span class="badge ${statusClass.badge}">${status.text}</span>
                                </div>
                                <p class="text-muted mb-2">
                                    <small>è¯¾ç¨‹ç¼–ç ï¼š${course.courseCode} | å­¦åˆ†ï¼š${course.credits}</small>
                                </p>
                                <p class="text-muted mb-2">
                                    <small>æˆè¯¾æ•™å¸ˆï¼š${course.teacher?.name || 'å¾…å®š'}</small>
                                </p>
                                <p class="text-muted mb-2">
                                    <small>å¼€è¯¾å­¦é™¢ï¼š${course.college?.name || 'æœªçŸ¥'}</small>
                                </p>
                                <p class="text-muted mb-3">
                                    <small>é€‰è¯¾æ—¶é—´ï¼š${Utils.formatDate(selection.gmtCreate, 'YYYY-MM-DD HH:mm')}</small>
                                </p>
                                ${status.description ? `<div class="alert alert-info py-2 mb-3"><small>${status.description}</small></div>` : ''}
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-sm btn-outline-primary" onclick="showCourseDetail(${course.id})">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </button>
                                    ${renderActionButton(selection)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        });
        html += '</div>';

        container.innerHTML = html;

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        container.style.display = 'block';
    }

    // è·å–é€‰è¯¾çŠ¶æ€ä¿¡æ¯
    function getSelectionStatus(selection) {
        switch (selection.status) {
            case 1:
                return {
                    text: 'ç”³è¯·ä¸­',
                    description: 'æ‚¨çš„é€‰è¯¾ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…æŠ½ç­¾ç»“æœ'
                };
            case 2:
                if (selection.lotteryResult === 1) {
                    return {
                        text: 'å·²ä¸­ç­¾',
                        description: 'æ­å–œï¼æ‚¨å·²æˆåŠŸé€‰ä¸­è¯¥è¯¾ç¨‹'
                    };
                } else {
                    return {
                        text: 'æœªä¸­ç­¾',
                        description: 'å¾ˆé—æ†¾ï¼Œæ‚¨åœ¨æŠ½ç­¾ä¸­æœªèƒ½é€‰ä¸­è¯¥è¯¾ç¨‹'
                    };
                }
            case 3:
                return {
                    text: 'æœªä¸­ç­¾',
                    description: 'å¾ˆé—æ†¾ï¼Œæ‚¨åœ¨æŠ½ç­¾ä¸­æœªèƒ½é€‰ä¸­è¯¥è¯¾ç¨‹'
                };
            default:
                return { text: 'æœªçŸ¥çŠ¶æ€', description: null };
        }
    }

    // è·å–çŠ¶æ€æ ·å¼ç±»
    function getStatusClass(selection) {
        switch (selection.status) {
            case 1:
                return {
                    border: 'border-warning',
                    badge: 'bg-warning'
                };
            case 2:
                if (selection.lotteryResult === 1) {
                    return {
                        border: 'border-success',
                        badge: 'bg-success'
                    };
                } else {
                    return {
                        border: 'border-danger',
                        badge: 'bg-danger'
                    };
                }
            case 3:
                return {
                    border: 'border-danger',
                    badge: 'bg-danger'
                };
            default:
                return {
                    border: '',
                    badge: 'bg-secondary'
                };
        }
    }

    // æ¸²æŸ“æ“ä½œæŒ‰é’®
    function renderActionButton(selection) {
        if (selection.status === 1) {
            return `<button class="btn btn-sm btn-outline-danger" onclick="cancelSelection(${selection.course.id})">å–æ¶ˆé€‰è¯¾</button>`;
        } else if (selection.status === 2 && selection.lotteryResult === 1) {
            return `<span class="text-success"><small>âœ“ å·²ç¡®è®¤</small></span>`;
        } else {
            return `<span class="text-muted"><small>å·²ç»“æŸ</small></span>`;
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = myCourses.length;
        const pending = myCourses.filter(s => s.status === 1).length;
        const selected = myCourses.filter(s => s.status === 2 && s.lotteryResult === 1).length;
        const rejected = myCourses.filter(s => s.status === 2 && s.lotteryResult !== 1 || s.status === 3).length;

        document.getElementById('totalCourses').textContent = total;
        document.getElementById('pendingCourses').textContent = pending;
        document.getElementById('selectedCourses').textContent = selected;
        document.getElementById('rejectedCourses').textContent = rejected;
    }

    // æ›´æ–°å­¦åˆ†ç»Ÿè®¡
    function updateCreditStats() {
        if (myCourses.length === 0) return;

        const totalCredits = myCourses.reduce((sum, s) => sum + s.course.credits, 0);
        const earnedCredits = myCourses
            .filter(s => s.status === 2 && s.lotteryResult === 1)
            .reduce((sum, s) => sum + s.course.credits, 0);
        const pendingCredits = myCourses
            .filter(s => s.status === 1)
            .reduce((sum, s) => sum + s.course.credits, 0);
        const lostCredits = myCourses
            .filter(s => s.status === 2 && s.lotteryResult !== 1 || s.status === 3)
            .reduce((sum, s) => sum + s.course.credits, 0);

        document.getElementById('totalCredits').textContent = totalCredits;
        document.getElementById('earnedCredits').textContent = earnedCredits;
        document.getElementById('pendingCredits').textContent = pendingCredits;
        document.getElementById('lostCredits').textContent = lostCredits;

        document.getElementById('creditStats').style.display = 'block';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('coursesContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // ç­›é€‰åŠŸèƒ½
        document.getElementById('filterBtn').addEventListener('click', performFilter);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // å¯¼å‡ºåŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', exportCourseSchedule);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // å–æ¶ˆé€‰è¯¾æŒ‰é’®ï¼ˆæ¨¡æ€æ¡†ä¸­ï¼‰
        document.getElementById('cancelCourseBtn').addEventListener('click', function() {
            if (selectedCourse) {
                cancelSelection(selectedCourse.id);
            }
        });
    }

    // æ‰§è¡Œç­›é€‰
    function performFilter() {
        const status = document.getElementById('statusFilter').value;
        const collegeId = document.getElementById('collegeFilter').value;

        filteredCourses = myCourses.filter(selection => {
            let match = true;

            if (status) {
                match = match && selection.status == status;
            }

            if (collegeId) {
                match = match && selection.course.college?.id == collegeId;
            }

            return match;
        });

        renderCourseList();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('collegeFilter').value = '';
        filteredCourses = [...myCourses];
        renderCourseList();
    }

    // æ˜¾ç¤ºè¯¾ç¨‹è¯¦æƒ…
    function showCourseDetail(courseId) {
        const selection = myCourses.find(s => s.course.id === courseId);
        if (!selection) return;

        const course = selection.course;
        selectedCourse = course;
        const status = getSelectionStatus(selection);

        document.getElementById('courseDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>${course.name}</h5>
                            <span class="badge ${getStatusClass(selection).badge}">${status.text}</span>
                        </div>
                        <hr>
                    </div>
                    <div class="col-md-6">
                        <p><strong>è¯¾ç¨‹ç¼–ç ï¼š</strong>${course.courseCode}</p>
                        <p><strong>å­¦åˆ†ï¼š</strong>${course.credits}</p>
                        <p><strong>æœ€å¤§é€‰è¯¾äººæ•°ï¼š</strong>${course.maxStudents}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>æˆè¯¾æ•™å¸ˆï¼š</strong>${course.teacher?.name || 'å¾…å®š'}</p>
                        <p><strong>å¼€è¯¾å­¦é™¢ï¼š</strong>${course.college?.name || 'æœªçŸ¥'}</p>
                        <p><strong>é€‰è¯¾æ—¶é—´ï¼š</strong>${Utils.formatDate(selection.gmtCreate, 'YYYY-MM-DD HH:mm')}</p>
                    </div>
                    <div class="col-12">
                        <p><strong>è¯¾ç¨‹æè¿°ï¼š</strong></p>
                        <p>${course.description || 'æš‚æ— æè¿°'}</p>
                    </div>
                    ${status.description ? `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>çŠ¶æ€è¯´æ˜ï¼š</strong>${status.description}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

        // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®ï¼ˆä»…ç”³è¯·ä¸­çŠ¶æ€ï¼‰
        const cancelBtn = document.getElementById('cancelCourseBtn');
        if (selection.status === 1) {
            cancelBtn.style.display = 'inline-block';
        } else {
            cancelBtn.style.display = 'none';
        }

        Utils.showModal(document.getElementById('courseDetailModal'));
    }

    // å–æ¶ˆé€‰è¯¾
    async function cancelSelection(courseId) {
        Utils.confirm('ç¡®å®šè¦å–æ¶ˆé€‰æ‹©è¿™é—¨è¯¾ç¨‹å—ï¼Ÿ', async () => {
            try {
                const response = await API.CourseSelection.cancelSelection(courseId);
                if (response.code === 200) {
                    Utils.showMessage('å–æ¶ˆé€‰è¯¾æˆåŠŸ', 'success');
                    await loadMyCourses();
                    renderCourseList();
                    updateStatistics();
                    updateCreditStats();
                    closeModal();
                } else {
                    Utils.showMessage('å–æ¶ˆå¤±è´¥: ' + response.message, 'danger');
                }
            } catch (error) {
                console.error('Cancel selection error:', error);
                Utils.showMessage('å–æ¶ˆå¤±è´¥: ' + error.message, 'danger');
            }
        });
    }

    // å¯¼å‡ºè¯¾ç¨‹è¡¨
    function exportCourseSchedule() {
        if (myCourses.length === 0) {
            Utils.showMessage('æ²¡æœ‰è¯¾ç¨‹æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }

        const selectedCourses = myCourses.filter(s => s.status === 2 && s.lotteryResult === 1);

        let csvContent = 'è¯¾ç¨‹ç¼–ç ,è¯¾ç¨‹åç§°,å­¦åˆ†,æˆè¯¾æ•™å¸ˆ,å¼€è¯¾å­¦é™¢,é€‰è¯¾çŠ¶æ€\n';

        myCourses.forEach(selection => {
            const course = selection.course;
            const status = getSelectionStatus(selection);
            csvContent += `${course.courseCode},${course.name},${course.credits},${course.teacher?.name || ''},${course.college?.name || ''},${status.text}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `æˆ‘çš„è¯¾ç¨‹è¡¨_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('è¯¾ç¨‹è¡¨å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        selectedCourse = null;
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.showCourseDetail = showCourseDetail;
    window.cancelSelection = cancelSelection;
    window.closeModal = closeModal;
</script>
</body>
</html>