<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©æŸ¥è¯¢ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">é€‰è¯¾ç³»ç»Ÿ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">æˆç»©æŸ¥è¯¢</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">æˆç»©æŸ¥è¯¢</h1>
                <p class="page-description">æŸ¥çœ‹æ‚¨çš„è¯¾ç¨‹æˆç»©å’Œå­¦ä¹ æƒ…å†µ</p>
            </div>

            <!-- æˆç»©ç»Ÿè®¡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“Š</div>
                    <div class="stat-value" id="totalSubjects">0</div>
                    <div class="stat-label">æ€»ç§‘ç›®æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="passedSubjects">0</div>
                    <div class="stat-label">åŠæ ¼ç§‘ç›®</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">ğŸ¯</div>
                    <div class="stat-value" id="averageScore">0</div>
                    <div class="stat-label">å¹³å‡åˆ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9b59b6; color: white;">ğŸ†</div>
                    <div class="stat-value" id="totalCredits">0</div>
                    <div class="stat-label">è·å¾—å­¦åˆ†</div>
                </div>
            </div>

            <!-- ç­›é€‰å·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">å¼€è¯¾å­¦é™¢</label>
                                <select class="form-select" id="collegeFilter">
                                    <option value="">å…¨éƒ¨å­¦é™¢</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">æˆç»©çŠ¶æ€</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="excellent">ä¼˜ç§€(90+)</option>
                                    <option value="good">è‰¯å¥½(80-89)</option>
                                    <option value="average">ä¸­ç­‰(70-79)</option>
                                    <option value="pass">åŠæ ¼(60-69)</option>
                                    <option value="fail">ä¸åŠæ ¼(<60)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">å­¦åˆ†</label>
                                <select class="form-select" id="creditFilter">
                                    <option value="">å…¨éƒ¨å­¦åˆ†</option>
                                    <option value="1">1å­¦åˆ†</option>
                                    <option value="2">2å­¦åˆ†</option>
                                    <option value="3">3å­¦åˆ†</option>
                                    <option value="4">4å­¦åˆ†</option>
                                    <option value="5">5å­¦åˆ†åŠä»¥ä¸Š</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" id="filterBtn">ç­›é€‰</button>
                                    <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆç»©åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>æˆ‘çš„æˆç»©</h5>
                    <div>
                        <button class="btn btn-success" id="exportBtn">
                            ğŸ“Š å¯¼å‡ºæˆç»©å•
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="scoresContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</div>
                        <h5>æš‚æ— æˆç»©è®°å½•</h5>
                        <p class="text-muted">æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è¯¾ç¨‹æˆç»©</p>
                    </div>
                </div>
            </div>

            <!-- æˆç»©åˆ†å¸ƒå›¾è¡¨ -->
            <div class="card" id="chartCard" style="display: none;">
                <div class="card-header">
                    <h5>æˆç»©åˆ†å¸ƒ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="scoreDistributionChart" width="400" height="300"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="creditDistributionChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GPAè®¡ç®— -->
            <div class="card" id="gpaCard" style="display: none;">
                <div class="card-header">
                    <h5>å­¦åˆ†ç»©ç‚¹(GPA)è®¡ç®—</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ç»©ç‚¹è¯´æ˜</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                    <tr>
                                        <th>åˆ†æ•°æ®µ</th>
                                        <th>ç­‰çº§</th>
                                        <th>ç»©ç‚¹</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td>90-100</td><td>A</td><td>4.0</td></tr>
                                    <tr><td>85-89</td><td>A-</td><td>3.7</td></tr>
                                    <tr><td>82-84</td><td>B+</td><td>3.3</td></tr>
                                    <tr><td>78-81</td><td>B</td><td>3.0</td></tr>
                                    <tr><td>75-77</td><td>B-</td><td>2.7</td></tr>
                                    <tr><td>71-74</td><td>C+</td><td>2.3</td></tr>
                                    <tr><td>66-70</td><td>C</td><td>2.0</td></tr>
                                    <tr><td>62-65</td><td>C-</td><td>1.7</td></tr>
                                    <tr><td>60-61</td><td>D</td><td>1.0</td></tr>
                                    <tr><td><60</td><td>F</td><td>0.0</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>æˆ‘çš„GPAç»Ÿè®¡</h6>
                            <div class="gpa-stats">
                                <div class="stat-item">
                                    <div class="stat-label">æ€»GPA:</div>
                                    <div class="stat-value" id="overallGPA">0.00</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">åŠ æƒå¹³å‡åˆ†:</div>
                                    <div class="stat-value" id="weightedAverage">0.00</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">æ€»å­¦åˆ†:</div>
                                    <div class="stat-value" id="totalCreditsGPA">0</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">æœ‰æ•ˆå­¦åˆ†:</div>
                                    <div class="stat-value" id="validCredits">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentStudent = null;
    let myScores = [];
    let filteredScores = [];
    let colleges = [];

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isStudent()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            // è·å–å½“å‰å­¦ç”Ÿä¿¡æ¯
            const studentResponse = await API.Student.getCurrent();
            if (studentResponse.code === 200) {
                currentStudent = studentResponse.data;
            }

            // å¹¶è¡ŒåŠ è½½æ•°æ®
            await Promise.all([
                loadMyScores(),
                loadColleges()
            ]);

            renderCollegeFilter();
            renderScoreList();
            updateStatistics();
            renderCharts();
            calculateGPA();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æˆ‘çš„æˆç»©
    async function loadMyScores() {
        try {
            const response = await API.Score.getMy();
            if (response.code === 200) {
                myScores = response.data || [];
                filteredScores = [...myScores];
            }
        } catch (error) {
            console.error('Load my scores error:', error);
            throw error;
        }
    }

    // åŠ è½½å­¦é™¢åˆ—è¡¨
    async function loadColleges() {
        try {
            const response = await API.College.getAll();
            if (response.code === 200) {
                colleges = response.data || [];
            }
        } catch (error) {
            console.warn('Load colleges error:', error);
        }
    }

    // æ¸²æŸ“å­¦é™¢ç­›é€‰å™¨
    function renderCollegeFilter() {
        const collegeFilter = document.getElementById('collegeFilter');
        collegeFilter.innerHTML = '<option value="">å…¨éƒ¨å­¦é™¢</option>';

        colleges.forEach(college => {
            const option = document.createElement('option');
            option.value = college.id;
            option.textContent = college.name;
            collegeFilter.appendChild(option);
        });
    }

    // æ¸²æŸ“æˆç»©åˆ—è¡¨
    function renderScoreList() {
        const container = document.getElementById('scoresContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredScores.length === 0) {
            showEmptyState();
            return;
        }

        const columns = [
            {
                field: 'course',
                title: 'è¯¾ç¨‹ä¿¡æ¯',
                width: '30%',
                render: (value) => `
                        <div>
                            <div class="font-weight-bold">${value.name}</div>
                            <small class="text-muted">${value.courseCode} | ${value.credits}å­¦åˆ†</small>
                        </div>
                    `
            },
            {
                field: 'course',
                title: 'æˆè¯¾æ•™å¸ˆ',
                width: '15%',
                render: (value) => value.teacher?.name || 'æœªåˆ†é…'
            },
            {
                field: 'course',
                title: 'å¼€è¯¾å­¦é™¢',
                width: '15%',
                render: (value) => value.college?.name || 'æœªçŸ¥'
            },
            {
                field: 'score',
                title: 'æˆç»©',
                width: '15%',
                render: (value) => {
                    const grade = getScoreGrade(value);
                    return `
                            <div class="score-display">
                                <span class="score-value ${grade.class}">${value}</span>
                                <small class="d-block text-muted">${grade.letter}</small>
                            </div>
                        `;
                }
            },
            {
                field: 'score',
                title: 'ç»©ç‚¹',
                width: '10%',
                render: (value) => calculateGradePoint(value).toFixed(1)
            },
            {
                field: 'gmtCreate',
                title: 'å½•å…¥æ—¶é—´',
                width: '15%',
                render: (value) => Utils.formatDate(value, 'YYYY-MM-DD')
            }
        ];

        TableUtils.createTable(filteredScores, columns, container);

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        container.style.display = 'block';

        // æ˜¾ç¤ºå›¾è¡¨å’ŒGPAå¡ç‰‡
        document.getElementById('chartCard').style.display = 'block';
        document.getElementById('gpaCard').style.display = 'block';
    }

    // è·å–æˆç»©ç­‰çº§
    function getScoreGrade(score) {
        if (score >= 90) return { letter: 'A', class: 'text-success' };
        if (score >= 85) return { letter: 'A-', class: 'text-success' };
        if (score >= 82) return { letter: 'B+', class: 'text-info' };
        if (score >= 78) return { letter: 'B', class: 'text-info' };
        if (score >= 75) return { letter: 'B-', class: 'text-info' };
        if (score >= 71) return { letter: 'C+', class: 'text-warning' };
        if (score >= 66) return { letter: 'C', class: 'text-warning' };
        if (score >= 62) return { letter: 'C-', class: 'text-warning' };
        if (score >= 60) return { letter: 'D', class: 'text-secondary' };
        return { letter: 'F', class: 'text-danger' };
    }

    // è®¡ç®—ç»©ç‚¹
    function calculateGradePoint(score) {
        if (score >= 90) return 4.0;
        if (score >= 85) return 3.7;
        if (score >= 82) return 3.3;
        if (score >= 78) return 3.0;
        if (score >= 75) return 2.7;
        if (score >= 71) return 2.3;
        if (score >= 66) return 2.0;
        if (score >= 62) return 1.7;
        if (score >= 60) return 1.0;
        return 0.0;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = filteredScores.length;
        const passed = filteredScores.filter(s => s.score >= 60).length;
        const totalScore = filteredScores.reduce((sum, s) => sum + s.score, 0);
        const average = total > 0 ? (totalScore / total).toFixed(1) : 0;
        const credits = filteredScores
            .filter(s => s.score >= 60)
            .reduce((sum, s) => sum + s.course.credits, 0);

        document.getElementById('totalSubjects').textContent = total;
        document.getElementById('passedSubjects').textContent = passed;
        document.getElementById('averageScore').textContent = average;
        document.getElementById('totalCredits').textContent = credits;
    }

    // æ¸²æŸ“å›¾è¡¨
    function renderCharts() {
        if (filteredScores.length === 0) return;

        // æˆç»©åˆ†å¸ƒå›¾
        renderScoreDistributionChart();

        // å­¦åˆ†åˆ†å¸ƒå›¾
        renderCreditDistributionChart();
    }

    // æ¸²æŸ“æˆç»©åˆ†å¸ƒå›¾
    function renderScoreDistributionChart() {
        const canvas = document.getElementById('scoreDistributionChart');
        const ctx = canvas.getContext('2d');

        // ç»Ÿè®¡å„åˆ†æ•°æ®µæ•°é‡
        const ranges = {
            '90-100': 0,
            '80-89': 0,
            '70-79': 0,
            '60-69': 0,
            '<60': 0
        };

        filteredScores.forEach(score => {
            if (score.score >= 90) ranges['90-100']++;
            else if (score.score >= 80) ranges['80-89']++;
            else if (score.score >= 70) ranges['70-79']++;
            else if (score.score >= 60) ranges['60-69']++;
            else ranges['<60']++;
        });

        // ç»˜åˆ¶æŸ±çŠ¶å›¾
        const labels = Object.keys(ranges);
        const data = Object.values(ranges);
        const colors = ['#27ae60', '#2ecc71', '#f39c12', '#e67e22', '#e74c3c'];

        drawBarChart(ctx, canvas, labels, data, colors, 'æˆç»©åˆ†å¸ƒ');
    }

    // æ¸²æŸ“å­¦åˆ†åˆ†å¸ƒå›¾
    function renderCreditDistributionChart() {
        const canvas = document.getElementById('creditDistributionChart');
        const ctx = canvas.getContext('2d');

        // ç»Ÿè®¡å„å­¦åˆ†è¯¾ç¨‹æ•°é‡
        const credits = {};
        filteredScores.forEach(score => {
            const credit = score.course.credits;
            credits[credit] = (credits[credit] || 0) + 1;
        });

        const labels = Object.keys(credits).map(c => c + 'å­¦åˆ†');
        const data = Object.values(credits);
        const colors = ['#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#27ae60'];

        drawPieChart(ctx, canvas, labels, data, colors, 'å­¦åˆ†åˆ†å¸ƒ');
    }

    // ç»˜åˆ¶æŸ±çŠ¶å›¾
    function drawBarChart(ctx, canvas, labels, data, colors, title) {
        const padding = 40;
        const chartWidth = canvas.width - 2 * padding;
        const chartHeight = canvas.height - 2 * padding - 40;
        const barWidth = chartWidth / labels.length * 0.8;
        const maxValue = Math.max(...data);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶æ ‡é¢˜
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(title, canvas.width / 2, 25);

        // ç»˜åˆ¶æŸ±çŠ¶å›¾
        labels.forEach((label, index) => {
            const value = data[index];
            const barHeight = maxValue > 0 ? (value / maxValue) * chartHeight : 0;
            const x = padding + index * (chartWidth / labels.length) + (chartWidth / labels.length - barWidth) / 2;
            const y = padding + 40 + chartHeight - barHeight;

            // ç»˜åˆ¶æŸ±å­
            ctx.fillStyle = colors[index % colors.length];
            ctx.fillRect(x, y, barWidth, barHeight);

            // ç»˜åˆ¶æ•°å€¼
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(value, x + barWidth / 2, y - 5);

            // ç»˜åˆ¶æ ‡ç­¾
            ctx.fillText(label, x + barWidth / 2, padding + 40 + chartHeight + 20);
        });
    }

    // ç»˜åˆ¶é¥¼å›¾
    function drawPieChart(ctx, canvas, labels, data, colors, title) {
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(canvas.width, canvas.height) / 2 - 60;
        const total = data.reduce((sum, value) => sum + value, 0);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶æ ‡é¢˜
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(title, centerX, 25);

        if (total === 0) return;

        let currentAngle = -Math.PI / 2;

        data.forEach((value, index) => {
            const sliceAngle = (value / total) * 2 * Math.PI;

            // ç»˜åˆ¶æ‰‡å½¢
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[index % colors.length];
            ctx.fill();

            // ç»˜åˆ¶æ ‡ç­¾
            if (value > 0) {
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);

                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${labels[index]}`, labelX, labelY);
                ctx.fillText(`${value}`, labelX, labelY + 15);
            }

            currentAngle += sliceAngle;
        });
    }

    // è®¡ç®—GPA
    function calculateGPA() {
        if (myScores.length === 0) return;

        let totalPoints = 0;
        let totalCredits = 0;
        let totalWeightedScore = 0;
        let validCredits = 0;

        myScores.forEach(score => {
            const credits = score.course.credits;
            const gradePoint = calculateGradePoint(score.score);

            totalPoints += gradePoint * credits;
            totalCredits += credits;
            totalWeightedScore += score.score * credits;

            if (score.score >= 60) {
                validCredits += credits;
            }
        });

        const overallGPA = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';
        const weightedAverage = totalCredits > 0 ? (totalWeightedScore / totalCredits).toFixed(2) : '0.00';

        document.getElementById('overallGPA').textContent = overallGPA;
        document.getElementById('weightedAverage').textContent = weightedAverage;
        document.getElementById('totalCreditsGPA').textContent = totalCredits;
        document.getElementById('validCredits').textContent = validCredits;
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('scoresContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
        document.getElementById('chartCard').style.display = 'none';
        document.getElementById('gpaCard').style.display = 'none';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // ç­›é€‰åŠŸèƒ½
        document.getElementById('filterBtn').addEventListener('click', performFilter);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // å¯¼å‡ºåŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', exportScores);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œç­›é€‰
    function performFilter() {
        const collegeId = document.getElementById('collegeFilter').value;
        const status = document.getElementById('statusFilter').value;
        const credit = document.getElementById('creditFilter').value;

        filteredScores = myScores.filter(score => {
            let match = true;

            if (collegeId) {
                match = match && score.course.college?.id == collegeId;
            }

            if (status) {
                switch (status) {
                    case 'excellent':
                        match = match && score.score >= 90;
                        break;
                    case 'good':
                        match = match && score.score >= 80 && score.score < 90;
                        break;
                    case 'average':
                        match = match && score.score >= 70 && score.score < 80;
                        break;
                    case 'pass':
                        match = match && score.score >= 60 && score.score < 70;
                        break;
                    case 'fail':
                        match = match && score.score < 60;
                        break;
                }
            }

            if (credit) {
                if (credit === '5') {
                    match = match && score.course.credits >= 5;
                } else {
                    match = match && score.course.credits == credit;
                }
            }

            return match;
        });

        renderScoreList();
        updateStatistics();
        renderCharts();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('collegeFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('creditFilter').value = '';

        filteredScores = [...myScores];
        renderScoreList();
        updateStatistics();
        renderCharts();
    }

    // å¯¼å‡ºæˆç»©
    function exportScores() {
        if (myScores.length === 0) {
            Utils.showMessage('æ²¡æœ‰æˆç»©æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }

        let csvContent = 'è¯¾ç¨‹ç¼–ç ,è¯¾ç¨‹åç§°,æˆè¯¾æ•™å¸ˆ,å¼€è¯¾å­¦é™¢,å­¦åˆ†,æˆç»©,ç­‰çº§,ç»©ç‚¹,å½•å…¥æ—¶é—´\n';

        myScores.forEach(score => {
            const course = score.course;
            const grade = getScoreGrade(score.score);
            const gradePoint = calculateGradePoint(score.score);

            csvContent += `${course.courseCode},${course.name},${course.teacher?.name || ''},${course.college?.name || ''},${course.credits},${score.score},${grade.letter},${gradePoint.toFixed(1)},${Utils.formatDate(score.gmtCreate, 'YYYY-MM-DD')}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `æˆç»©å•_${currentStudent?.name || 'å­¦ç”Ÿ'}_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('æˆç»©å•å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
            .score-display .score-value {
                font-size: 18px;
                font-weight: bold;
            }

            .gpa-stats {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
            }

            .stat-item .stat-label {
                font-weight: 600;
                color: #555;
            }

            .stat-item .stat-value {
                font-size: 18px;
                font-weight: bold;
                color: #007bff;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>