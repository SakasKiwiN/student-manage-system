<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ä»¶ä¸‹è½½ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">é€‰è¯¾ç³»ç»Ÿ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">è¯¾ä»¶ä¸‹è½½</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">è¯¾ä»¶ä¸‹è½½</h1>
                <p class="page-description">ä¸‹è½½æ‚¨å·²é€‰è¯¾ç¨‹çš„å­¦ä¹ èµ„æ–™å’Œè¯¾ä»¶</p>
            </div>

            <!-- è¯¾ç¨‹ç­›é€‰ -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">é€‰æ‹©è¯¾ç¨‹</label>
                                <select class="form-select" id="courseSelect">
                                    <option value="">å…¨éƒ¨è¯¾ç¨‹</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">æ–‡ä»¶ç±»å‹</label>
                                <select class="form-select" id="fileTypeFilter">
                                    <option value="">å…¨éƒ¨ç±»å‹</option>
                                    <option value="ppt">PPT/PPTX</option>
                                    <option value="pdf">PDF</option>
                                    <option value="doc">DOC/DOCX</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" id="filterBtn">ç­›é€‰</button>
                                    <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¾ä»¶åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>è¯¾ä»¶èµ„æ–™</h5>
                    <div>
                        <span class="text-muted" id="totalCount">å…± 0 ä¸ªæ–‡ä»¶</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="coursewaresContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                        <h5>æš‚æ— è¯¾ä»¶èµ„æ–™</h5>
                        <p class="text-muted">æ‚¨é€‰æ‹©çš„è¯¾ç¨‹è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•è¯¾ä»¶</p>
                    </div>
                </div>
            </div>

            <!-- ä¸‹è½½ç»Ÿè®¡ -->
            <div class="card" id="statsCard" style="display: none;">
                <div class="card-header">
                    <h5>ä¸‹è½½ç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-primary" id="totalFiles">0</div>
                                <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-success" id="totalSize">0 MB</div>
                                <div class="stat-label">æ€»å¤§å°</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-info" id="courseCount">0</div>
                                <div class="stat-label">è¯¾ç¨‹æ•°</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-warning" id="recentFiles">0</div>
                                <div class="stat-label">æœ¬å‘¨æ–°å¢</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentStudent = null;
    let myCourses = [];
    let allCoursewares = [];
    let filteredCoursewares = [];

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isStudent()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            // è·å–å½“å‰å­¦ç”Ÿä¿¡æ¯
            const studentResponse = await API.Student.getCurrent();
            if (studentResponse.code === 200) {
                currentStudent = studentResponse.data;
            }

            // è·å–å·²é€‰è¯¾ç¨‹
            await loadMyCourses();

            // åŠ è½½æ‰€æœ‰è¯¾ä»¶
            await loadAllCoursewares();

            renderCourseSelect();
            renderCoursewareList();
            updateStatistics();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æˆ‘çš„è¯¾ç¨‹
    async function loadMyCourses() {
        try {
            const response = await API.CourseSelection.getMySelections();
            if (response.code === 200) {
                // åªè·å–å·²ä¸­ç­¾çš„è¯¾ç¨‹
                myCourses = response.data
                    .filter(s => s.status === 2 && s.lotteryResult === 1)
                    .map(s => s.course);
            }
        } catch (error) {
            console.error('Load my courses error:', error);
            throw error;
        }
    }

    // åŠ è½½æ‰€æœ‰è¯¾ä»¶
    async function loadAllCoursewares() {
        try {
            allCoursewares = [];

            // ä¸ºæ¯ä¸ªè¯¾ç¨‹åŠ è½½è¯¾ä»¶
            for (const course of myCourses) {
                const response = await API.Courseware.getByCourse(course.id);
                if (response.code === 200) {
                    const coursewares = response.data.map(cw => ({
                        ...cw,
                        course: course
                    }));
                    allCoursewares.push(...coursewares);
                }
            }

            filteredCoursewares = [...allCoursewares];
        } catch (error) {
            console.error('Load coursewares error:', error);
            throw error;
        }
    }

    // æ¸²æŸ“è¯¾ç¨‹é€‰æ‹©å™¨
    function renderCourseSelect() {
        const courseSelect = document.getElementById('courseSelect');
        courseSelect.innerHTML = '<option value="">å…¨éƒ¨è¯¾ç¨‹</option>';

        myCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = `${course.name} (${course.courseCode})`;
            courseSelect.appendChild(option);
        });
    }

    // æ¸²æŸ“è¯¾ä»¶åˆ—è¡¨
    function renderCoursewareList() {
        const container = document.getElementById('coursewaresContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        document.getElementById('totalCount').textContent = `å…± ${filteredCoursewares.length} ä¸ªæ–‡ä»¶`;

        if (filteredCoursewares.length === 0) {
            showEmptyState();
            return;
        }

        // æŒ‰è¯¾ç¨‹åˆ†ç»„æ˜¾ç¤º
        const coursewaresByCourse = groupBy(filteredCoursewares, 'course.id');

        let html = '';
        Object.entries(coursewaresByCourse).forEach(([courseId, coursewares]) => {
            const course = coursewares[0].course;

            html += `
                    <div class="course-section mb-4">
                        <div class="course-header">
                            <h6 class="course-title">
                                ğŸ“š ${course.name}
                                <span class="badge bg-primary ms-2">${coursewares.length} ä¸ªæ–‡ä»¶</span>
                            </h6>
                            <small class="text-muted">
                                è¯¾ç¨‹ç¼–ç ï¼š${course.courseCode} | æˆè¯¾æ•™å¸ˆï¼š${course.teacher?.name || 'æœªåˆ†é…'}
                            </small>
                        </div>
                        <div class="courseware-grid">
                `;

            coursewares.forEach(courseware => {
                const fileInfo = getFileInfo(courseware.title);
                const sizeText = formatFileSize(courseware.fileSize);
                const uploadDate = Utils.formatDate(courseware.uploadTime, 'YYYY-MM-DD');

                html += `
                        <div class="courseware-card">
                            <div class="file-icon ${fileInfo.type}">
                                ${fileInfo.icon}
                            </div>
                            <div class="file-info">
                                <div class="file-title" title="${courseware.title}">
                                    ${truncateText(courseware.title, 30)}
                                </div>
                                <div class="file-meta">
                                    <small class="text-muted">
                                        ${sizeText} | ${uploadDate}
                                    </small>
                                </div>
                                <div class="file-actions mt-2">
                                    <button class="btn btn-primary btn-sm" onclick="downloadCourseware(${courseware.id}, '${courseware.title}')">
                                        ğŸ“¥ ä¸‹è½½
                                    </button>
                                    <button class="btn btn-outline-info btn-sm ml-2" onclick="previewCourseware(${courseware.id})">
                                        ğŸ‘ï¸ é¢„è§ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
            });

            html += `
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        container.style.display = 'block';
        document.getElementById('statsCard').style.display = 'block';
    }

    // æ ¹æ®å­—æ®µåˆ†ç»„
    function groupBy(array, key) {
        return array.reduce((groups, item) => {
            const value = key.split('.').reduce((obj, k) => obj[k], item);
            groups[value] = groups[value] || [];
            groups[value].push(item);
            return groups;
        }, {});
    }

    // è·å–æ–‡ä»¶ä¿¡æ¯
    function getFileInfo(filename) {
        const ext = filename.split('.').pop().toLowerCase();

        switch (ext) {
            case 'pdf':
                return { type: 'pdf', icon: 'ğŸ“„' };
            case 'ppt':
            case 'pptx':
                return { type: 'ppt', icon: 'ğŸ“Š' };
            case 'doc':
            case 'docx':
                return { type: 'doc', icon: 'ğŸ“' };
            case 'xls':
            case 'xlsx':
                return { type: 'excel', icon: 'ğŸ“ˆ' };
            case 'txt':
                return { type: 'txt', icon: 'ğŸ“ƒ' };
            case 'zip':
            case 'rar':
                return { type: 'archive', icon: 'ğŸ“¦' };
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif':
                return { type: 'image', icon: 'ğŸ–¼ï¸' };
            case 'mp4':
            case 'avi':
            case 'mov':
                return { type: 'video', icon: 'ğŸ¥' };
            case 'mp3':
            case 'wav':
                return { type: 'audio', icon: 'ğŸµ' };
            default:
                return { type: 'other', icon: 'ğŸ“' };
        }
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // æˆªæ–­æ–‡æœ¬
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const totalFiles = filteredCoursewares.length;
        const totalBytes = filteredCoursewares.reduce((sum, cw) => sum + cw.fileSize, 0);
        const totalSize = formatFileSize(totalBytes);
        const courseCount = new Set(filteredCoursewares.map(cw => cw.course.id)).size;

        // è®¡ç®—æœ¬å‘¨æ–°å¢æ–‡ä»¶
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const recentFiles = filteredCoursewares.filter(cw =>
            new Date(cw.uploadTime) > oneWeekAgo
        ).length;

        document.getElementById('totalFiles').textContent = totalFiles;
        document.getElementById('totalSize').textContent = totalSize;
        document.getElementById('courseCount').textContent = courseCount;
        document.getElementById('recentFiles').textContent = recentFiles;
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('coursewaresContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
        document.getElementById('statsCard').style.display = 'none';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // ç­›é€‰åŠŸèƒ½
        document.getElementById('filterBtn').addEventListener('click', performFilter);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œç­›é€‰
    function performFilter() {
        const courseId = document.getElementById('courseSelect').value;
        const fileType = document.getElementById('fileTypeFilter').value;

        filteredCoursewares = allCoursewares.filter(courseware => {
            let match = true;

            if (courseId) {
                match = match && courseware.course.id == courseId;
            }

            if (fileType) {
                const ext = courseware.title.split('.').pop().toLowerCase();
                switch (fileType) {
                    case 'ppt':
                        match = match && ['ppt', 'pptx'].includes(ext);
                        break;
                    case 'pdf':
                        match = match && ext === 'pdf';
                        break;
                    case 'doc':
                        match = match && ['doc', 'docx'].includes(ext);
                        break;
                    case 'other':
                        match = match && !['ppt', 'pptx', 'pdf', 'doc', 'docx'].includes(ext);
                        break;
                }
            }

            return match;
        });

        renderCoursewareList();
        updateStatistics();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('courseSelect').value = '';
        document.getElementById('fileTypeFilter').value = '';

        filteredCoursewares = [...allCoursewares];
        renderCoursewareList();
        updateStatistics();
    }

    // ä¸‹è½½è¯¾ä»¶
    async function downloadCourseware(coursewareId, filename) {
        try {
            Utils.showMessage('å¼€å§‹ä¸‹è½½...', 'info');
            await API.Courseware.download(coursewareId, filename);
            Utils.showMessage('ä¸‹è½½å®Œæˆ', 'success');
        } catch (error) {
            console.error('Download courseware error:', error);
            Utils.showMessage('ä¸‹è½½å¤±è´¥: ' + error.message, 'danger');
        }
    }

    // é¢„è§ˆè¯¾ä»¶
    function previewCourseware(coursewareId) {
        // è¿™é‡Œå¯ä»¥å®ç°æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        Utils.showMessage('é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.downloadCourseware = downloadCourseware;
    window.previewCourseware = previewCourseware;

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
            .course-section {
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 20px;
                background: white;
            }

            .course-header {
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #f0f0f0;
            }

            .course-title {
                margin: 0;
                color: #333;
                font-weight: 600;
            }

            .courseware-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 15px;
            }

            .courseware-card {
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                background: #f8f9fa;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .courseware-card:hover {
                border-color: #007bff;
                box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
            }

            .file-icon {
                font-size: 32px;
                min-width: 40px;
                text-align: center;
            }

            .file-info {
                flex: 1;
                min-width: 0;
            }

            .file-title {
                font-weight: 600;
                color: #333;
                margin-bottom: 5px;
                word-break: break-word;
            }

            .file-meta {
                margin-bottom: 10px;
            }

            .file-actions .btn {
                font-size: 12px;
                padding: 4px 8px;
            }

            .file-icon.pdf { color: #dc3545; }
            .file-icon.ppt { color: #fd7e14; }
            .file-icon.doc { color: #0d6efd; }
            .file-icon.excel { color: #198754; }
            .file-icon.image { color: #6f42c1; }
            .file-icon.video { color: #d63384; }
            .file-icon.audio { color: #20c997; }
            .file-icon.archive { color: #6c757d; }
            .file-icon.other { color: #adb5bd; }

            @media (max-width: 768px) {
                .courseware-grid {
                    grid-template-columns: 1fr;
                }

                .courseware-card {
                    flex-direction: column;
                    text-align: center;
                }

                .file-actions .btn {
                    width: 100%;
                    margin: 2px 0;
                }
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>