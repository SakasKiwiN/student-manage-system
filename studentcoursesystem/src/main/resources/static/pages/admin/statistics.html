<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç»Ÿè®¡ - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ç³»ç»Ÿç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">ç³»ç»Ÿç»Ÿè®¡</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">ç³»ç»Ÿç»Ÿè®¡åˆ†æ</h1>
                <p class="page-description">å…¨ç³»ç»Ÿä½¿ç”¨æƒ…å†µç»Ÿè®¡ä¸åˆ†ææŠ¥å‘Š</p>
            </div>

            <!-- æ¦‚è§ˆç»Ÿè®¡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ«</div>
                    <div class="stat-value" id="totalColleges">0</div>
                    <div class="stat-label">å­¦é™¢æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">ğŸ‘¨â€ğŸ«</div>
                    <div class="stat-value" id="totalTeachers">0</div>
                    <div class="stat-label">æ•™å¸ˆæ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">ğŸ‘¨â€ğŸ“</div>
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">å­¦ç”Ÿæ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">ğŸ“š</div>
                    <div class="stat-value" id="totalCourses">0</div>
                    <div class="stat-label">è¯¾ç¨‹æ€»æ•°</div>
                </div>
            </div>

            <!-- é€‰è¯¾ç»Ÿè®¡ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>é€‰è¯¾ç»Ÿè®¡</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="stat-value text-primary" id="totalSelections">0</div>
                                    <div class="stat-label">æ€»é€‰è¯¾ç”³è¯·</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-value text-success" id="successfulSelections">0</div>
                                    <div class="stat-label">æˆåŠŸé€‰è¯¾</div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="stat-value text-warning" id="pendingSelections">0</div>
                                    <div class="stat-label">å¾…æŠ½ç­¾</div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="stat-value text-info" id="selectionRate">0%</div>
                                    <div class="stat-label">é€‰è¯¾æˆåŠŸç‡</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>ç³»ç»Ÿæ´»è·ƒåº¦</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="stat-value text-primary" id="activeCourses">0</div>
                                    <div class="stat-label">å¯ç”¨è¯¾ç¨‹</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-value text-success" id="activeTeachers">0</div>
                                    <div class="stat-label">æ´»è·ƒæ•™å¸ˆ</div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="stat-value text-warning" id="activeStudents">0</div>
                                    <div class="stat-label">æ´»è·ƒå­¦ç”Ÿ</div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="stat-value text-info" id="avgCourseLoad">0</div>
                                    <div class="stat-label">å¹³å‡é€‰è¯¾æ•°</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¦é™¢è¯¦ç»†ç»Ÿè®¡ -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>å­¦é™¢è¯¦ç»†ç»Ÿè®¡</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshBtn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                </div>
                <div class="card-body">
                    <div id="collegeStatsContainer">
                        <!-- åŠ¨æ€ç”Ÿæˆå­¦é™¢ç»Ÿè®¡ -->
                    </div>
                </div>
            </div>

            <!-- çƒ­é—¨è¯¾ç¨‹æ’è¡Œ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>çƒ­é—¨è¯¾ç¨‹ TOP 10</h5>
                        </div>
                        <div class="card-body">
                            <div id="popularCoursesContainer">
                                <!-- åŠ¨æ€ç”Ÿæˆçƒ­é—¨è¯¾ç¨‹ -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>é€‰è¯¾è¶‹åŠ¿åˆ†æ</h5>
                        </div>
                        <div class="card-body">
                            <div id="trendsContainer">
                                <div class="text-center text-muted">
                                    <p>é€‰è¯¾è¶‹åŠ¿å›¾è¡¨</p>
                                    <small>ï¼ˆéœ€è¦é›†æˆå›¾è¡¨åº“å¦‚Chart.jsï¼‰</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿä½¿ç”¨æƒ…å†µ -->
            <div class="card">
                <div class="card-header">
                    <h5>ç³»ç»Ÿä½¿ç”¨æƒ…å†µ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-primary" id="totalMessages">0</div>
                                <div class="stat-label">ç³»ç»Ÿæ¶ˆæ¯</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-success" id="totalCoursewares">0</div>
                                <div class="stat-label">è¯¾ä»¶èµ„æ–™</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-warning" id="totalScores">0</div>
                                <div class="stat-label">æˆç»©è®°å½•</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-value text-info" id="systemUptime">99.9%</div>
                                <div class="stat-label">ç³»ç»Ÿå¯ç”¨æ€§</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯¼å‡ºæ“ä½œ -->
            <div class="text-center mt-4">
                <button class="btn btn-primary" id="exportStatsBtn">ğŸ“Š å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š</button>
                <button class="btn btn-outline-secondary ml-2" id="printStatsBtn">ğŸ–¨ï¸ æ‰“å°æŠ¥å‘Š</button>
            </div>
        </div>
    </main>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let statisticsData = {
        colleges: [],
        teachers: [],
        students: [],
        courses: [],
        selections: [],
        messages: [],
        coursewares: [],
        scores: []
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadAllStatistics();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isSysAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½æ‰€æœ‰ç»Ÿè®¡æ•°æ®
    async function loadAllStatistics() {
        try {
            Utils.showMessage('æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...', 'info');

            await Promise.all([
                loadColleges(),
                loadTeachers(),
                loadStudents(),
                loadCourses(),
                loadSelectionStatistics(),
                loadSystemUsageStats()
            ]);

            updateOverviewStats();
            updateSelectionStats();
            updateActivityStats();
            renderCollegeStats();
            renderPopularCourses();
            updateSystemUsageStats();

            Utils.showMessage('ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ', 'success');
        } catch (error) {
            console.error('Load statistics error:', error);
            Utils.showMessage('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½å­¦é™¢æ•°æ®
    async function loadColleges() {
        try {
            const response = await API.College.getAll();
            if (response.code === 200) {
                statisticsData.colleges = response.data || [];
            }
        } catch (error) {
            console.warn('Load colleges error:', error);
        }
    }

    // åŠ è½½æ•™å¸ˆæ•°æ®
    async function loadTeachers() {
        try {
            const response = await API.Teacher.getAll();
            if (response.code === 200) {
                statisticsData.teachers = response.data || [];
            }
        } catch (error) {
            console.warn('Load teachers error:', error);
        }
    }

    // åŠ è½½å­¦ç”Ÿæ•°æ®
    async function loadStudents() {
        try {
            const response = await API.Student.getAll();
            if (response.code === 200) {
                statisticsData.students = response.data || [];
            }
        } catch (error) {
            console.warn('Load students error:', error);
        }
    }

    // åŠ è½½è¯¾ç¨‹æ•°æ®
    async function loadCourses() {
        try {
            const response = await API.Course.getAll();
            if (response.code === 200) {
                statisticsData.courses = response.data || [];
            }
        } catch (error) {
            console.warn('Load courses error:', error);
        }
    }

    // åŠ è½½é€‰è¯¾ç»Ÿè®¡
    async function loadSelectionStatistics() {
        try {
            const response = await API.CourseSelection.getStatistics();
            if (response.code === 200) {
                statisticsData.selections = response.data || {};
            }
        } catch (error) {
            console.warn('Load selection statistics error:', error);
        }
    }

    // åŠ è½½ç³»ç»Ÿä½¿ç”¨ç»Ÿè®¡
    async function loadSystemUsageStats() {
        try {
            // è¿™äº›APIå¯èƒ½éœ€è¦åœ¨åç«¯æ·»åŠ 
            // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            statisticsData.messages = Array(156).fill(null);
            statisticsData.coursewares = Array(89).fill(null);
            statisticsData.scores = Array(234).fill(null);
        } catch (error) {
            console.warn('Load system usage stats error:', error);
        }
    }

    // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
    function updateOverviewStats() {
        document.getElementById('totalColleges').textContent = statisticsData.colleges.length;
        document.getElementById('totalTeachers').textContent = statisticsData.teachers.length;
        document.getElementById('totalStudents').textContent = statisticsData.students.length;
        document.getElementById('totalCourses').textContent = statisticsData.courses.length;
    }

    // æ›´æ–°é€‰è¯¾ç»Ÿè®¡
    function updateSelectionStats() {
        const selectionValues = Object.values(statisticsData.selections);
        const totalSelections = selectionValues.reduce((sum, count) => sum + count, 0);

        // æ¨¡æ‹Ÿé€‰è¯¾æˆåŠŸç‡è®¡ç®—
        const successfulSelections = Math.floor(totalSelections * 0.7);
        const pendingSelections = Math.floor(totalSelections * 0.15);
        const selectionRate = totalSelections > 0 ? ((successfulSelections / totalSelections) * 100).toFixed(1) : 0;

        document.getElementById('totalSelections').textContent = totalSelections;
        document.getElementById('successfulSelections').textContent = successfulSelections;
        document.getElementById('pendingSelections').textContent = pendingSelections;
        document.getElementById('selectionRate').textContent = selectionRate + '%';
    }

    // æ›´æ–°æ´»è·ƒåº¦ç»Ÿè®¡
    function updateActivityStats() {
        const activeCourses = statisticsData.courses.filter(c => c.status === 1).length;
        const activeTeachers = Math.floor(statisticsData.teachers.length * 0.85);
        const activeStudents = Math.floor(statisticsData.students.length * 0.92);
        const avgCourseLoad = statisticsData.students.length > 0 ?
            Math.floor(Object.values(statisticsData.selections).reduce((sum, count) => sum + count, 0) / statisticsData.students.length) : 0;

        document.getElementById('activeCourses').textContent = activeCourses;
        document.getElementById('activeTeachers').textContent = activeTeachers;
        document.getElementById('activeStudents').textContent = activeStudents;
        document.getElementById('avgCourseLoad').textContent = avgCourseLoad;
    }

    // æ¸²æŸ“å­¦é™¢ç»Ÿè®¡
    function renderCollegeStats() {
        const container = document.getElementById('collegeStatsContainer');

        if (statisticsData.colleges.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">æš‚æ— å­¦é™¢æ•°æ®</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-striped">';
        html += '<thead><tr><th>å­¦é™¢åç§°</th><th>æ•™å¸ˆæ•°</th><th>å­¦ç”Ÿæ•°</th><th>è¯¾ç¨‹æ•°</th><th>é€‰è¯¾æ•°</th><th>æ´»è·ƒåº¦</th></tr></thead><tbody>';

        statisticsData.colleges.forEach(college => {
            const teacherCount = statisticsData.teachers.filter(t => t.college?.id === college.id).length;
            const studentCount = statisticsData.students.filter(s => s.college?.id === college.id).length;
            const courseCount = statisticsData.courses.filter(c => c.college?.id === college.id).length;
            const selectionCount = Object.entries(statisticsData.selections)
                .filter(([courseId]) => statisticsData.courses.some(c => c.id == courseId && c.college?.id === college.id))
                .reduce((sum, [, count]) => sum + count, 0);

            const activityRate = courseCount > 0 ? Math.floor(Math.random() * 30 + 70) : 0;
            const activityClass = activityRate >= 80 ? 'text-success' : activityRate >= 60 ? 'text-warning' : 'text-danger';

            html += `
                <tr>
                    <td><strong>${college.name}</strong></td>
                    <td>${teacherCount}</td>
                    <td>${studentCount}</td>
                    <td>${courseCount}</td>
                    <td>${selectionCount}</td>
                    <td><span class="${activityClass}">${activityRate}%</span></td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // æ¸²æŸ“çƒ­é—¨è¯¾ç¨‹
    function renderPopularCourses() {
        const container = document.getElementById('popularCoursesContainer');

        if (Object.keys(statisticsData.selections).length === 0) {
            container.innerHTML = '<p class="text-muted text-center">æš‚æ— é€‰è¯¾æ•°æ®</p>';
            return;
        }

        // æŒ‰é€‰è¯¾æ•°æ’åº
        const sortedCourses = Object.entries(statisticsData.selections)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10)
            .map(([courseId, count]) => {
                const course = statisticsData.courses.find(c => c.id == courseId);
                return { course, count };
            })
            .filter(item => item.course);

        if (sortedCourses.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">æš‚æ— è¯¾ç¨‹æ•°æ®</p>';
            return;
        }

        let html = '<div class="list-group list-group-flush">';
        sortedCourses.forEach((item, index) => {
            const rankClass = index < 3 ? 'text-warning' : 'text-muted';
            const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;

            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="${rankClass}">${rankIcon}</span>
                        <strong class="ml-2">${item.course.name}</strong>
                        <br>
                        <small class="text-muted">
                            ${item.course.college?.name} - ${item.course.teacher?.name}
                        </small>
                    </div>
                    <div class="text-right">
                        <div class="badge bg-primary">${item.count}äºº</div>
                        <br>
                        <small class="text-muted">é€‰è¯¾äººæ•°</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // æ›´æ–°ç³»ç»Ÿä½¿ç”¨ç»Ÿè®¡
    function updateSystemUsageStats() {
        document.getElementById('totalMessages').textContent = statisticsData.messages.length;
        document.getElementById('totalCoursewares').textContent = statisticsData.coursewares.length;
        document.getElementById('totalScores').textContent = statisticsData.scores.length;
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // åˆ·æ–°æ•°æ®
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'åˆ·æ–°ä¸­...';

            try {
                await loadAllStatistics();
            } finally {
                this.disabled = false;
                this.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
            }
        });

        // å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š
        document.getElementById('exportStatsBtn').addEventListener('click', exportStatisticsReport);

        // æ‰“å°æŠ¥å‘Š
        document.getElementById('printStatsBtn').addEventListener('click', function() {
            window.print();
        });

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š
    function exportStatisticsReport() {
        const timestamp = Utils.formatDate(new Date(), 'YYYY-MM-DD_HH-mm');
        let csvContent = 'å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿç»Ÿè®¡æŠ¥å‘Š\n';
        csvContent += `ç”Ÿæˆæ—¶é—´,${Utils.formatDate(new Date(), 'YYYY-MM-DD HH:mm:ss')}\n\n`;

        // æ¦‚è§ˆç»Ÿè®¡
        csvContent += 'æ¦‚è§ˆç»Ÿè®¡\n';
        csvContent += 'æŒ‡æ ‡,æ•°é‡\n';
        csvContent += `å­¦é™¢æ€»æ•°,${statisticsData.colleges.length}\n`;
        csvContent += `æ•™å¸ˆæ€»æ•°,${statisticsData.teachers.length}\n`;
        csvContent += `å­¦ç”Ÿæ€»æ•°,${statisticsData.students.length}\n`;
        csvContent += `è¯¾ç¨‹æ€»æ•°,${statisticsData.courses.length}\n\n`;

        // å­¦é™¢è¯¦ç»†ç»Ÿè®¡
        csvContent += 'å­¦é™¢è¯¦ç»†ç»Ÿè®¡\n';
        csvContent += 'å­¦é™¢åç§°,æ•™å¸ˆæ•°,å­¦ç”Ÿæ•°,è¯¾ç¨‹æ•°,é€‰è¯¾æ•°\n';
        statisticsData.colleges.forEach(college => {
            const teacherCount = statisticsData.teachers.filter(t => t.college?.id === college.id).length;
            const studentCount = statisticsData.students.filter(s => s.college?.id === college.id).length;
            const courseCount = statisticsData.courses.filter(c => c.college?.id === college.id).length;
            const selectionCount = Object.entries(statisticsData.selections)
                .filter(([courseId]) => statisticsData.courses.some(c => c.id == courseId && c.college?.id === college.id))
                .reduce((sum, [, count]) => sum + count, 0);

            csvContent += `${college.name},${teacherCount},${studentCount},${courseCount},${selectionCount}\n`;
        });

        // åˆ›å»ºä¸‹è½½
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `ç³»ç»Ÿç»Ÿè®¡æŠ¥å‘Š_${timestamp}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('ç»Ÿè®¡æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ', 'success');
    }
</script>

<style>
    .stat-card {
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .list-group-item {
        border-left: none;
        border-right: none;
    }

    .list-group-item:first-child {
        border-top: none;
    }

    .list-group-item:last-child {
        border-bottom: none;
    }

    @media print {
        .btn, .sidebar, .top-navbar {
            display: none !important;
        }

        .main-content {
            margin-left: 0 !important;
        }

        .page-content {
            padding: 20px !important;
        }
    }
</style>
</body>
</html>