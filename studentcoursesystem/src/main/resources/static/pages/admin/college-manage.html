<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦é™¢ç®¡ç† - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <!-- ä¾§è¾¹æ å ä½ï¼Œå®é™…ä¼šé€šè¿‡JSåŠ¨æ€æ’å…¥ -->
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ç³»ç»Ÿç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">å­¦é™¢ç®¡ç†</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">å­¦é™¢ç®¡ç†</h1>
                <p class="page-description">ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰å­¦é™¢ä¿¡æ¯</p>
            </div>

            <!-- æ“ä½œå·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <input type="text"
                                   class="form-control"
                                   id="searchInput"
                                   placeholder="æœç´¢å­¦é™¢åç§°æˆ–ç¼–ç ..."
                                   style="width: 300px;">
                            <button class="btn btn-primary ml-2" id="searchBtn">æœç´¢</button>
                        </div>
                        <button class="btn btn-success" id="addCollegeBtn">
                            <span>â•</span> æ·»åŠ å­¦é™¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- å­¦é™¢åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h5>å­¦é™¢åˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="tableContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <p class="text-muted">æš‚æ— å­¦é™¢æ•°æ®</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- å­¦é™¢ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal" id="collegeModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">æ·»åŠ å­¦é™¢</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="collegeForm">
                <input type="hidden" id="collegeId">
                <div class="form-group">
                    <label for="collegeName" class="form-label">å­¦é™¢åç§° *</label>
                    <input type="text"
                           class="form-control"
                           id="collegeName"
                           name="name"
                           required
                           placeholder="è¯·è¾“å…¥å­¦é™¢åç§°">
                </div>
                <div class="form-group">
                    <label for="collegeCode" class="form-label">å­¦é™¢ç¼–ç  *</label>
                    <input type="text"
                           class="form-control"
                           id="collegeCode"
                           name="code"
                           required
                           placeholder="è¯·è¾“å…¥å­¦é™¢ç¼–ç ï¼ˆå¦‚ï¼šCSï¼‰">
                    <small class="text-muted">å­¦é™¢ç¼–ç ç”¨äºç³»ç»Ÿå†…éƒ¨æ ‡è¯†ï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡ç¼©å†™</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="saveCollegeBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let colleges = [];
    let filteredColleges = [];
    let isEditing = false;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageStructure();
        loadColleges();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        // æ£€æŸ¥æƒé™
        if (!AuthManager.isSysAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢ç»“æ„
    function loadPageStructure() {
        // åŠ è½½ä¾§è¾¹æ å’Œé¡¶éƒ¨å¯¼èˆª
        const sidebar = document.getElementById('sidebar');
        const navbarRight = document.getElementById('navbarRight');

        // è¿™é‡Œåº”è¯¥æ’å…¥é€šç”¨çš„ä¾§è¾¹æ å’Œç”¨æˆ·ä¿¡æ¯
        // ä¸ºäº†ç®€åŒ–ï¼Œç›´æ¥æ·»åŠ åŸºæœ¬çš„ç”¨æˆ·ä¿¡æ¯
        navbarRight.innerHTML = `
                <div class="user-dropdown">
                    <button class="user-dropdown-toggle">
                        <div class="user-dropdown-avatar">ğŸ‘¤</div>
                        <span class="user-dropdown-name">${AuthManager.getCurrentUser()?.username || 'ç®¡ç†å‘˜'}</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="user-dropdown-menu">
                        <a href="/pages/common/profile.html" class="dropdown-item">ä¸ªäººä¿¡æ¯</a>
                        <a href="/pages/common/change-password.html" class="dropdown-item">ä¿®æ”¹å¯†ç </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" onclick="logout()">é€€å‡ºç™»å½•</button>
                    </div>
                </div>
            `;
    }

    // åŠ è½½å­¦é™¢åˆ—è¡¨
    async function loadColleges() {
        try {
            Utils.hideLoading();
            const loading = Utils.showLoading(document.getElementById('tableContainer').parentElement);

            const response = await API.College.getAll();

            Utils.hideLoading();

            if (response.code === 200) {
                colleges = response.data || [];
                filteredColleges = [...colleges];
                renderCollegeTable();
            } else {
                Utils.showMessage('åŠ è½½å­¦é™¢æ•°æ®å¤±è´¥: ' + response.message, 'danger');
                showEmptyState();
            }
        } catch (error) {
            Utils.hideLoading();
            console.error('Load colleges error:', error);
            Utils.showMessage('åŠ è½½å­¦é™¢æ•°æ®å¤±è´¥', 'danger');
            showEmptyState();
        }
    }

    // æ¸²æŸ“å­¦é™¢è¡¨æ ¼
    function renderCollegeTable() {
        const tableContainer = document.getElementById('tableContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredColleges.length === 0) {
            showEmptyState();
            return;
        }

        const columns = [
            { field: 'id', title: 'ID', width: '80px' },
            { field: 'name', title: 'å­¦é™¢åç§°' },
            { field: 'code', title: 'å­¦é™¢ç¼–ç ', width: '120px' },
            { field: 'gmtCreate', title: 'åˆ›å»ºæ—¶é—´', width: '180px', render: (value) => Utils.formatDate(value, 'YYYY-MM-DD HH:mm') },
            {
                field: 'actions',
                title: 'æ“ä½œ',
                width: '150px',
                render: (value, row) => `
                        <button class="btn btn-sm btn-warning" onclick="editCollege(${row.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger ml-1" onclick="deleteCollege(${row.id})">åˆ é™¤</button>
                    `
            }
        ];

        TableUtils.createTable(filteredColleges, columns, tableContainer);

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        tableContainer.style.display = 'block';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        const performSearch = () => {
            const keyword = searchInput.value.trim().toLowerCase();
            if (keyword) {
                filteredColleges = colleges.filter(college =>
                    college.name.toLowerCase().includes(keyword) ||
                    college.code.toLowerCase().includes(keyword)
                );
            } else {
                filteredColleges = [...colleges];
            }
            renderCollegeTable();
        };

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // æ·»åŠ å­¦é™¢
        document.getElementById('addCollegeBtn').addEventListener('click', () => {
            openCollegeModal();
        });

        // ä¿å­˜å­¦é™¢
        document.getElementById('saveCollegeBtn').addEventListener('click', () => {
            saveCollege();
        });

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰“å¼€å­¦é™¢ç¼–è¾‘æ¨¡æ€æ¡†
    function openCollegeModal(college = null) {
        isEditing = !!college;

        document.getElementById('modalTitle').textContent = isEditing ? 'ç¼–è¾‘å­¦é™¢' : 'æ·»åŠ å­¦é™¢';
        document.getElementById('collegeId').value = college?.id || '';
        document.getElementById('collegeName').value = college?.name || '';
        document.getElementById('collegeCode').value = college?.code || '';

        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œç¼–ç å­—æ®µåªè¯»
        document.getElementById('collegeCode').readOnly = isEditing;

        Utils.showModal(document.getElementById('collegeModal'));
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        document.getElementById('collegeForm').reset();

        // æ¸…é™¤éªŒè¯çŠ¶æ€
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => Utils.clearFieldError(field));
    }

    // ä¿å­˜å­¦é™¢
    async function saveCollege() {
        const form = document.getElementById('collegeForm');

        if (!Utils.validateForm(form)) {
            return;
        }

        const formData = FormUtils.serialize(form);
        const college = {
            name: formData.name.trim(),
            code: formData.code.trim().toUpperCase()
        };

        // éªŒè¯ç¼–ç æ ¼å¼
        if (!/^[A-Z]{2,10}$/.test(college.code)) {
            Utils.showFieldError(document.getElementById('collegeCode'), 'å­¦é™¢ç¼–ç å¿…é¡»æ˜¯2-10ä½å¤§å†™è‹±æ–‡å­—æ¯');
            return;
        }

        try {
            const saveBtn = document.getElementById('saveCollegeBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            let response;
            if (isEditing) {
                const collegeId = document.getElementById('collegeId').value;
                response = await API.College.update(collegeId, college);
            } else {
                response = await API.College.create(college);
            }

            if (response.code === 200) {
                Utils.showMessage(isEditing ? 'å­¦é™¢æ›´æ–°æˆåŠŸ' : 'å­¦é™¢åˆ›å»ºæˆåŠŸ', 'success');
                closeModal();
                loadColleges();
            } else {
                Utils.showMessage('ä¿å­˜å¤±è´¥: ' + response.message, 'danger');
            }
        } catch (error) {
            console.error('Save college error:', error);
            Utils.showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
        } finally {
            const saveBtn = document.getElementById('saveCollegeBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
        }
    }

    // ç¼–è¾‘å­¦é™¢
    function editCollege(collegeId) {
        const college = colleges.find(c => c.id === collegeId);
        if (college) {
            openCollegeModal(college);
        }
    }

    // åˆ é™¤å­¦é™¢
    function deleteCollege(collegeId) {
        const college = colleges.find(c => c.id === collegeId);
        if (!college) return;

        Utils.confirm(
            `ç¡®å®šè¦åˆ é™¤å­¦é™¢"${college.name}"å—ï¼Ÿ\n\nâš ï¸ åˆ é™¤åï¼Œè¯¥å­¦é™¢ä¸‹çš„æ‰€æœ‰æ•™å¸ˆã€å­¦ç”Ÿå’Œè¯¾ç¨‹å…³è”å°†å—åˆ°å½±å“ï¼`,
            async () => {
                try {
                    const response = await API.College.delete(collegeId);
                    if (response.code === 200) {
                        Utils.showMessage('å­¦é™¢åˆ é™¤æˆåŠŸ', 'success');
                        loadColleges();
                    } else {
                        Utils.showMessage('åˆ é™¤å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Delete college error:', error);
                    Utils.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
                }
            }
        );
    }

    // é€€å‡ºç™»å½•
    async function logout() {
        Utils.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', async () => {
            await AuthManager.logout();
        });
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.editCollege = editCollege;
    window.deleteCollege = deleteCollege;
    window.closeModal = closeModal;
    window.logout = logout;
</script>
</body>
</html>