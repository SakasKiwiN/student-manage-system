<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆç®¡ç† - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ç³»ç»Ÿç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">æ•™å¸ˆç®¡ç†</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">æ•™å¸ˆç®¡ç†</h1>
                <p class="page-description">ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•™å¸ˆä¿¡æ¯</p>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ‘¨â€ğŸ«</div>
                    <div class="stat-value" id="totalTeachers">0</div>
                    <div class="stat-label">æ€»æ•™å¸ˆæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">ğŸ«</div>
                    <div class="stat-value" id="csTeachers">0</div>
                    <div class="stat-label">è®¡ç®—æœºå­¦é™¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">âš¡</div>
                    <div class="stat-value" id="eeTeachers">0</div>
                    <div class="stat-label">ç”µå­å·¥ç¨‹å­¦é™¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">ğŸ“š</div>
                    <div class="stat-value" id="activeCourses">0</div>
                    <div class="stat-label">å¼€è®¾è¯¾ç¨‹</div>
                </div>
            </div>

            <!-- æ“ä½œå·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text"
                                   class="form-control"
                                   id="searchInput"
                                   placeholder="æœç´¢æ•™å¸ˆç¼–å·ã€å§“å...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="collegeFilter">
                                <option value="">å…¨éƒ¨å­¦é™¢</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="titleFilter">
                                <option value="">å…¨éƒ¨èŒç§°</option>
                                <option value="æ•™æˆ">æ•™æˆ</option>
                                <option value="å‰¯æ•™æˆ">å‰¯æ•™æˆ</option>
                                <option value="è®²å¸ˆ">è®²å¸ˆ</option>
                                <option value="åŠ©æ•™">åŠ©æ•™</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
                            <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                        </div>
                        <div class="col-md-2 text-right">
                            <button class="btn btn-success" id="addTeacherBtn">
                                <span>â•</span> æ·»åŠ æ•™å¸ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•™å¸ˆåˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h5>æ•™å¸ˆåˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="tableContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <p class="text-muted">æš‚æ— æ•™å¸ˆæ•°æ®</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- æ•™å¸ˆç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal" id="teacherModal">
    <div class="modal-dialog" style="max-width: 600px;">
        <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">æ·»åŠ æ•™å¸ˆ</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="teacherForm">
                <input type="hidden" id="teacherId">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="teacherNo" class="form-label">æ•™å¸ˆç¼–å· *</label>
                            <input type="text"
                                   class="form-control"
                                   id="teacherNo"
                                   name="teacherNo"
                                   required
                                   placeholder="è¯·è¾“å…¥æ•™å¸ˆç¼–å·">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="teacherName" class="form-label">å§“å *</label>
                            <input type="text"
                                   class="form-control"
                                   id="teacherName"
                                   name="name"
                                   required
                                   placeholder="è¯·è¾“å…¥å§“å">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="teacherCollege" class="form-label">æ‰€å±å­¦é™¢ *</label>
                            <select class="form-select" id="teacherCollege" name="collegeId" required>
                                <option value="">è¯·é€‰æ‹©å­¦é™¢</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="teacherTitle" class="form-label">èŒç§° *</label>
                            <select class="form-select" id="teacherTitle" name="title" required>
                                <option value="">è¯·é€‰æ‹©èŒç§°</option>
                                <option value="æ•™æˆ">æ•™æˆ</option>
                                <option value="å‰¯æ•™æˆ">å‰¯æ•™æˆ</option>
                                <option value="è®²å¸ˆ">è®²å¸ˆ</option>
                                <option value="åŠ©æ•™">åŠ©æ•™</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row" id="passwordGroup">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="teacherPassword" class="form-label">åˆå§‹å¯†ç  *</label>
                            <input type="password"
                                   class="form-control"
                                   id="teacherPassword"
                                   name="password"
                                   placeholder="é»˜è®¤ï¼š123456">
                            <small class="text-muted">ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å¯†ç 123456</small>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="saveTeacherBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let teachers = [];
    let filteredTeachers = [];
    let colleges = [];
    let isEditing = false;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isSysAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            await Promise.all([
                loadTeachers(),
                loadColleges()
            ]);

            renderCollegeFilters();
            renderTeacherTable();
            updateStatistics();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æ•™å¸ˆåˆ—è¡¨
    async function loadTeachers() {
        try {
            const response = await API.Teacher.getAll();
            if (response.code === 200) {
                teachers = response.data || [];
                filteredTeachers = [...teachers];
            }
        } catch (error) {
            console.error('Load teachers error:', error);
            throw error;
        }
    }

    // åŠ è½½å­¦é™¢åˆ—è¡¨
    async function loadColleges() {
        try {
            const response = await API.College.getAll();
            if (response.code === 200) {
                colleges = response.data || [];
            }
        } catch (error) {
            console.warn('Load colleges error:', error);
        }
    }

    // æ¸²æŸ“å­¦é™¢ç­›é€‰å™¨
    function renderCollegeFilters() {
        const collegeFilter = document.getElementById('collegeFilter');
        const teacherCollege = document.getElementById('teacherCollege');

        collegeFilter.innerHTML = '<option value="">å…¨éƒ¨å­¦é™¢</option>';
        teacherCollege.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦é™¢</option>';

        colleges.forEach(college => {
            const option1 = document.createElement('option');
            option1.value = college.id;
            option1.textContent = college.name;
            collegeFilter.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = college.id;
            option2.textContent = college.name;
            teacherCollege.appendChild(option2);
        });
    }

    // æ¸²æŸ“æ•™å¸ˆè¡¨æ ¼
    function renderTeacherTable() {
        const tableContainer = document.getElementById('tableContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredTeachers.length === 0) {
            showEmptyState();
            return;
        }

        const columns = [
            { field: 'teacherNo', title: 'æ•™å¸ˆç¼–å·', width: '120px' },
            { field: 'name', title: 'å§“å', width: '100px' },
            {
                field: 'college',
                title: 'å­¦é™¢',
                width: '120px',
                render: (value) => value?.name || 'æœªåˆ†é…'
            },
            { field: 'title', title: 'èŒç§°', width: '100px' },
            {
                field: 'user',
                title: 'ç”¨æˆ·å',
                width: '120px',
                render: (value) => value?.username || 'æœªåˆ›å»º'
            },
            {
                field: 'courseCount',
                title: 'æˆè¯¾æ•°',
                width: '80px',
                render: (value, row) => getCourseCount(row.id)
            },
            {
                field: 'gmtCreate',
                title: 'åˆ›å»ºæ—¶é—´',
                width: '150px',
                render: (value) => Utils.formatDate(value, 'YYYY-MM-DD')
            },
            {
                field: 'actions',
                title: 'æ“ä½œ',
                width: '180px',
                render: (value, row) => `
                        <button class="btn btn-sm btn-primary" onclick="viewTeacherDetail(${row.id})">è¯¦æƒ…</button>
                        <button class="btn btn-sm btn-warning ml-1" onclick="editTeacher(${row.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger ml-1" onclick="deleteTeacher(${row.id})">åˆ é™¤</button>
                    `
            }
        ];

        TableUtils.createTable(filteredTeachers, columns, tableContainer);

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        tableContainer.style.display = 'block';
    }

    // è·å–æ•™å¸ˆæˆè¯¾æ•°é‡ï¼ˆç®€åŒ–å¤„ç†ï¼‰
    function getCourseCount(teacherId) {
        // è¿™é‡Œåº”è¯¥ä»è¯¾ç¨‹æ•°æ®ä¸­ç»Ÿè®¡ï¼Œç®€åŒ–å¤„ç†è¿”å›éšæœºæ•°
        return Math.floor(Math.random() * 5) + 1;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = teachers.length;
        const csCount = teachers.filter(t => t.college?.code === 'CS').length;
        const eeCount = teachers.filter(t => t.college?.code === 'EE').length;

        document.getElementById('totalTeachers').textContent = total;
        document.getElementById('csTeachers').textContent = csCount;
        document.getElementById('eeTeachers').textContent = eeCount;

        // è¿™é‡Œç®€åŒ–å¤„ç†æ´»è·ƒè¯¾ç¨‹æ•°
        document.getElementById('activeCourses').textContent = Math.floor(total * 2);
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });

        // æ·»åŠ æ•™å¸ˆ
        document.getElementById('addTeacherBtn').addEventListener('click', () => {
            openTeacherModal();
        });

        // ä¿å­˜æ•™å¸ˆ
        document.getElementById('saveTeacherBtn').addEventListener('click', saveTeacher);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œæœç´¢
    function performSearch() {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
        const collegeId = document.getElementById('collegeFilter').value;
        const title = document.getElementById('titleFilter').value;

        filteredTeachers = teachers.filter(teacher => {
            let match = true;

            if (keyword) {
                match = match && (
                    teacher.teacherNo.toLowerCase().includes(keyword) ||
                    teacher.name.toLowerCase().includes(keyword)
                );
            }

            if (collegeId) {
                match = match && teacher.college?.id == collegeId;
            }

            if (title) {
                match = match && teacher.title === title;
            }

            return match;
        });

        renderTeacherTable();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('searchInput').value = '';
        document.getElementById('collegeFilter').value = '';
        document.getElementById('titleFilter').value = '';

        filteredTeachers = [...teachers];
        renderTeacherTable();
    }

    // æ‰“å¼€æ•™å¸ˆç¼–è¾‘æ¨¡æ€æ¡†
    function openTeacherModal(teacher = null) {
        isEditing = !!teacher;

        document.getElementById('modalTitle').textContent = isEditing ? 'ç¼–è¾‘æ•™å¸ˆ' : 'æ·»åŠ æ•™å¸ˆ';
        document.getElementById('teacherId').value = teacher?.id || '';
        document.getElementById('teacherNo').value = teacher?.teacherNo || '';
        document.getElementById('teacherName').value = teacher?.name || '';
        document.getElementById('teacherCollege').value = teacher?.college?.id || '';
        document.getElementById('teacherTitle').value = teacher?.title || '';
        document.getElementById('teacherPassword').value = '';

        // ç¼–è¾‘æ—¶éšè—å¯†ç å­—æ®µï¼Œæ•™å¸ˆç¼–å·åªè¯»
        document.getElementById('passwordGroup').style.display = isEditing ? 'none' : 'block';
        document.getElementById('teacherNo').readOnly = isEditing;

        Utils.showModal(document.getElementById('teacherModal'));
    }

    // ä¿å­˜æ•™å¸ˆ
    async function saveTeacher() {
        const form = document.getElementById('teacherForm');

        if (!Utils.validateForm(form)) {
            return;
        }

        const formData = FormUtils.serialize(form);

        try {
            const saveBtn = document.getElementById('saveTeacherBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            let response;
            if (isEditing) {
                const teacher = {
                    teacherNo: formData.teacherNo,
                    name: formData.name,
                    college: { id: parseInt(formData.collegeId) },
                    title: formData.title
                };
                const teacherId = document.getElementById('teacherId').value;
                response = await API.Teacher.update(teacherId, teacher);
            } else {
                const teacher = {
                    teacherNo: formData.teacherNo,
                    name: formData.name,
                    college: { id: parseInt(formData.collegeId) },
                    title: formData.title
                };
                response = await API.Teacher.create(teacher);
            }

            if (response && response.code === 200) {
                Utils.showMessage(isEditing ? 'æ•™å¸ˆæ›´æ–°æˆåŠŸ' : 'æ•™å¸ˆåˆ›å»ºæˆåŠŸ', 'success');
                closeModal();
                await loadTeachers();
                renderTeacherTable();
                updateStatistics();
            } else {
                Utils.showMessage('ä¿å­˜å¤±è´¥: ' + (response?.message || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        } catch (error) {
            console.error('Save teacher error:', error);
            Utils.showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
        } finally {
            const saveBtn = document.getElementById('saveTeacherBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
        }
    }

    // æŸ¥çœ‹æ•™å¸ˆè¯¦æƒ…
    function viewTeacherDetail(teacherId) {
        const teacher = teachers.find(t => t.id === teacherId);
        if (!teacher) return;

        const content = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>æ•™å¸ˆç¼–å·ï¼š</strong>${teacher.teacherNo}</p>
                        <p><strong>å§“åï¼š</strong>${teacher.name}</p>
                        <p><strong>èŒç§°ï¼š</strong>${teacher.title}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>å­¦é™¢ï¼š</strong>${teacher.college?.name || 'æœªåˆ†é…'}</p>
                        <p><strong>ç”¨æˆ·åï¼š</strong>${teacher.user?.username || 'æœªåˆ›å»º'}</p>
                        <p><strong>æˆè¯¾æ•°é‡ï¼š</strong>${getCourseCount(teacher.id)}é—¨</p>
                    </div>
                    <div class="col-12">
                        <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${Utils.formatDate(teacher.gmtCreate, 'YYYY-MM-DD HH:mm:ss')}</p>
                        <p><strong>ä¿®æ”¹æ—¶é—´ï¼š</strong>${Utils.formatDate(teacher.gmtModified, 'YYYY-MM-DD HH:mm:ss')}</p>
                    </div>
                </div>
            `;

        const modal = Utils.createModal('æ•™å¸ˆè¯¦æƒ…', content, [
            { text: 'å…³é—­', class: 'btn-secondary', onclick: 'Utils.closeModal()' }
        ]);
        Utils.showModal(modal);
    }

    // ç¼–è¾‘æ•™å¸ˆ
    function editTeacher(teacherId) {
        const teacher = teachers.find(t => t.id === teacherId);
        if (teacher) {
            openTeacherModal(teacher);
        }
    }

    // åˆ é™¤æ•™å¸ˆ
    function deleteTeacher(teacherId) {
        const teacher = teachers.find(t => t.id === teacherId);
        if (!teacher) return;

        Utils.confirm(
            `ç¡®å®šè¦åˆ é™¤æ•™å¸ˆ"${teacher.name}(${teacher.teacherNo})"å—ï¼Ÿ\n\nâš ï¸ åˆ é™¤åï¼Œç›¸å…³çš„è¯¾ç¨‹å°†éœ€è¦é‡æ–°åˆ†é…æ•™å¸ˆï¼`,
            async () => {
                try {
                    const response = await API.Teacher.delete(teacherId);
                    if (response.code === 200) {
                        Utils.showMessage('æ•™å¸ˆåˆ é™¤æˆåŠŸ', 'success');
                        await loadTeachers();
                        renderTeacherTable();
                        updateStatistics();
                    } else {
                        Utils.showMessage('åˆ é™¤å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Delete teacher error:', error);
                    Utils.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
                }
            }
        );
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        document.getElementById('teacherForm').reset();

        // æ¸…é™¤éªŒè¯çŠ¶æ€
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => Utils.clearFieldError(field));
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.viewTeacherDetail = viewTeacherDetail;
    window.editTeacher = editTeacher;
    window.deleteTeacher = deleteTeacher;
    window.closeModal = closeModal;
</script>
</body>
</html>