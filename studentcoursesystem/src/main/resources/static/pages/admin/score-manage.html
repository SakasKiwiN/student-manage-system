<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©ç®¡ç† - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ç³»ç»Ÿç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">æˆç»©ç®¡ç†</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">æˆç»©ç®¡ç†</h1>
                <p class="page-description">ç®¡ç†ç³»ç»Ÿä¸­æ‰€æœ‰çš„è¯¾ç¨‹æˆç»©</p>
            </div>

            <!-- æˆç»©ç»Ÿè®¡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“Š</div>
                    <div class="stat-value" id="totalScores">0</div>
                    <div class="stat-label">æ€»æˆç»©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="passedScores">0</div>
                    <div class="stat-label">åŠæ ¼äººæ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">ğŸ“ˆ</div>
                    <div class="stat-value" id="averageScore">0</div>
                    <div class="stat-label">å¹³å‡åˆ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9b59b6; color: white;">ğŸ¯</div>
                    <div class="stat-value" id="passRate">0%</div>
                    <div class="stat-label">åŠæ ¼ç‡</div>
                </div>
            </div>

            <!-- ç­›é€‰å·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">è¯¾ç¨‹</label>
                                <select class="form-select" id="courseFilter">
                                    <option value="">å…¨éƒ¨è¯¾ç¨‹</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">å­¦é™¢</label>
                                <select class="form-select" id="collegeFilter">
                                    <option value="">å…¨éƒ¨å­¦é™¢</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">æˆç»©ç­‰çº§</label>
                                <select class="form-select" id="gradeFilter">
                                    <option value="">å…¨éƒ¨ç­‰çº§</option>
                                    <option value="excellent">ä¼˜ç§€(90+)</option>
                                    <option value="good">è‰¯å¥½(80-89)</option>
                                    <option value="average">ä¸­ç­‰(70-79)</option>
                                    <option value="pass">åŠæ ¼(60-69)</option>
                                    <option value="fail">ä¸åŠæ ¼(<60)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">æœç´¢</label>
                                <input type="text"
                                       class="form-control"
                                       id="searchInput"
                                       placeholder="æœç´¢å­¦å·ã€å§“å...">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
                            <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                            <button class="btn btn-success ml-2" id="addScoreBtn">æ·»åŠ æˆç»©</button>
                            <button class="btn btn-warning ml-2" id="batchEditBtn">æ‰¹é‡ç¼–è¾‘</button>
                            <button class="btn btn-info ml-2" id="exportBtn">å¯¼å‡ºæˆç»©</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆç»©åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h5>æˆç»©è®°å½•</h5>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="tableContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <p class="text-muted">æš‚æ— æˆç»©è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- æˆç»©ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal" id="scoreModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">æ·»åŠ æˆç»©</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="scoreForm">
                <input type="hidden" id="scoreId">
                <div class="form-group">
                    <label for="studentSelect" class="form-label">å­¦ç”Ÿ *</label>
                    <select class="form-select" id="studentSelect" name="studentId" required>
                        <option value="">è¯·é€‰æ‹©å­¦ç”Ÿ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="courseSelect" class="form-label">è¯¾ç¨‹ *</label>
                    <select class="form-select" id="courseSelect" name="courseId" required>
                        <option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scoreInput" class="form-label">æˆç»© *</label>
                    <input type="number"
                           class="form-control"
                           id="scoreInput"
                           name="score"
                           required
                           min="0"
                           max="100"
                           step="0.1"
                           placeholder="0-100">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="saveScoreBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let allScores = [];
    let filteredScores = [];
    let courses = [];
    let colleges = [];
    let students = [];
    let isEditing = false;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isSysAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            await Promise.all([
                loadAllScores(),
                loadCourses(),
                loadColleges(),
                loadStudents()
            ]);

            renderFilters();
            renderScoreTable();
            updateStatistics();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æ‰€æœ‰æˆç»©è®°å½•
    async function loadAllScores() {
        try {
            const response = await API.Score.getAll();
            if (response.code === 200) {
                allScores = response.data || [];
                filteredScores = [...allScores];
            }
        } catch (error) {
            console.error('Load scores error:', error);
            throw error;
        }
    }

    // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
    async function loadCourses() {
        try {
            const response = await API.Course.getAll();
            if (response.code === 200) {
                courses = response.data || [];
            }
        } catch (error) {
            console.warn('Load courses error:', error);
        }
    }

    // åŠ è½½å­¦é™¢åˆ—è¡¨
    async function loadColleges() {
        try {
            const response = await API.College.getAll();
            if (response.code === 200) {
                colleges = response.data || [];
            }
        } catch (error) {
            console.warn('Load colleges error:', error);
        }
    }

    // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
    async function loadStudents() {
        try {
            const response = await API.Student.getAll();
            if (response.code === 200) {
                students = response.data || [];
            }
        } catch (error) {
            console.warn('Load students error:', error);
        }
    }

    // æ¸²æŸ“ç­›é€‰å™¨
    function renderFilters() {
        // è¯¾ç¨‹ç­›é€‰å™¨
        const courseFilter = document.getElementById('courseFilter');
        courseFilter.innerHTML = '<option value="">å…¨éƒ¨è¯¾ç¨‹</option>';
        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = `${course.name} (${course.courseCode})`;
            courseFilter.appendChild(option);
        });

        // å­¦é™¢ç­›é€‰å™¨
        const collegeFilter = document.getElementById('collegeFilter');
        collegeFilter.innerHTML = '<option value="">å…¨éƒ¨å­¦é™¢</option>';
        colleges.forEach(college => {
            const option = document.createElement('option');
            option.value = college.id;
            option.textContent = college.name;
            collegeFilter.appendChild(option);
        });

        // æ¨¡æ€æ¡†ä¸­çš„é€‰æ‹©å™¨
        renderModalSelectors();
    }

    // æ¸²æŸ“æ¨¡æ€æ¡†é€‰æ‹©å™¨
    function renderModalSelectors() {
        // å­¦ç”Ÿé€‰æ‹©å™¨
        const studentSelect = document.getElementById('studentSelect');
        studentSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦ç”Ÿ</option>';
        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.name} (${student.studentNo})`;
            studentSelect.appendChild(option);
        });

        // è¯¾ç¨‹é€‰æ‹©å™¨
        const courseSelect = document.getElementById('courseSelect');
        courseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>';
        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = `${course.name} (${course.courseCode})`;
            courseSelect.appendChild(option);
        });
    }

    // æ¸²æŸ“æˆç»©è¡¨æ ¼
    function renderScoreTable() {
        const tableContainer = document.getElementById('tableContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredScores.length === 0) {
            showEmptyState();
            return;
        }

        const columns = [
            { field: 'student.studentNo', title: 'å­¦å·', width: '120px' },
            { field: 'student.name', title: 'å­¦ç”Ÿå§“å', width: '100px' },
            { field: 'course.name', title: 'è¯¾ç¨‹åç§°', width: '150px' },
            { field: 'course.courseCode', title: 'è¯¾ç¨‹ç¼–ç ', width: '120px' },
            {
                field: 'course.college.name',
                title: 'å¼€è¯¾å­¦é™¢',
                width: '120px',
                render: (value) => value || 'æœªçŸ¥'
            },
            {
                field: 'score',
                title: 'æˆç»©',
                width: '80px',
                render: (value) => {
                    const grade = getGradeLevel(value);
                    return `<span class="${grade.class}">${value}</span>`;
                }
            },
            {
                field: 'score',
                title: 'ç­‰çº§',
                width: '80px',
                render: (value) => {
                    const grade = getGradeLevel(value);
                    return `<span class="${grade.class}">${grade.letter}</span>`;
                }
            },
            {
                field: 'gmtCreate',
                title: 'å½•å…¥æ—¶é—´',
                width: '150px',
                render: (value) => Utils.formatDate(value, 'YYYY-MM-DD HH:mm')
            },
            {
                field: 'actions',
                title: 'æ“ä½œ',
                width: '120px',
                render: (value, row) => `
                    <button class="btn btn-sm btn-warning" onclick="editScore(${row.id})">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger ml-1" onclick="deleteScore(${row.id})">åˆ é™¤</button>
                `
            }
        ];

        TableUtils.createTable(filteredScores, columns, tableContainer);

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        tableContainer.style.display = 'block';
    }

    // è·å–æˆç»©ç­‰çº§
    function getGradeLevel(score) {
        if (score >= 90) return { letter: 'A', class: 'text-success' };
        if (score >= 80) return { letter: 'B', class: 'text-info' };
        if (score >= 70) return { letter: 'C', class: 'text-warning' };
        if (score >= 60) return { letter: 'D', class: 'text-secondary' };
        return { letter: 'F', class: 'text-danger' };
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = allScores.length;
        const passed = allScores.filter(s => s.score >= 60).length;
        const totalScore = allScores.reduce((sum, s) => sum + s.score, 0);
        const average = total > 0 ? (totalScore / total).toFixed(1) : 0;
        const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

        document.getElementById('totalScores').textContent = total;
        document.getElementById('passedScores').textContent = passed;
        document.getElementById('averageScore').textContent = average;
        document.getElementById('passRate').textContent = passRate + '%';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // æ·»åŠ æˆç»©
        document.getElementById('addScoreBtn').addEventListener('click', () => {
            openScoreModal();
        });

        // ä¿å­˜æˆç»©
        document.getElementById('saveScoreBtn').addEventListener('click', saveScore);

        // å¯¼å‡ºåŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', exportScores);

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œæœç´¢
    function performSearch() {
        const courseId = document.getElementById('courseFilter').value;
        const collegeId = document.getElementById('collegeFilter').value;
        const grade = document.getElementById('gradeFilter').value;
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();

        filteredScores = allScores.filter(score => {
            let match = true;

            if (courseId) {
                match = match && score.course.id == courseId;
            }

            if (collegeId) {
                match = match && score.course.college?.id == collegeId;
            }

            if (grade) {
                switch (grade) {
                    case 'excellent':
                        match = match && score.score >= 90;
                        break;
                    case 'good':
                        match = match && score.score >= 80 && score.score < 90;
                        break;
                    case 'average':
                        match = match && score.score >= 70 && score.score < 80;
                        break;
                    case 'pass':
                        match = match && score.score >= 60 && score.score < 70;
                        break;
                    case 'fail':
                        match = match && score.score < 60;
                        break;
                }
            }

            if (keyword) {
                match = match && (
                    score.student.studentNo.toLowerCase().includes(keyword) ||
                    score.student.name.toLowerCase().includes(keyword)
                );
            }

            return match;
        });

        renderScoreTable();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('courseFilter').value = '';
        document.getElementById('collegeFilter').value = '';
        document.getElementById('gradeFilter').value = '';
        document.getElementById('searchInput').value = '';

        filteredScores = [...allScores];
        renderScoreTable();
    }

    // æ‰“å¼€æˆç»©ç¼–è¾‘æ¨¡æ€æ¡†
    function openScoreModal(score = null) {
        isEditing = !!score;

        document.getElementById('modalTitle').textContent = isEditing ? 'ç¼–è¾‘æˆç»©' : 'æ·»åŠ æˆç»©';
        document.getElementById('scoreId').value = score?.id || '';
        document.getElementById('studentSelect').value = score?.student.id || '';
        document.getElementById('courseSelect').value = score?.course.id || '';
        document.getElementById('scoreInput').value = score?.score || '';

        Utils.showModal(document.getElementById('scoreModal'));
    }

    // ä¿å­˜æˆç»©
    async function saveScore() {
        const form = document.getElementById('scoreForm');

        if (!Utils.validateForm(form)) {
            return;
        }

        const formData = FormUtils.serialize(form);

        try {
            const saveBtn = document.getElementById('saveScoreBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            let response;
            if (isEditing) {
                const scoreId = document.getElementById('scoreId').value;
                response = await API.Score.update(scoreId, {
                    score: parseFloat(formData.score)
                });
            } else {
                response = await API.Score.input(
                    parseInt(formData.studentId),
                    parseInt(formData.courseId),
                    parseFloat(formData.score)
                );
            }

            if (response.code === 200) {
                Utils.showMessage(isEditing ? 'æˆç»©æ›´æ–°æˆåŠŸ' : 'æˆç»©æ·»åŠ æˆåŠŸ', 'success');
                closeModal();
                await loadAllScores();
                renderScoreTable();
                updateStatistics();
            } else {
                Utils.showMessage('ä¿å­˜å¤±è´¥: ' + response.message, 'danger');
            }
        } catch (error) {
            console.error('Save score error:', error);
            Utils.showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
        } finally {
            const saveBtn = document.getElementById('saveScoreBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
        }
    }

    // ç¼–è¾‘æˆç»©
    function editScore(scoreId) {
        const score = allScores.find(s => s.id === scoreId);
        if (score) {
            openScoreModal(score);
        }
    }

    // åˆ é™¤æˆç»©
    function deleteScore(scoreId) {
        const score = allScores.find(s => s.id === scoreId);
        if (!score) return;

        Utils.confirm(
            `ç¡®å®šè¦åˆ é™¤å­¦ç”Ÿ"${score.student.name}"åœ¨è¯¾ç¨‹"${score.course.name}"çš„æˆç»©è®°å½•å—ï¼Ÿ`,
            async () => {
                try {
                    const response = await API.Score.delete(scoreId);
                    if (response.code === 200) {
                        Utils.showMessage('æˆç»©åˆ é™¤æˆåŠŸ', 'success');
                        await loadAllScores();
                        renderScoreTable();
                        updateStatistics();
                    } else {
                        Utils.showMessage('åˆ é™¤å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Delete score error:', error);
                    Utils.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
                }
            }
        );
    }

    // å¯¼å‡ºæˆç»©
    function exportScores() {
        if (filteredScores.length === 0) {
            Utils.showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }

        let csvContent = 'å­¦å·,å­¦ç”Ÿå§“å,è¯¾ç¨‹åç§°,è¯¾ç¨‹ç¼–ç ,å¼€è¯¾å­¦é™¢,æˆç»©,ç­‰çº§,å½•å…¥æ—¶é—´\n';

        filteredScores.forEach(score => {
            const grade = getGradeLevel(score.score);
            csvContent += `${score.student.studentNo},${score.student.name},${score.course.name},${score.course.courseCode},${score.course.college?.name || ''},${score.score},${grade.letter},${Utils.formatDate(score.gmtCreate, 'YYYY-MM-DD HH:mm')}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `æˆç»©è®°å½•_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('æˆç»©å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        Utils.closeModal();
        document.getElementById('scoreForm').reset();
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.editScore = editScore;
    window.deleteScore = deleteScore;
    window.closeModal = closeModal;
</script>
</body>
</html>