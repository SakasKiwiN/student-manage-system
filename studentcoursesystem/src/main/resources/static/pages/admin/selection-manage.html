<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€‰è¯¾ç®¡ç† - å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb">
                    <span class="breadcrumb-item">ç³»ç»Ÿç®¡ç†</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">é€‰è¯¾ç®¡ç†</span>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight"></div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title">é€‰è¯¾ç®¡ç†</h1>
                <p class="page-description">ç®¡ç†ç³»ç»Ÿä¸­æ‰€æœ‰çš„é€‰è¯¾è®°å½•</p>
            </div>

            <!-- é€‰è¯¾ç»Ÿè®¡ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db; color: white;">ğŸ“š</div>
                    <div class="stat-value" id="totalSelections">0</div>
                    <div class="stat-label">æ€»é€‰è¯¾æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12; color: white;">â³</div>
                    <div class="stat-value" id="pendingSelections">0</div>
                    <div class="stat-label">å¾…æŠ½ç­¾</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #27ae60; color: white;">âœ…</div>
                    <div class="stat-value" id="successSelections">0</div>
                    <div class="stat-label">å·²ä¸­ç­¾</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c; color: white;">âŒ</div>
                    <div class="stat-value" id="failedSelections">0</div>
                    <div class="stat-label">æœªä¸­ç­¾</div>
                </div>
            </div>

            <!-- é€‰è¯¾ç»Ÿè®¡å›¾è¡¨ -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>æ¯é—¨è¯¾é€‰æ‹©äººæ•°ç»Ÿè®¡</h5>
                    <div>
                        <button class="btn btn-success" id="exportChartBtn">ğŸ“Š å¯¼å‡ºå›¾è¡¨</button>
                        <button class="btn btn-primary ml-2" id="refreshChartBtn">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="courseSelectionChart" width="800" height="400"></canvas>
                </div>
            </div>

            <!-- ç­›é€‰å·¥å…·æ  -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">è¯¾ç¨‹</label>
                                <select class="form-select" id="courseFilter">
                                    <option value="">å…¨éƒ¨è¯¾ç¨‹</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">å­¦é™¢</label>
                                <select class="form-select" id="collegeFilter">
                                    <option value="">å…¨éƒ¨å­¦é™¢</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">çŠ¶æ€</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="1">ç”³è¯·ä¸­</option>
                                    <option value="2">å·²ç¡®å®š</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">æŠ½ç­¾ç»“æœ</label>
                                <select class="form-select" id="resultFilter">
                                    <option value="">å…¨éƒ¨ç»“æœ</option>
                                    <option value="1">ä¸­ç­¾</option>
                                    <option value="0">æœªä¸­ç­¾</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
                                    <button class="btn btn-secondary ml-2" id="resetBtn">é‡ç½®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é€‰è¯¾åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>é€‰è¯¾è®°å½•</h5>
                    <div>
                        <button class="btn btn-success" id="exportBtn">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
                        <button class="btn btn-danger ml-2" id="batchDeleteBtn">æ‰¹é‡åˆ é™¤</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingContainer" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="tableContainer" style="display: none;"></div>
                    <div id="emptyContainer" style="display: none; text-align: center; padding: 40px;">
                        <p class="text-muted">æš‚æ— é€‰è¯¾è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let allSelections = [];
    let filteredSelections = [];
    let courses = [];
    let colleges = [];
    let courseStats = {};

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        loadPageData();
        bindEvents();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        if (!AuthManager.isSysAdmin()) {
            Utils.showMessage('æƒé™ä¸è¶³ï¼Œæ­£åœ¨è·³è½¬...', 'warning');
            setTimeout(() => {
                PageAuth.redirectToRolePage();
            }, 1500);
            return;
        }
    }

    // åŠ è½½é¡µé¢æ•°æ®
    async function loadPageData() {
        try {
            await Promise.all([
                loadAllSelections(),
                loadCourses(),
                loadColleges()
            ]);

            renderFilters();
            renderSelectionTable();
            updateStatistics();
            renderChart();

        } catch (error) {
            console.error('Load page data error:', error);
            Utils.showMessage('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥', 'danger');
        }
    }

    // åŠ è½½æ‰€æœ‰é€‰è¯¾è®°å½•
    async function loadAllSelections() {
        try {
            const response = await API.CourseSelection.getAll();
            if (response.code === 200) {
                allSelections = response.data || [];
                filteredSelections = [...allSelections];
            }
        } catch (error) {
            console.error('Load selections error:', error);
            throw error;
        }
    }

    // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
    async function loadCourses() {
        try {
            const response = await API.Course.getAll();
            if (response.code === 200) {
                courses = response.data || [];
                // ç»Ÿè®¡æ¯é—¨è¯¾ç¨‹çš„é€‰è¯¾äººæ•°
                calculateCourseStats();
            }
        } catch (error) {
            console.warn('Load courses error:', error);
        }
    }

    // åŠ è½½å­¦é™¢åˆ—è¡¨
    async function loadColleges() {
        try {
            const response = await API.College.getAll();
            if (response.code === 200) {
                colleges = response.data || [];
            }
        } catch (error) {
            console.warn('Load colleges error:', error);
        }
    }

    // è®¡ç®—è¯¾ç¨‹ç»Ÿè®¡
    function calculateCourseStats() {
        courseStats = {};
        courses.forEach(course => {
            const courseSelections = allSelections.filter(s => s.course.id === course.id);
            courseStats[course.id] = {
                course: course,
                totalCount: courseSelections.length,
                pendingCount: courseSelections.filter(s => s.status === 1).length,
                successCount: courseSelections.filter(s => s.status === 2 && s.lotteryResult === 1).length,
                failedCount: courseSelections.filter(s => s.status === 2 && s.lotteryResult !== 1).length
            };
        });
    }

    // æ¸²æŸ“ç­›é€‰å™¨
    function renderFilters() {
        // è¯¾ç¨‹ç­›é€‰å™¨
        const courseFilter = document.getElementById('courseFilter');
        courseFilter.innerHTML = '<option value="">å…¨éƒ¨è¯¾ç¨‹</option>';
        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = `${course.name} (${course.courseCode})`;
            courseFilter.appendChild(option);
        });

        // å­¦é™¢ç­›é€‰å™¨
        const collegeFilter = document.getElementById('collegeFilter');
        collegeFilter.innerHTML = '<option value="">å…¨éƒ¨å­¦é™¢</option>';
        colleges.forEach(college => {
            const option = document.createElement('option');
            option.value = college.id;
            option.textContent = college.name;
            collegeFilter.appendChild(option);
        });
    }

    // æ¸²æŸ“é€‰è¯¾è¡¨æ ¼
    function renderSelectionTable() {
        const tableContainer = document.getElementById('tableContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const emptyContainer = document.getElementById('emptyContainer');

        if (filteredSelections.length === 0) {
            showEmptyState();
            return;
        }

        const columns = [
            {
                field: 'checkbox',
                title: '<input type="checkbox" id="selectAll">',
                width: '50px',
                render: (value, row) => `<input type="checkbox" class="selection-checkbox" value="${row.id}">`
            },
            { field: 'student.studentNo', title: 'å­¦å·', width: '120px' },
            { field: 'student.name', title: 'å­¦ç”Ÿå§“å', width: '100px' },
            { field: 'course.name', title: 'è¯¾ç¨‹åç§°', width: '150px' },
            { field: 'course.courseCode', title: 'è¯¾ç¨‹ç¼–ç ', width: '120px' },
            {
                field: 'course.college.name',
                title: 'å¼€è¯¾å­¦é™¢',
                width: '120px',
                render: (value) => value || 'æœªçŸ¥'
            },
            {
                field: 'status',
                title: 'é€‰è¯¾çŠ¶æ€',
                width: '100px',
                render: (value) => {
                    if (value === 1) return '<span class="badge bg-warning">ç”³è¯·ä¸­</span>';
                    if (value === 2) return '<span class="badge bg-info">å·²ç¡®å®š</span>';
                    return '<span class="badge bg-secondary">æœªçŸ¥</span>';
                }
            },
            {
                field: 'lotteryResult',
                title: 'æŠ½ç­¾ç»“æœ',
                width: '100px',
                render: (value, row) => {
                    if (row.status === 1) return '<span class="text-muted">å¾…æŠ½ç­¾</span>';
                    if (row.status === 2) {
                        if (value === 1) return '<span class="badge bg-success">ä¸­ç­¾</span>';
                        return '<span class="badge bg-danger">æœªä¸­ç­¾</span>';
                    }
                    return '<span class="text-muted">-</span>';
                }
            },
            {
                field: 'gmtCreate',
                title: 'ç”³è¯·æ—¶é—´',
                width: '150px',
                render: (value) => Utils.formatDate(value, 'YYYY-MM-DD HH:mm')
            },
            {
                field: 'actions',
                title: 'æ“ä½œ',
                width: '120px',
                render: (value, row) => `
                    <button class="btn btn-sm btn-info" onclick="viewSelectionDetail(${row.id})">è¯¦æƒ…</button>
                    <button class="btn btn-sm btn-danger ml-1" onclick="deleteSelection(${row.id})">åˆ é™¤</button>
                `
            }
        ];

        TableUtils.createTable(filteredSelections, columns, tableContainer);

        // ç»‘å®šå…¨é€‰äº‹ä»¶
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.selection-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        loadingContainer.style.display = 'none';
        emptyContainer.style.display = 'none';
        tableContainer.style.display = 'block';
    }

    // æ¸²æŸ“ç»Ÿè®¡å›¾è¡¨
    function renderChart() {
        const canvas = document.getElementById('courseSelectionChart');
        const ctx = canvas.getContext('2d');

        // è·å–å‰20é—¨è¯¾ç¨‹çš„é€‰è¯¾æ•°æ®
        const sortedStats = Object.values(courseStats)
            .sort((a, b) => b.totalCount - a.totalCount)
            .slice(0, 20);

        if (sortedStats.length === 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#999';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('æš‚æ— æ•°æ®', canvas.width / 2, canvas.height / 2);
            return;
        }

        const padding = 60;
        const chartWidth = canvas.width - 2 * padding;
        const chartHeight = canvas.height - 2 * padding - 60;
        const barWidth = chartWidth / sortedStats.length * 0.8;
        const maxValue = Math.max(...sortedStats.map(s => s.totalCount));

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶æ ‡é¢˜
        ctx.fillStyle = '#333';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('æ¯é—¨è¯¾ç¨‹é€‰æ‹©äººæ•°ç»Ÿè®¡ï¼ˆTOP 20ï¼‰', canvas.width / 2, 30);

        // ç»˜åˆ¶æŸ±çŠ¶å›¾
        sortedStats.forEach((stat, index) => {
            const barHeight = maxValue > 0 ? (stat.totalCount / maxValue) * chartHeight : 0;
            const x = padding + index * (chartWidth / sortedStats.length) + (chartWidth / sortedStats.length - barWidth) / 2;
            const y = padding + 60 + chartHeight - barHeight;

            // ç»˜åˆ¶æŸ±å­
            ctx.fillStyle = '#3498db';
            ctx.fillRect(x, y, barWidth, barHeight);

            // ç»˜åˆ¶æ•°å€¼
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(stat.totalCount, x + barWidth / 2, y - 5);

            // ç»˜åˆ¶è¯¾ç¨‹åç§°ï¼ˆç®€åŒ–ï¼‰
            const courseName = stat.course.name.length > 6 ?
                stat.course.name.substring(0, 6) + '...' : stat.course.name;
            ctx.save();
            ctx.translate(x + barWidth / 2, padding + 60 + chartHeight + 15);
            ctx.rotate(-Math.PI / 4);
            ctx.textAlign = 'right';
            ctx.fillText(courseName, 0, 0);
            ctx.restore();
        });

        // ç»˜åˆ¶Yè½´æ ‡ç­¾
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
            const value = Math.round((maxValue / 5) * i);
            const y = padding + 60 + chartHeight - (chartHeight / 5) * i;
            ctx.fillText(value, padding - 10, y + 4);
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        const total = allSelections.length;
        const pending = allSelections.filter(s => s.status === 1).length;
        const success = allSelections.filter(s => s.status === 2 && s.lotteryResult === 1).length;
        const failed = allSelections.filter(s => s.status === 2 && s.lotteryResult !== 1).length;

        document.getElementById('totalSelections').textContent = total;
        document.getElementById('pendingSelections').textContent = pending;
        document.getElementById('successSelections').textContent = success;
        document.getElementById('failedSelections').textContent = failed;
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyContainer').style.display = 'block';
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('resetBtn').addEventListener('click', resetFilter);

        // å¯¼å‡ºåŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('exportChartBtn').addEventListener('click', exportChart);

        // æ‰¹é‡åˆ é™¤
        document.getElementById('batchDeleteBtn').addEventListener('click', batchDelete);

        // åˆ·æ–°å›¾è¡¨
        document.getElementById('refreshChartBtn').addEventListener('click', function() {
            calculateCourseStats();
            renderChart();
        });

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    }

    // æ‰§è¡Œæœç´¢
    function performSearch() {
        const courseId = document.getElementById('courseFilter').value;
        const collegeId = document.getElementById('collegeFilter').value;
        const status = document.getElementById('statusFilter').value;
        const result = document.getElementById('resultFilter').value;

        filteredSelections = allSelections.filter(selection => {
            let match = true;

            if (courseId) {
                match = match && selection.course.id == courseId;
            }

            if (collegeId) {
                match = match && selection.course.college?.id == collegeId;
            }

            if (status) {
                match = match && selection.status == status;
            }

            if (result !== '' && selection.status === 2) {
                match = match && selection.lotteryResult == result;
            }

            return match;
        });

        renderSelectionTable();
    }

    // é‡ç½®ç­›é€‰
    function resetFilter() {
        document.getElementById('courseFilter').value = '';
        document.getElementById('collegeFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('resultFilter').value = '';

        filteredSelections = [...allSelections];
        renderSelectionTable();
    }

    // æŸ¥çœ‹é€‰è¯¾è¯¦æƒ…
    function viewSelectionDetail(selectionId) {
        const selection = allSelections.find(s => s.id === selectionId);
        if (!selection) return;

        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6>å­¦ç”Ÿä¿¡æ¯</h6>
                    <p><strong>å­¦å·ï¼š</strong>${selection.student.studentNo}</p>
                    <p><strong>å§“åï¼š</strong>${selection.student.name}</p>
                    <p><strong>å­¦é™¢ï¼š</strong>${selection.student.college?.name || 'æœªçŸ¥'}</p>
                    <p><strong>å¹´çº§ï¼š</strong>${selection.student.grade}</p>
                    <p><strong>ç­çº§ï¼š</strong>${selection.student.class}</p>
                </div>
                <div class="col-md-6">
                    <h6>è¯¾ç¨‹ä¿¡æ¯</h6>
                    <p><strong>è¯¾ç¨‹åç§°ï¼š</strong>${selection.course.name}</p>
                    <p><strong>è¯¾ç¨‹ç¼–ç ï¼š</strong>${selection.course.courseCode}</p>
                    <p><strong>å¼€è¯¾å­¦é™¢ï¼š</strong>${selection.course.college?.name || 'æœªçŸ¥'}</p>
                    <p><strong>æˆè¯¾æ•™å¸ˆï¼š</strong>${selection.course.teacher?.name || 'æœªåˆ†é…'}</p>
                    <p><strong>å­¦åˆ†ï¼š</strong>${selection.course.credits}</p>
                </div>
                <div class="col-12">
                    <h6>é€‰è¯¾çŠ¶æ€</h6>
                    <p><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${Utils.formatDate(selection.gmtCreate, 'YYYY-MM-DD HH:mm:ss')}</p>
                    <p><strong>é€‰è¯¾çŠ¶æ€ï¼š</strong>
                        ${selection.status === 1 ? '<span class="badge bg-warning">ç”³è¯·ä¸­</span>' : '<span class="badge bg-info">å·²ç¡®å®š</span>'}
                    </p>
                    <p><strong>æŠ½ç­¾ç»“æœï¼š</strong>
                        ${selection.status === 1 ? '<span class="text-muted">å¾…æŠ½ç­¾</span>' :
            (selection.lotteryResult === 1 ? '<span class="badge bg-success">ä¸­ç­¾</span>' : '<span class="badge bg-danger">æœªä¸­ç­¾</span>')}
                    </p>
                </div>
            </div>
        `;

        const modal = Utils.createModal('é€‰è¯¾è¯¦æƒ…', content, [
            { text: 'å…³é—­', class: 'btn-secondary', onclick: 'Utils.closeModal()' }
        ]);
        Utils.showModal(modal);
    }

    // åˆ é™¤é€‰è¯¾è®°å½•
    function deleteSelection(selectionId) {
        const selection = allSelections.find(s => s.id === selectionId);
        if (!selection) return;

        Utils.confirm(
            `ç¡®å®šè¦åˆ é™¤å­¦ç”Ÿ"${selection.student.name}"å¯¹è¯¾ç¨‹"${selection.course.name}"çš„é€‰è¯¾è®°å½•å—ï¼Ÿ`,
            async () => {
                try {
                    const response = await API.CourseSelection.delete(selectionId);
                    if (response.code === 200) {
                        Utils.showMessage('é€‰è¯¾è®°å½•åˆ é™¤æˆåŠŸ', 'success');
                        await loadAllSelections();
                        renderSelectionTable();
                        updateStatistics();
                        calculateCourseStats();
                        renderChart();
                    } else {
                        Utils.showMessage('åˆ é™¤å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Delete selection error:', error);
                    Utils.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
                }
            }
        );
    }

    // æ‰¹é‡åˆ é™¤
    function batchDelete() {
        const selectedCheckboxes = document.querySelectorAll('.selection-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            Utils.showMessage('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'warning');
            return;
        }

        const ids = Array.from(selectedCheckboxes).map(cb => cb.value);
        Utils.confirm(
            `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡é€‰è¯¾è®°å½•å—ï¼Ÿ`,
            async () => {
                try {
                    const response = await API.CourseSelection.batchDelete(ids);
                    if (response.code === 200) {
                        Utils.showMessage('æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                        await loadAllSelections();
                        renderSelectionTable();
                        updateStatistics();
                        calculateCourseStats();
                        renderChart();
                    } else {
                        Utils.showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + response.message, 'danger');
                    }
                } catch (error) {
                    console.error('Batch delete error:', error);
                    Utils.showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
                }
            }
        );
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
        if (filteredSelections.length === 0) {
            Utils.showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }

        let csvContent = 'å­¦å·,å­¦ç”Ÿå§“å,è¯¾ç¨‹åç§°,è¯¾ç¨‹ç¼–ç ,å¼€è¯¾å­¦é™¢,é€‰è¯¾çŠ¶æ€,æŠ½ç­¾ç»“æœ,ç”³è¯·æ—¶é—´\n';

        filteredSelections.forEach(selection => {
            const status = selection.status === 1 ? 'ç”³è¯·ä¸­' : 'å·²ç¡®å®š';
            const result = selection.status === 1 ? 'å¾…æŠ½ç­¾' :
                (selection.lotteryResult === 1 ? 'ä¸­ç­¾' : 'æœªä¸­ç­¾');

            csvContent += `${selection.student.studentNo},${selection.student.name},${selection.course.name},${selection.course.courseCode},${selection.course.college?.name || ''},${status},${result},${Utils.formatDate(selection.gmtCreate, 'YYYY-MM-DD HH:mm')}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `é€‰è¯¾è®°å½•_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        Utils.showMessage('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // å¯¼å‡ºå›¾è¡¨
    function exportChart() {
        const canvas = document.getElementById('courseSelectionChart');
        const link = document.createElement('a');
        link.download = `è¯¾ç¨‹é€‰è¯¾ç»Ÿè®¡å›¾_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.png`;
        link.href = canvas.toDataURL();
        link.click();

        Utils.showMessage('å›¾è¡¨å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.viewSelectionDetail = viewSelectionDetail;
    window.deleteSelection = deleteSelection;
</script>
</body>
</html>