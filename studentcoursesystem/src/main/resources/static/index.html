<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生选课系统 - 登录</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/login.css">
</head>
<body>
<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <div class="system-logo">🎓</div>
            <h1 class="system-title">学生选课系统</h1>
            <p class="system-subtitle">Student Course Selection System</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username">用户名</label>
                <div class="input-with-icon">
                    <span class="input-icon">👤</span>
                    <input type="text"
                           id="username"
                           name="username"
                           class="form-control"
                           placeholder="请输入用户名"
                           required
                           autocomplete="username">
                </div>
            </div>

            <div class="form-group">
                <label for="password">密码</label>
                <div class="input-with-icon">
                    <span class="input-icon">🔒</span>
                    <input type="password"
                           id="password"
                           name="password"
                           class="form-control"
                           placeholder="请输入密码"
                           required
                           autocomplete="current-password">
                </div>
            </div>

            <div class="form-options">
                <label class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    记住密码
                </label>
                <a href="#" class="forgot-password">忘记密码？</a>
            </div>

            <button type="submit" class="login-btn" id="loginBtn">
                <span class="spinner"></span>
                <span class="btn-text">登录</span>
            </button>
        </form>

        <div class="role-info">
            <h4>系统角色说明</h4>
            <ul class="role-list">
                <li><strong>系统管理员:</strong> sysadmin</li>
                <li><strong>学院管理员:</strong> cs_admin / ee_admin</li>
                <li><strong>教师:</strong> teacher_wang / teacher_li / teacher_zhang</li>
                <li><strong>学生:</strong> 2021001 / 2021002 / 2021003 / 2021004</li>
            </ul>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                所有账号的默认密码：<strong>123456</strong>
            </p>
        </div>

        <div class="copyright">
            <p>&copy; 2025 学生选课系统. All rights reserved.</p>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const errorMessage = document.getElementById('errorMessage');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const rememberMe = document.getElementById('rememberMe');

        // 从本地存储加载记住的用户名
        const savedUsername = StorageUtils.getLocal('rememberedUsername');
        if (savedUsername) {
            usernameInput.value = savedUsername;
            rememberMe.checked = true;
            passwordInput.focus();
        } else {
            usernameInput.focus();
        }

        // 隐藏错误消息
        function hideError() {
            errorMessage.classList.remove('show');
        }

        // 显示错误消息
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }

        // 设置登录按钮状态
        function setLoginButtonState(loading) {
            if (loading) {
                loginBtn.classList.add('loading');
                loginBtn.disabled = true;
            } else {
                loginBtn.classList.remove('loading');
                loginBtn.disabled = false;
            }
        }

        // 表单提交处理
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showError('请填写完整的登录信息');
                return;
            }

            setLoginButtonState(true);

            try {
                const result = await AuthManager.login(username, password);

                if (result.success) {
                    // 记住用户名
                    if (rememberMe.checked) {
                        StorageUtils.setLocal('rememberedUsername', username);
                    } else {
                        StorageUtils.removeLocal('rememberedUsername');
                    }

                    Utils.showMessage('登录成功，正在跳转...', 'success');

                    // 延迟跳转以显示成功消息
                    setTimeout(() => {
                        window.location.href = '/main.html';
                    }, 1000);
                } else {
                    showError(result.message || '登录失败');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('登录失败，请检查网络连接');
            } finally {
                setLoginButtonState(false);
            }
        });

        // 输入框变化时隐藏错误
        usernameInput.addEventListener('input', hideError);
        passwordInput.addEventListener('input', hideError);

        // 回车键快捷登录
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                passwordInput.focus();
            }
        });

        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });

        // 忘记密码功能
        document.querySelector('.forgot-password').addEventListener('click', function(e) {
            e.preventDefault();
            Utils.showMessage('请联系系统管理员重置密码', 'info');
        });
    });
</script>
</body>
</html>