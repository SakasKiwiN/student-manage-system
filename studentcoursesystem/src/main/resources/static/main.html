<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ - ä¸»é¡µ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="main-layout">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/main.html" class="logo">
                <div class="logo-icon">ğŸ“</div>
                <span class="logo-text">é€‰è¯¾ç³»ç»Ÿ</span>
            </a>
        </div>

        <div class="user-info">
            <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
            <div class="user-name" id="userName">ç”¨æˆ·å</div>
            <div class="user-role" id="userRole">è§’è‰²</div>
        </div>

        <nav class="nav-menu" id="navMenu">
            <!-- åŠ¨æ€ç”Ÿæˆèœå• -->
        </nav>
    </aside>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
                <nav class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item">ä¸»é¡µ</span>
                </nav>
            </div>

            <div class="navbar-right">
                <button class="notification-bell" id="notificationBell">
                    ğŸ””
                    <span class="notification-badge d-none" id="notificationBadge">0</span>
                </button>

                <div class="user-dropdown" id="userDropdown">
                    <button class="user-dropdown-toggle" id="userDropdownToggle">
                        <div class="user-dropdown-avatar" id="topUserAvatar">ğŸ‘¤</div>
                        <span class="user-dropdown-name" id="topUserName">ç”¨æˆ·å</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="user-dropdown-menu" id="userDropdownMenu">
                        <a href="/pages/common/profile.html" class="dropdown-item">ä¸ªäººä¿¡æ¯</a>
                        <a href="/pages/common/change-password.html" class="dropdown-item">ä¿®æ”¹å¯†ç </a>
                        <a href="/pages/common/messages.html" class="dropdown-item">æ¶ˆæ¯ä¸­å¿ƒ</a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="logoutBtn">é€€å‡ºç™»å½•</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <div class="page-header">
                <h1 class="page-title" id="pageTitle">æ¬¢è¿ä½¿ç”¨å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</h1>
                <p class="page-description" id="pageDescription">è¯·ä»å·¦ä¾§èœå•é€‰æ‹©åŠŸèƒ½</p>
            </div>

            <!-- å¿«æ·æ“ä½œ -->
            <div class="quick-actions" id="quickActions">
                <!-- åŠ¨æ€ç”Ÿæˆå¿«æ·æ“ä½œ -->
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid" id="statsGrid">
                <!-- åŠ¨æ€ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯ -->
            </div>
        </div>
    </main>
</div>

<!-- ä¾§è¾¹æ é®ç½©å±‚ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- JavaScript -->
<script src="/js/common.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script>
    // é¡µé¢çŠ¶æ€
    let currentUser = null;
    let isMobile = window.innerWidth <= 768;

    // èœå•é…ç½®
    const MenuConfig = {
        getMenusByRole(role) {
            const menuConfigs = {
                [AuthManager.ROLES.SYS_ADMIN]: [
                    {
                        title: 'ç³»ç»Ÿç®¡ç†',
                        icon: 'âš™ï¸',
                        children: [
                            { title: 'å­¦é™¢ç®¡ç†', url: '/pages/admin/college-manage.html' },
                            { title: 'æ•™å¸ˆç®¡ç†', url: '/pages/admin/teacher-manage.html' },
                            { title: 'å­¦ç”Ÿç®¡ç†', url: '/pages/admin/student-manage.html' },
                            { title: 'è¯¾ç¨‹ç®¡ç†', url: '/pages/admin/course-manage.html' },
                            { title: 'é€‰è¯¾ç®¡ç†', url: '/pages/admin/selection-manage.html' }, // æ–°å¢
                            { title: 'æˆç»©ç®¡ç†', url: '/pages/admin/score-manage.html' },     // æ–°å¢
                            { title: 'ç³»ç»Ÿç»Ÿè®¡', url: '/pages/admin/statistics.html' }
                        ]
                    },
                    {
                        title: 'ä¸ªäººä¸­å¿ƒ',
                        icon: 'ğŸ‘¤',
                        children: [
                            { title: 'ä¸ªäººä¿¡æ¯', url: '/pages/common/profile.html' },
                            { title: 'ä¿®æ”¹å¯†ç ', url: '/pages/common/change-password.html' },
                            { title: 'æ¶ˆæ¯ä¸­å¿ƒ', url: '/pages/common/messages.html' }
                        ]
                    }
                ],
                [AuthManager.ROLES.COLLEGE_ADMIN]: [
                    {
                        title: 'å­¦é™¢ç®¡ç†',
                        icon: 'ğŸ«',
                        children: [
                            { title: 'è¯¾ç¨‹ç®¡ç†', url: '/pages/college/course-manage.html' },
                            { title: 'å­¦ç”Ÿåˆ—è¡¨', url: '/pages/college/student-list.html' },
                            { title: 'æŠ½ç­¾ç®¡ç†', url: '/pages/college/lottery.html' }
                        ]
                    },
                    {
                        title: 'ä¸ªäººä¸­å¿ƒ',
                        icon: 'ğŸ‘¤',
                        children: [
                            { title: 'ä¸ªäººä¿¡æ¯', url: '/pages/common/profile.html' },
                            { title: 'ä¿®æ”¹å¯†ç ', url: '/pages/common/change-password.html' },
                            { title: 'æ¶ˆæ¯ä¸­å¿ƒ', url: '/pages/common/messages.html' }
                        ]
                    }
                ],
                [AuthManager.ROLES.TEACHER]: [
                    {
                        title: 'æ•™å­¦ç®¡ç†',
                        icon: 'ğŸ“š',
                        children: [
                            { title: 'æˆ‘çš„è¯¾ç¨‹', url: '/pages/teacher/course-list.html' },
                            { title: 'æˆç»©å½•å…¥', url: '/pages/teacher/score-input.html' },
                            { title: 'è¯¾ä»¶ç®¡ç†', url: '/pages/teacher/courseware.html' },
                            { title: 'å­¦ç”Ÿç®¡ç†', url: '/pages/teacher/student-list.html' }
                        ]
                    },
                    {
                        title: 'ä¸ªäººä¸­å¿ƒ',
                        icon: 'ğŸ‘¤',
                        children: [
                            { title: 'ä¸ªäººä¿¡æ¯', url: '/pages/common/profile.html' },
                            { title: 'ä¿®æ”¹å¯†ç ', url: '/pages/common/change-password.html' },
                            { title: 'æ¶ˆæ¯ä¸­å¿ƒ', url: '/pages/common/messages.html' }
                        ]
                    }
                ],
                [AuthManager.ROLES.STUDENT]: [
                    {
                        title: 'é€‰è¯¾ä¸­å¿ƒ',
                        icon: 'ğŸ¯',
                        children: [
                            { title: 'è¯¾ç¨‹é€‰æ‹©', url: '/pages/student/course-select.html' },
                            { title: 'æˆ‘çš„è¯¾ç¨‹', url: '/pages/student/my-courses.html' },
                            { title: 'æˆç»©æŸ¥è¯¢', url: '/pages/student/scores.html' },
                            { title: 'è¯¾ä»¶ä¸‹è½½', url: '/pages/student/courseware.html' }
                        ]
                    },
                    {
                        title: 'ä¸ªäººä¸­å¿ƒ',
                        icon: 'ğŸ‘¤',
                        children: [
                            { title: 'ä¸ªäººä¿¡æ¯', url: '/pages/common/profile.html' },
                            { title: 'ä¿®æ”¹å¯†ç ', url: '/pages/common/change-password.html' },
                            { title: 'æ¶ˆæ¯ä¸­å¿ƒ', url: '/pages/common/messages.html' }
                        ]
                    }
                ]
            };

            return menuConfigs[role] || [];
        }
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
        await initializePage();
    });

    // ç›‘å¬ç”¨æˆ·è®¤è¯äº‹ä»¶
    window.addEventListener('userAuthenticated', function(event) {
        currentUser = event.detail.user;
        initializeUI();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        // æ£€æŸ¥è®¤è¯çŠ¶æ€ï¼ˆå·²åœ¨auth.jsä¸­å¤„ç†ï¼‰
        const user = AuthManager.getCurrentUser();
        if (user) {
            currentUser = user;
            initializeUI();
        }
    }

    // åˆå§‹åŒ–UI
    function initializeUI() {
        updateUserInfo();
        generateMenu();
        generateQuickActions();
        generateStats();
        bindEvents();
        loadNotificationCount();
        updatePageInfo();
    }

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    function updateUserInfo() {
        if (!currentUser) return;

        const userName = currentUser.student?.name ||
            currentUser.teacher?.name ||
            currentUser.username;
        const roleDisplay = AuthManager.getRoleDisplayName();
        const avatar = userName.charAt(0).toUpperCase();

        document.getElementById('userName').textContent = userName;
        document.getElementById('userRole').textContent = roleDisplay;
        document.getElementById('userAvatar').textContent = avatar;
        document.getElementById('topUserName').textContent = userName;
        document.getElementById('topUserAvatar').textContent = avatar;
    }

    // ç”Ÿæˆèœå•
    function generateMenu() {
        const primaryRole = AuthManager.getPrimaryRole();
        const menus = MenuConfig.getMenusByRole(primaryRole);
        const navMenu = document.getElementById('navMenu');

        navMenu.innerHTML = '';

        menus.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'nav-group';

            const groupTitle = document.createElement('div');
            groupTitle.className = 'nav-group-title';
            groupTitle.innerHTML = `<span class="nav-icon">${group.icon}</span> ${group.title}`;
            groupDiv.appendChild(groupTitle);

            group.children.forEach(item => {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';

                const navLink = document.createElement('a');
                navLink.className = 'nav-link';
                navLink.href = item.url;
                navLink.innerHTML = `<span class="nav-text">${item.title}</span>`;

                // æ£€æŸ¥å½“å‰é¡µé¢
                if (window.location.pathname === item.url) {
                    navLink.classList.add('active');
                }

                navItem.appendChild(navLink);
                groupDiv.appendChild(navItem);
            });

            navMenu.appendChild(groupDiv);
        });
    }

    // ç”Ÿæˆå¿«æ·æ“ä½œ
    function generateQuickActions() {
        const primaryRole = AuthManager.getPrimaryRole();
        const quickActions = document.getElementById('quickActions');

        const actionConfigs = {
            [AuthManager.ROLES.SYS_ADMIN]: [
                { title: 'å­¦é™¢ç®¡ç†', description: 'ç®¡ç†ç³»ç»Ÿå­¦é™¢ä¿¡æ¯', icon: 'ğŸ«', color: '#3498db', url: '/pages/admin/college-manage.html' },
                { title: 'æ•™å¸ˆç®¡ç†', description: 'ç®¡ç†æ•™å¸ˆè´¦å·ä¿¡æ¯', icon: 'ğŸ‘¨â€ğŸ«', color: '#e74c3c', url: '/pages/admin/teacher-manage.html' },
                { title: 'å­¦ç”Ÿç®¡ç†', description: 'ç®¡ç†å­¦ç”Ÿè´¦å·ä¿¡æ¯', icon: 'ğŸ‘¨â€ğŸ“', color: '#f39c12', url: '/pages/admin/student-manage.html' },
                { title: 'è¯¾ç¨‹ç®¡ç†', description: 'ç®¡ç†ç³»ç»Ÿæ‰€æœ‰è¯¾ç¨‹', icon: 'ğŸ“š', color: '#27ae60', url: '/pages/admin/course-manage.html' },
                { title: 'ç³»ç»Ÿç»Ÿè®¡', description: 'æŸ¥çœ‹ç³»ç»Ÿä½¿ç”¨ç»Ÿè®¡', icon: 'ğŸ“Š', color: '#9b59b6', url: '/pages/admin/statistics.html' },
                { title: 'æ¶ˆæ¯ä¸­å¿ƒ', description: 'æŸ¥çœ‹ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥', icon: 'ğŸ’¬', color: '#34495e', url: '/pages/common/messages.html' }
            ],
            [AuthManager.ROLES.COLLEGE_ADMIN]: [
                { title: 'è¯¾ç¨‹ç®¡ç†', description: 'ç®¡ç†å­¦é™¢è¯¾ç¨‹ä¿¡æ¯', icon: 'ğŸ“š', color: '#3498db', url: '/pages/college/course-manage.html' },
                { title: 'å­¦ç”Ÿåˆ—è¡¨', description: 'æŸ¥çœ‹å­¦é™¢å­¦ç”Ÿä¿¡æ¯', icon: 'ğŸ‘¥', color: '#e74c3c', url: '/pages/college/student-list.html' },
                { title: 'æŠ½ç­¾ç®¡ç†', description: 'æ‰§è¡Œé€‰è¯¾æŠ½ç­¾æ“ä½œ', icon: 'ğŸ²', color: '#f39c12', url: '/pages/college/lottery.html' },
                { title: 'ç»Ÿè®¡æŠ¥è¡¨', description: 'æŸ¥çœ‹é€‰è¯¾ç»Ÿè®¡æŠ¥è¡¨', icon: 'ğŸ“ˆ', color: '#27ae60', url: '#' },
                { title: 'æ¶ˆæ¯ä¸­å¿ƒ', description: 'æŸ¥çœ‹å­¦é™¢æ¶ˆæ¯é€šçŸ¥', icon: 'ğŸ’¬', color: '#9b59b6', url: '/pages/common/messages.html' },
                { title: 'ä¸ªäººä¿¡æ¯', description: 'ç®¡ç†ä¸ªäººèµ„æ–™ä¿¡æ¯', icon: 'ğŸ‘¤', color: '#34495e', url: '/pages/common/profile.html' }
            ],
            [AuthManager.ROLES.TEACHER]: [
                { title: 'æˆ‘çš„è¯¾ç¨‹', description: 'æŸ¥çœ‹æˆè¯¾è¯¾ç¨‹åˆ—è¡¨', icon: 'ğŸ“–', color: '#3498db', url: '/pages/teacher/course-list.html' },
                { title: 'æˆç»©å½•å…¥', description: 'å½•å…¥å­¦ç”Ÿè¯¾ç¨‹æˆç»©', icon: 'ğŸ“', color: '#e74c3c', url: '/pages/teacher/score-input.html' },
                { title: 'è¯¾ä»¶ç®¡ç†', description: 'ä¸Šä¼ ç®¡ç†è¯¾ç¨‹èµ„æ–™', icon: 'ğŸ“', color: '#f39c12', url: '/pages/teacher/courseware.html' },
                { title: 'å­¦ç”Ÿç®¡ç†', description: 'æŸ¥çœ‹é€‰è¯¾å­¦ç”Ÿä¿¡æ¯', icon: 'ğŸ‘¨â€ğŸ“', color: '#27ae60', url: '/pages/teacher/student-list.html' },
                { title: 'æ¶ˆæ¯ä¸­å¿ƒ', description: 'æŸ¥çœ‹æ•™å­¦æ¶ˆæ¯é€šçŸ¥', icon: 'ğŸ’¬', color: '#9b59b6', url: '/pages/common/messages.html' },
                { title: 'ä¸ªäººä¿¡æ¯', description: 'ç®¡ç†ä¸ªäººèµ„æ–™ä¿¡æ¯', icon: 'ğŸ‘¤', color: '#34495e', url: '/pages/common/profile.html' }
            ],
            [AuthManager.ROLES.STUDENT]: [
                { title: 'è¯¾ç¨‹é€‰æ‹©', description: 'æµè§ˆå¹¶é€‰æ‹©æ„Ÿå…´è¶£çš„è¯¾ç¨‹', icon: 'ğŸ¯', color: '#3498db', url: '/pages/student/course-select.html' },
                { title: 'æˆ‘çš„è¯¾ç¨‹', description: 'æŸ¥çœ‹å·²é€‰è¯¾ç¨‹çŠ¶æ€', icon: 'ğŸ“‹', color: '#e74c3c', url: '/pages/student/my-courses.html' },
                { title: 'æˆç»©æŸ¥è¯¢', description: 'æŸ¥çœ‹ä¸ªäººè¯¾ç¨‹æˆç»©', icon: 'ğŸ“Š', color: '#f39c12', url: '/pages/student/scores.html' },
                { title: 'è¯¾ä»¶ä¸‹è½½', description: 'ä¸‹è½½è¯¾ç¨‹å­¦ä¹ èµ„æ–™', icon: 'â¬‡ï¸', color: '#27ae60', url: '/pages/student/courseware.html' },
                { title: 'æ¶ˆæ¯ä¸­å¿ƒ', description: 'æŸ¥çœ‹å­¦ä¹ æ¶ˆæ¯é€šçŸ¥', icon: 'ğŸ’¬', color: '#9b59b6', url: '/pages/common/messages.html' },
                { title: 'ä¸ªäººä¿¡æ¯', description: 'ç®¡ç†ä¸ªäººèµ„æ–™ä¿¡æ¯', icon: 'ğŸ‘¤', color: '#34495e', url: '/pages/common/profile.html' }
            ]
        };

        const actions = actionConfigs[primaryRole] || [];
        quickActions.innerHTML = '';

        actions.forEach(action => {
            const actionCard = document.createElement('a');
            actionCard.className = 'action-card';
            actionCard.href = action.url;
            actionCard.innerHTML = `
                <div class="action-icon" style="background: ${action.color}; color: white;">
                    ${action.icon}
                </div>
                <div class="action-title">${action.title}</div>
                <div class="action-description">${action.description}</div>
            `;
            quickActions.appendChild(actionCard);
        });
    }

    // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
    async function generateStats() {
        const primaryRole = AuthManager.getPrimaryRole();
        const statsGrid = document.getElementById('statsGrid');

        try {
            let stats = [];

            if (primaryRole === AuthManager.ROLES.SYS_ADMIN) {
                stats = [
                    { label: 'å­¦é™¢æ•°é‡', value: '-', icon: 'ğŸ«', color: '#3498db' },
                    { label: 'æ•™å¸ˆæ€»æ•°', value: '-', icon: 'ğŸ‘¨â€ğŸ«', color: '#e74c3c' },
                    { label: 'å­¦ç”Ÿæ€»æ•°', value: '-', icon: 'ğŸ‘¨â€ğŸ“', color: '#f39c12' },
                    { label: 'è¯¾ç¨‹æ€»æ•°', value: '-', icon: 'ğŸ“š', color: '#27ae60' }
                ];
            } else if (primaryRole === AuthManager.ROLES.COLLEGE_ADMIN) {
                stats = [
                    { label: 'å­¦é™¢è¯¾ç¨‹', value: '-', icon: 'ğŸ“š', color: '#3498db' },
                    { label: 'å­¦é™¢æ•™å¸ˆ', value: '-', icon: 'ğŸ‘¨â€ğŸ«', color: '#e74c3c' },
                    { label: 'å­¦é™¢å­¦ç”Ÿ', value: '-', icon: 'ğŸ‘¨â€ğŸ“', color: '#f39c12' },
                    { label: 'é€‰è¯¾ç”³è¯·', value: '-', icon: 'ğŸ“', color: '#27ae60' }
                ];
            } else if (primaryRole === AuthManager.ROLES.TEACHER) {
                stats = [
                    { label: 'æˆè¯¾è¯¾ç¨‹', value: '-', icon: 'ğŸ“–', color: '#3498db' },
                    { label: 'é€‰è¯¾å­¦ç”Ÿ', value: '-', icon: 'ğŸ‘¥', color: '#e74c3c' },
                    { label: 'å·²å½•æˆç»©', value: '-', icon: 'ğŸ“Š', color: '#f39c12' },
                    { label: 'è¯¾ä»¶æ•°é‡', value: '-', icon: 'ğŸ“', color: '#27ae60' }
                ];
            } else if (primaryRole === AuthManager.ROLES.STUDENT) {
                stats = [
                    { label: 'å·²é€‰è¯¾ç¨‹', value: '-', icon: 'ğŸ“‹', color: '#3498db' },
                    { label: 'å¾…æŠ½ç­¾', value: '-', icon: 'ğŸ²', color: '#e74c3c' },
                    { label: 'å·²è·å­¦åˆ†', value: '-', icon: 'ğŸ†', color: '#f39c12' },
                    { label: 'å¹³å‡æˆç»©', value: '-', icon: 'ğŸ“ˆ', color: '#27ae60' }
                ];
            }

            statsGrid.innerHTML = '';
            stats.forEach(stat => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-icon" style="background: ${stat.color}; color: white;">
                        ${stat.icon}
                    </div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsGrid.appendChild(statCard);
            });

            // å¼‚æ­¥åŠ è½½çœŸå®æ•°æ®
            loadRealStats(primaryRole);
        } catch (error) {
            console.warn('Failed to load stats:', error);
        }
    }

    // åŠ è½½çœŸå®ç»Ÿè®¡æ•°æ®
    async function loadRealStats(role) {
        try {
            if (role === AuthManager.ROLES.SYS_ADMIN) {
                // åŠ è½½ç³»ç»Ÿçº§ç»Ÿè®¡
                const [collegeResponse, teacherResponse, studentResponse, courseResponse] = await Promise.all([
                    API.College.getAll(),
                    API.Teacher.getAll(),
                    API.Student.getAll(),
                    API.Course.getAll()
                ]);

                const statCards = document.querySelectorAll('.stat-value');
                if (collegeResponse.code === 200 && statCards[0]) {
                    statCards[0].textContent = collegeResponse.data.length;
                }
                if (teacherResponse.code === 200 && statCards[1]) {
                    statCards[1].textContent = teacherResponse.data.length;
                }
                if (studentResponse.code === 200 && statCards[2]) {
                    statCards[2].textContent = studentResponse.data.length;
                }
                if (courseResponse.code === 200 && statCards[3]) {
                    statCards[3].textContent = courseResponse.data.length;
                }
            } else if (role === AuthManager.ROLES.COLLEGE_ADMIN) {
                // åŠ è½½å­¦é™¢çº§ç»Ÿè®¡
                const collegeId = AuthManager.getUserCollegeId();
                if (collegeId) {
                    const [courseResponse, teacherResponse, studentResponse] = await Promise.all([
                        API.Course.getByCollege(collegeId),
                        API.Teacher.getByCollege(collegeId),
                        API.Student.getByCollege(collegeId)
                    ]);

                    const statCards = document.querySelectorAll('.stat-value');
                    if (courseResponse.code === 200 && statCards[0]) {
                        statCards[0].textContent = courseResponse.data.length;
                    }
                    if (teacherResponse.code === 200 && statCards[1]) {
                        statCards[1].textContent = teacherResponse.data.length;
                    }
                    if (studentResponse.code === 200 && statCards[2]) {
                        statCards[2].textContent = studentResponse.data.length;
                    }
                }
            } else if (role === AuthManager.ROLES.TEACHER) {
                // åŠ è½½æ•™å¸ˆç»Ÿè®¡
                const teacherResponse = await API.Teacher.getCurrent();
                if (teacherResponse.code === 200) {
                    const courseResponse = await API.Course.getByTeacher(teacherResponse.data.id);
                    const statCards = document.querySelectorAll('.stat-value');
                    if (courseResponse.code === 200 && statCards[0]) {
                        statCards[0].textContent = courseResponse.data.length;
                    }
                }
            } else if (role === AuthManager.ROLES.STUDENT) {
                // åŠ è½½å­¦ç”Ÿç»Ÿè®¡
                const response = await API.CourseSelection.getMySelections();
                if (response.code === 200) {
                    const selections = response.data;
                    const statCards = document.querySelectorAll('.stat-value');

                    if (statCards[0]) statCards[0].textContent = selections.length;
                    if (statCards[1]) {
                        const pending = selections.filter(s => s.status === 1).length;
                        statCards[1].textContent = pending;
                    }
                    if (statCards[2]) {
                        const selected = selections.filter(s => s.status === 2 && s.lotteryResult === 1);
                        const totalCredits = selected.reduce((sum, s) => sum + (s.course?.credits || 0), 0);
                        statCards[2].textContent = totalCredits;
                    }
                }
            }
        } catch (error) {
            console.warn('Failed to load real stats:', error);
        }
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // ä¾§è¾¹æ åˆ‡æ¢
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        sidebarToggle.addEventListener('click', function() {
            if (isMobile) {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');
        });

        // ç”¨æˆ·ä¸‹æ‹‰èœå•
        const userDropdown = document.getElementById('userDropdown');
        const userDropdownToggle = document.getElementById('userDropdownToggle');

        userDropdownToggle.addEventListener('click', function(e) {
            e.preventDefault();
            userDropdown.classList.toggle('open');
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(e) {
            if (!userDropdown.contains(e.target)) {
                userDropdown.classList.remove('open');
            }
        });

        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            Utils.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', async () => {
                await AuthManager.logout();
            });
        });

        // é€šçŸ¥é“ƒé“›
        document.getElementById('notificationBell').addEventListener('click', function() {
            window.location.href = '/pages/common/messages.html';
        });

        // å“åº”å¼å¤„ç†
        window.addEventListener('resize', function() {
            const newIsMobile = window.innerWidth <= 768;
            if (newIsMobile !== isMobile) {
                isMobile = newIsMobile;
                sidebar.classList.remove('open', 'collapsed');
                sidebarOverlay.classList.remove('show');
            }
        });
    }

    // åŠ è½½é€šçŸ¥æ•°é‡
    async function loadNotificationCount() {
        try {
            const response = await API.Message.getUnreadCount();
            if (response.code === 200 && response.data > 0) {
                const badge = document.getElementById('notificationBadge');
                badge.textContent = response.data;
                badge.classList.remove('d-none');
            }
        } catch (error) {
            console.warn('Failed to load notification count:', error);
        }
    }

    // æ›´æ–°é¡µé¢ä¿¡æ¯
    function updatePageInfo() {
        const primaryRole = AuthManager.getPrimaryRole();
        const roleNames = {
            [AuthManager.ROLES.SYS_ADMIN]: 'ç³»ç»Ÿç®¡ç†å‘˜',
            [AuthManager.ROLES.COLLEGE_ADMIN]: 'å­¦é™¢ç®¡ç†å‘˜',
            [AuthManager.ROLES.TEACHER]: 'æ•™å¸ˆ',
            [AuthManager.ROLES.STUDENT]: 'å­¦ç”Ÿ'
        };

        const userName = currentUser.student?.name ||
            currentUser.teacher?.name ||
            currentUser.username;

        document.getElementById('pageTitle').textContent = `æ¬¢è¿æ‚¨ï¼Œ${userName}`;
        document.getElementById('pageDescription').textContent = `æ‚¨å½“å‰çš„èº«ä»½æ˜¯ï¼š${roleNames[primaryRole]}`;
    }
</script>
</body>
</html>